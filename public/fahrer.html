<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - Thirr Taxi</title>

  <!-- iOS FULLSCREEN / MOBILE -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js")
        .catch(console.error);
    }
  </script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #020617;
      font-family: -apple-system, system-ui, sans-serif;
      color: #e5e7eb;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #0b1120, #020617 70%);
      z-index: -1;
    }

    body {
      padding: 16px 12px 60px;
    }

    .frame {
      max-width: 500px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 14px;
    }

    .header-left {
      font-size: 16px;
      font-weight: 600;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .header-status {
      font-size: 12px;
      opacity: .7;
    }

    /* NEUE SCHÖNE TABS */
    .tabs {
      display: flex;
      gap: 8px;
      padding: 8px;
      margin-bottom: 18px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(18px);
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: rgba(255,255,255,0.04);
      color: #94a3b8;
      font-size: 14px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .tab-btn:hover {
      background: rgba(255,255,255,0.10);
      color: #e2e8f0;
    }

    .tab-btn.active {
      background: rgba(255,255,255,0.22);
      color: #ffffff;
    }

    /* CARD BASE */
    .card {
      background: rgba(15,23,42,0.70);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,0.22);
      padding: 16px 18px;
      margin-bottom: 18px;
      backdrop-filter: blur(18px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.24);
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
    }

    .section-sub {
      font-size: 12px;
      opacity: .7;
      margin-bottom: 10px;
    }

    /* LOGIN */
    label {
      font-size: 13px;
      margin-top: 4px;
      display: block;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      border-radius: 14px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.35);
      color: #e5e7eb;
      font-size: 15px;
      outline: none;
    }

    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }

    button {
      width: 100%;
      border: none;
      border-radius: 12px;
      padding: 11px;
      font-size: 15px;
      font-weight: 600;
      margin-top: 10px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.28);
    }

    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
    }

    .btn-secondary {
      background: linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#022c22;
      font-size: 14px;
    }

    .btn-danger {
      background:#ef4444;
      color:white;
      font-size: 13px;
    }

    .login-error {
      font-size: 12px;
      color: #f97373;
      margin-top: 6px;
    }

    /* STATS */
    .stat-main {
      text-align: center;
      padding: 8px 0;
    }

    .stat-number {
      font-size: 34px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 13px;
      opacity: .6;
    }

    /* ORDERS */
    .order-card {
      background: rgba(30,41,59,0.75);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.18);
      padding: 14px 14px 16px;
      margin-bottom: 12px;
      backdrop-filter: blur(14px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.32);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .order-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .order-name {
      font-size: 15px;
      font-weight: 600;
    }

    .order-phone {
      font-size: 13px;
      opacity: .9;
    }

    .order-address {
      font-size: 12px;
      color: #cbd5f5;
      margin-top: 2px;
      line-height: 1.3;
      word-break: break-word;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      white-space: nowrap;
    }

    .badge-open {
      background: rgba(251,191,36,0.15);
      color: #facc15;
    }

    .badge-active {
      background: rgba(34,197,94,0.18);
      color: #4ade80;
    }

    .mini-map {
      width: 100%;
      height: 130px;
      border-radius: 14px;
      margin: 10px 0;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(15,23,42,0.9);
    }

    /* BILANCI */
    .balance-summary {
      font-size: 15px;
      margin-bottom: 4px;
      text-align: center;
    }

    .balance-meta {
      font-size: 11px;
      opacity: .7;
      margin-bottom: 10px;
      text-align: center;
    }

    .balance-row {
      background: rgba(30,41,59,0.70);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.22);
      padding: 10px 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

  </style>
</head>

<body>
<div class="frame">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">Thirr Taxi</div>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <span id="headerStatus" class="header-status">Offline</span>
  </div>

  <!-- LOGIN CARD -->
  <div id="loginCard" class="card">
    <div class="section-title">Hyr si shofer</div>
    <div class="section-sub">
      Shkruaj vetëm PIN-in që ta ka dhënë administratori. Emri dhe kompania merren automatikisht.
    </div>

    <label>PIN</label>
    <input id="loginPin" inputmode="numeric" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" class="login-error"></div>
  </div>

  <!-- CONTENT -->
  <div id="content" style="display:none;">

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-requests">Kërkesa</button>
      <button class="tab-btn" data-tab="tab-active">Udhëtimet e mia</button>
      <button class="tab-btn" data-tab="tab-balance">Bilanci</button>
    </div>

    <!-- STATS -->
    <div class="card">
      <div class="section-title">Performanca ime</div>
      <div class="section-sub">Sa udhëtime ke përfunduar sot si shofer.</div>
      <div class="stat-main">
        <div id="statRidesCount" class="stat-number">0</div>
        <div class="stat-label">Sot</div>
      </div>
    </div>

    <!-- TAB: KËRKESA -->
    <div id="tab-requests" class="tab-panel" style="display:block;">
      <div class="card">
        <div class="section-title">Kërkesa të reja</div>
        <div class="section-sub">Këto janë udhëtimet që mund t’i pranosh.</div>

        <div id="orders"></div>
        <div id="noOpen" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: AKTIVE -->
    <div id="tab-active" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Udhëtimet e mia aktive</div>
        <div class="section-sub">Mund të kesh vetëm një udhëtim aktiv në të njëjtën kohë.</div>

        <div id="myOrders"></div>
        <div id="noMine" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: BILANCI -->
    <div id="tab-balance" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Bilanci im</div>
        <div class="section-sub">Lëvizjet e fundit dhe shuma e mbetur.</div>

        <div id="balanceSummary" class="balance-summary"></div>
        <div id="balanceMeta" class="balance-meta"></div>

        <div id="balanceHistoryList"></div>
        <div id="balanceHistoryEmpty" class="balance-empty"></div>
      </div>
    </div>

  </div><!-- /content -->

</div><!-- /frame -->

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const LS_KEY = "thirrTaxiDriverId";

  let currentDriver = null;
  let maps = {};
  let hasActiveRide = false;

  /* DOM */
  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");

  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus     = document.getElementById("headerStatus");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels  = document.querySelectorAll(".tab-panel");

  const ordersBox = document.getElementById("orders");
  const myOrdersBox = document.getElementById("myOrders");
  const noOpen = document.getElementById("noOpen");
  const noMine = document.getElementById("noMine");

  const statRidesCount = document.getElementById("statRidesCount");

  const balanceSummary = document.getElementById("balanceSummary");
  const balanceMeta = document.getElementById("balanceMeta");
  const balanceHistoryList = document.getElementById("balanceHistoryList");
  const balanceHistoryEmpty = document.getElementById("balanceHistoryEmpty");

  /* ----------------------------------------- */
  /* Helper */
  /* ----------------------------------------- */

  function cleanAddress(a) {
    if (!a) return "";
    const l = a.toLowerCase();
    if (l.includes("nuk") && l.includes("përcaktuar")) return "";
    return a;
  }

  function shortAddr(a, max = 40) {
    if (!a) return "";
    a = a.trim();
    return a.length <= max ? a : a.substring(0, max) + "...";
  }

  function minsSince(t) {
    if (!t) return "-";
    const mins = Math.floor((Date.now() - t) / 60000);
    if (mins <= 0) return "më pak se 1 min";
    return mins + " min";
  }

  function resetMaps() {
    Object.entries(maps).forEach(([id, map]) => {
      try { map.remove(); } catch {}
      delete maps[id];
    });
  }

  function createMiniMap(id, lat, lng) {
    const el = document.getElementById(id);
    if (!el) return;

    const map = L.map(id, {
      zoomControl: false,
      attributionControl: false,
      preferCanvas: true
    }).setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      keepBuffer: 2
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);

    maps[id] = map;

    setTimeout(() => map.invalidateSize(), 200);
  }

  /* ----------------------------------------- */
  /* Tabs */
  /* ----------------------------------------- */

  tabButtons.forEach(btn => {
    btn.onclick = () => {
      const t = btn.dataset.tab;

      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      tabPanels.forEach(p => p.style.display = p.id === t ? "block" : "none");

      setTimeout(() => {
        Object.values(maps).forEach(m => { try { m.invalidateSize(); } catch {} });
      }, 200);
    };
  });

  /* ----------------------------------------- */
  /* Login */
  /* ----------------------------------------- */

  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Shkruaj PIN-in.";
      return;
    }

    onValue(ref(db, "drivers"), snap => {
      const data = snap.val() || {};
      let found = null;

      Object.entries(data).forEach(([id, d]) => {
        if (String(d.pin) === pin && d.approved && d.active !== false) {
          found = { id, ...d };
        }
      });

      if (!found) {
        loginMsg.textContent = "PIN i gabuar ose shofer jo aktiv.";
        return;
      }

      currentDriver = found;
      localStorage.setItem(LS_KEY, found.id);
      startApp();
    }, { onlyOnce: true });
  };

  const saved = localStorage.getItem(LS_KEY);
  if (saved) {
    onValue(ref(db, "drivers/" + saved), snap => {
      const d = snap.val();
      if (d && d.approved && d.active !== false) {
        currentDriver = { id: saved, ...d };
        startApp();
      } else {
        localStorage.removeItem(LS_KEY);
      }
    }, { onlyOnce: true });
  }

  function startApp() {
    loginCard.style.display = "none";
    content.style.display = "block";
    headerDriverName.textContent = currentDriver.name;
    headerStatus.textContent = "Online";

    subscribeOrders();
    subscribeBalance();
  }

  /* ----------------------------------------- */
  /* ORDERS */
  /* ----------------------------------------- */

  function subscribeOrders() {
    onValue(ref(db, "orders"), snap => {
      const data = snap.val() || {};
      resetMaps();

      ordersBox.innerHTML = "";
      myOrdersBox.innerHTML = "";
      noOpen.textContent = "";
      noMine.textContent = "";
      hasActiveRide = false;

      let openCount = 0;
      let mineCount = 0;

      /* STATISTICS */
      let countToday = 0;
      const today = new Date().toDateString();

      Object.values(data).forEach(o => {
        if (o.takenByDriverId === currentDriver?.id && o.status === "done") {
          const ts = o.completedAt || o.takenAt;
          if (ts && new Date(ts).toDateString() === today) countToday++;
        }
      });

      statRidesCount.textContent = countToday;

      /* ORDERS LOOP */
      Object.entries(data).forEach(([id, o]) => {
        const adr = cleanAddress(
          o.addressStreet || o.address || o.addressFull || o.locationAddress || ""
        );
        const adrLine = shortAddr(adr);

        const mapOpenId = "map_open_" + id;
        const mapMineId = "map_mine_" + id;

        /* --- OPEN REQUESTS --- */
        if (o.status === "open") {
          openCount++;
          const div = document.createElement("div");
          div.className = "order-card";

          div.innerHTML = `
            <div class="order-header">
              <div class="order-main">
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                <div class="order-address">${adrLine}</div>
              </div>
              <span class="badge badge-open">Kërkesë</span>
            </div>

            <div id="${mapOpenId}" class="mini-map"></div>
            <button class="btn-secondary">Prano</button>
          `;

          div.querySelector("button").onclick = () => {
            if (hasActiveRide) {
              alert("Ke një udhëtim aktiv.");
              return;
            }
            runTransaction(ref(db, "orders/" + id), c => {
              if (!c || c.status !== "open") return c;
              c.status = "taken";
              c.takenAt = Date.now();
              c.takenByDriverId = currentDriver.id;
              c.takenByName = currentDriver.name;
              c.addressFull = adr;
              return c;
            });
          };

          ordersBox.appendChild(div);

          if (o.lat && o.lng) {
            setTimeout(() => createMiniMap(mapOpenId, o.lat, o.lng), 80);
          }
        }

        /* --- MY ACTIVE RIDES --- */
        if (o.status === "taken" && o.takenByDriverId === currentDriver?.id) {
          mineCount++;
          hasActiveRide = true;

          const div = document.createElement("div");
          div.className = "order-card";

          div.innerHTML = `
            <div class="order-header">
              <div class="order-main">
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                <div class="order-address">${adrLine}</div>
              </div>
              <span class="badge badge-active">Aktiv</span>
            </div>

            <div id="${mapMineId}" class="mini-map"></div>
            <div class="info-line">Pranuar: ${minsSince(o.takenAt)}</div>

            <button class="btn-secondary finish-btn">Përfundo</button>
            <button class="btn-danger cancel-btn">Anulo</button>
          `;

          /* finish */
          div.querySelector(".finish-btn").onclick = () => {
            runTransaction(ref(db, "orders/" + id), c => {
              if (!c || c.status !== "taken") return c;
              c.status = "done";
              c.completedAt = Date.now();
              return c;
            }).then(() => {
              runTransaction(ref(db, "balances/" + currentDriver.id), cur => {
                const t = Date.now();
                const h = {
                  amount: 0.25,
                  orderId: id,
                  timestamp: t,
                  type: "ride",
                  address: adr
                };
                if (!cur) {
                  return {
                    total: 0.25,
                    status: "open",
                    lastUpdate: t,
                    history: { [id]: h }
                  };
                }
                cur.total = (cur.total || 0) + 0.25;
                cur.lastUpdate = t;
                if (!cur.history) cur.history = {};
                cur.history[id] = h;
                return cur;
              });
            });
          };

          /* cancel */
          div.querySelector(".cancel-btn").onclick = () => {
            const r = prompt("Arsyeja:");
            if (!r) return;
            runTransaction(ref(db, "orders/" + id), c => {
              if (!c || c.status !== "taken") return c;
              c.status = "canceled";
              c.canceledAt = Date.now();
              c.canceledReason = r;
              return c;
            });
          };

          myOrdersBox.appendChild(div);

          if (o.lat && o.lng) {
            setTimeout(() => createMiniMap(mapMineId, o.lat, o.lng), 80);
          }
        }
      });

      if (openCount === 0) noOpen.textContent = "Nuk ka kërkesa.";
      if (mineCount === 0) noMine.textContent = "Nuk ke udhëtime aktive.";
    });
  }

  /* ----------------------------------------- */
  /* BALANCE */
  /* ----------------------------------------- */

  function subscribeBalance() {
    onValue(ref(db, "balances/" + currentDriver.id), snap => {
      const d = snap.val();
      if (!d) {
        balanceSummary.textContent = "Nuk ka bilanc.";
        balanceHistoryList.innerHTML = "";
        balanceHistoryEmpty.textContent = "Boshe.";
        return;
      }

      balanceSummary.textContent = "Bilanc: " + (d.total || 0).toFixed(2) + " €";
      balanceMeta.textContent = d.lastUpdate
        ? "Përditësuar: " + new Date(d.lastUpdate).toLocaleString()
        : "";

      balanceHistoryList.innerHTML = "";
      const arr = Object.values(d.history || {})
        .sort((a, b) => b.timestamp - a.timestamp);

      if (arr.length === 0) {
        balanceHistoryEmpty.textContent = "Boshe.";
        return;
      }

      balanceHistoryEmpty.textContent = "";

      arr.forEach(h => {
        const row = document.createElement("div");
        row.className = "balance-row";

        row.innerHTML = `
          <div>
            <div class="balance-entry-address">${shortAddr(h.address || "Pa adresë")}</div>
            <div class="balance-entry-time">${new Date(h.timestamp).toLocaleString()}</div>
          </div>
          <strong class="balance-entry-amount">+${(h.amount || 0).toFixed(2)} €</strong>
        `;

        balanceHistoryList.appendChild(row);
      });
    });
  }

</script>
</body>
</html>

