<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Thirr taksin√´</title>

  <!-- iOS + Mobile FULLSCREEN FIX -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-kunde.json">
  <link rel="apple-touch-icon" href="/icon-kunde-192.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      background-color: #020617 !important;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
    }

    :root {
      --card-bg: rgba(15, 23, 42, 0.82);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.16);
      --danger: #f97373;
      --success: #4ade80;
      --radius: 24px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "SF Pro Text", sans-serif;
      color: #e5e7eb;
      padding: 24px 16px 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .app-frame {
      width: 100%;
      max-width: 430px;
      text-align: center;
    }

    .app-header {
      margin-top: 5px;
      margin-bottom: 22px;
      font-size: 20px;
      color: #e5e7eb;
      font-weight: 600;
      opacity: 0.92;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px 20px 22px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 20px 55px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      text-align: left;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 6px;
      color: #f9fafb;
    }

    .card-subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 18px;
      line-height: 1.45;
    }

    label {
      font-size: 14px;
      color: #cbd5f5;
      margin-top: 12px;
      display: block;
    }

    input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.88);
      font-size: 16px;
      color: #e5e7eb;
      margin-top: 5px;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
      background: rgba(15, 23, 42, 0.95);
      outline: none;
    }

    button {
      width: 100%;
      margin-top: 18px;
      padding: 15px 16px;
      font-size: 17px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #020617;
      box-shadow: 0 16px 42px rgba(34, 197, 94, 0.38);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      min-height: 18px;
    }

    .status.error { color: var(--danger); }
    .status.ok { color: var(--success); }

    .pending-card {
      margin-top: 20px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(10px);
      transition: 0.45s ease;
    }

    .pending-card.visible {
      max-height: 380px;
      opacity: 1;
      transform: translateY(0);
    }

    .pending-inner {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 20px;
      padding: 16px 16px 18px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }

    .pill {
      background: var(--accent-soft);
      padding: 6px 12px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #e0f2fe;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 999px;
    }

    .mini-map {
      width: 100%;
      height: 190px;
      border-radius: 18px;
      overflow: hidden;
      margin-top: 10px;
      border: 1px solid rgba(56, 189, 248, 0.45);
    }

    .small-caption {
      margin-top: 10px;
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>

<div class="app-frame">

  <div class="app-header">ThirrTaxi</div>

  <div class="card">
    <h1>Thirr taksin√´</h1>
    <div class="card-subtitle">
      Shkruaj emrin dhe numrin, lejo lokacionin. Ne gjejm√´ shoferin m√´ t√´ af√´rt p√´r ty.
    </div>

    <label>Emri</label>
    <input id="name" type="text" placeholder="Shkruaj emrin t√´nd">

    <label>Numri i telefonit</label>
    <input id="phone" type="tel" placeholder="044 000 000">

    <button id="orderBtn">
      üöï <span>Thirr taksin√´</span>
    </button>

    <div id="msg" class="status"></div>

    <div id="pendingWrapper" class="pending-card">
      <div class="pending-inner">
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="statusLabel">Jemi duke k√´rkuar shoferin tuaj‚Ä¶</span>
        </div>
        <div id="statusTimer" class="timer"></div>

        <div id="statusText" class="pending-text">
          K√´rkesa √´sht√´ d√´rguar. Jemi duke k√´rkuar shoferin m√´ t√´ af√´rt.
        </div>

        <div id="clientMap" class="mini-map"></div>

        <div class="small-caption">
          <span>Lokacioni yt aktual</span>
          <span>Live</span>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const btn = document.getElementById("orderBtn");
  const msg = document.getElementById("msg");
  const pendingWrapper = document.getElementById("pendingWrapper");
  const statusLabel = document.getElementById("statusLabel");
  const statusText = document.getElementById("statusText");
  const statusTimer = document.getElementById("statusTimer");
  let clientMap = null;
  let currentOrderKey = null;

  function initClientMap(lat, lng) {
    pendingWrapper.classList.add("visible");
    setTimeout(() => {
      if (clientMap) clientMap.remove();

      clientMap = L.map("clientMap", {
        zoomControl: false,
        attributionControl: false,
      }).setView([lat, lng], 16);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(clientMap);

      L.marker([lat, lng]).addTo(clientMap);
    }, 200);
  }

  function formatMinutesSince(ts) {
    if (!ts) return "";
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins <= 0) return "M√´ pak se 1 minut√´ m√´ par√´";
    if (mins === 1) return "1 minut√´ m√´ par√´";
    return mins + " minuta m√´ par√´";
  }

  function listenToOrderStatus(orderKey) {
    const orderRef = ref(db, "orders/" + orderKey);

    onValue(orderRef, (snap) => {
      const data = snap.val();
      if (!data) return;

      if (data.status === "open") {
        statusLabel.textContent = "Jemi duke k√´rkuar shoferin tuaj‚Ä¶";
        statusText.textContent =
          "K√´rkesa √´sht√´ aktive. Sapo nj√´ shofer ta pranoj√´, taksia niset drejt jush.";
        statusTimer.textContent = "";

      } else if (data.status === "taken") {
        statusLabel.textContent = "Taksia √´sht√´ nisur";
        statusText.textContent =
          "Shoferi √´sht√´ nisur p√´r t‚Äôju marr√´. Ju lutem mbani telefonin af√´r.";
        statusTimer.textContent =
          "Vozitja √´sht√´ pranuar: " + formatMinutesSince(data.takenAt);

      } else if (data.status === "done") {
        statusLabel.textContent = "Vozitja u p√´rfundua";
        statusText.textContent =
          "Faleminderit q√´ p√´rdor√´t sh√´rbimin ton√´.";
        statusTimer.textContent = "";

      } else if (data.status === "canceled") {
        statusLabel.textContent = "Vozitja u anulua";
        statusText.textContent =
          "Vozitja √´sht√´ anuluar. Arsyeja: " +
          (data.canceledReason || "nuk √´sht√´ specifikuar");
        statusTimer.textContent = "";
      }
    });
  }

  btn.onclick = () => {
    msg.textContent = "";
    msg.className = "status";

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!name || !phone) {
      msg.textContent = "Ju lutem shkruani emrin dhe numrin e telefonit.";
      msg.classList.add("error");
      return;
    }

    if (!navigator.geolocation) {
      msg.textContent = "Pajisja juaj nuk e p√´rkrah lokacionin.";
      msg.classList.add("error");
      return;
    }

    btn.disabled = true;
    msg.textContent = "Duke marr√´ lokacionin‚Ä¶";

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // ‚≠ê REVERSE GEOCODING (OpenStreetMap)
        let adresa = "";
        try {
          const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;
          const res = await fetch(url);
          const data = await res.json();
          adresa = data.display_name || "Adres√´ e panjohur";
        } catch (err) {
          adresa = "Adres√´ e panjohur";
        }

        // ‚≠ê SPEICHERN MIT ADRESA
        const ordersRef = ref(db, "orders");
        const newOrderRef = push(ordersRef);
        currentOrderKey = newOrderRef.key;

        const orderData = {
          name,
          phone,
          lat,
          lng,
          adresa,   // <---- WICHTIG!
          status: "open",
          createdAt: Date.now(),
          takenAt: null,
          completedAt: null,
          canceledAt: null,
          canceledReason: null,
        };

        await set(newOrderRef, orderData);

        msg.textContent = "K√´rkesa u d√´rgua me sukses.";
        msg.classList.add("ok");
        btn.disabled = false;

        initClientMap(lat, lng);
        listenToOrderStatus(currentOrderKey);
      },
      () => {
        msg.textContent = "Nuk u mor lokacioni. Ju lutem lejoni aksesin.";
        msg.classList.add("error");
        btn.disabled = false;
      }
    );
  };
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw-kunde.js").catch(console.error);
  }
</script>

</body>
</html>
