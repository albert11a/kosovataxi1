<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Thirr taksinÃ«</title>

  <!-- Fix: Fullscreen + kein Zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <!-- iOS Fullscreen Fix -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-kunde.json">
  <meta name="theme-color" content="#020617">
  <link rel="apple-touch-icon" href="/icon-kunde-192.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
/* ----------------------------- */
/* ðŸ”¥ GLOBAL iOS NO-WHITE FIX    */
/* ----------------------------- */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overscroll-behavior: none !important;
  background-color: #020617 !important;
}

/* Hintergrund durchgehend */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -1;
  background: radial-gradient(circle at top, #0f172a, #020617);
}

/* ----------------------------- */
/* ðŸ”¥ DESIGN VARS                */
/* ----------------------------- */
:root {
  --bg-gradient: radial-gradient(circle at top, #0f172a, #020617);
  --card-bg: rgba(15, 23, 42, 0.82);
  --accent: #38bdf8;
  --accent-soft: rgba(56, 189, 248, 0.16);
  --danger: #f97373;
  --success: #4ade80;
  --radius-xl: 24px;
  --shadow-soft: 0 18px 60px rgba(0, 0, 0, 0.55);
}

* { box-sizing: border-box; }

body {
  font-family: system-ui, -apple-system, "SF Pro Text", sans-serif;
  color: #e5e7eb;

  /* iPhone notch safe-area */
  padding: calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 20px);

  min-height: 100vh;
  background: var(--bg-gradient);
  display: flex;
  justify-content: center;
}

/* ----------------------------- */
/* ðŸ”¥ Header: ThirrTaxi centered */
/* ----------------------------- */
.app-header {
  width: 100%;
  text-align: center;
  margin-bottom: 18px;
  font-size: 20px;
  font-weight: 700;
  color: #f1f5f9;
  letter-spacing: 0.5px;
  opacity: 0.95;
}

.app-frame { width: 100%; max-width: 430px; }

/* ----------------------------- */
/* ðŸ”¥ CARD                      */
/* ----------------------------- */
.card {
  background: var(--card-bg);
  border-radius: var(--radius-xl);
  padding: 20px 20px 26px;
  backdrop-filter: blur(22px);
  -webkit-backdrop-filter: blur(22px);
  border: 1px solid rgba(148, 163, 184, 0.22);
  box-shadow: var(--shadow-soft);
}

h1 {
  font-size: 23px;
  margin: 0 0 6px;
  color: #f9fafb;
  text-align: center;
}

.card-subtitle {
  font-size: 14px;
  color: #9ca3af;
  margin-bottom: 18px;
  text-align: center;
}

/* ----------------------------- */
/* ðŸ”¥ INPUT                     */
/* ----------------------------- */
label {
  display: block;
  font-size: 13px;
  margin-bottom: 4px;
  margin-top: 12px;
  color: #cbd5f5;
}

input {
  width: 100%;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
  font-size: 16px;
  outline: none;
}

input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
}

/* ----------------------------- */
/* ðŸ”¥ BUTTON                    */
/* ----------------------------- */
button {
  width: 100%;
  margin-top: 20px;
  padding: 14px 18px;
  border-radius: 999px;
  border: none;
  font-size: 17px;
  font-weight: 600;
  background: linear-gradient(135deg, #0ea5e9, #22c55e);
  color: #020617;
  box-shadow: 0 18px 45px rgba(34, 197, 94, 0.35);
  display: flex;
  justify-content: center;
  gap: 8px;
  cursor: pointer;
}

/* Status Text */
.status { margin-top: 12px; min-height: 18px; font-size: 13px; }
.status.error { color: var(--danger); }
.status.ok { color: var(--success); }

/* Pending */
.pending-card {
  margin-top: 22px;
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transition: 0.45s ease;
}
.pending-card.visible {
  max-height: 380px;
  opacity: 1;
}

.pending-inner {
  border-radius: 22px;
  padding: 16px;
  background: rgba(15, 23, 42, 0.92);
  border: 1px solid rgba(56, 189, 248, 0.38);
}

.mini-map {
  width: 100%;
  height: 190px;
  border-radius: 18px;
  overflow: hidden;
  margin-top: 12px;
  border: 1px solid rgba(30, 64, 175, 0.8);
}
  </style>
</head>

<body>

<div class="app-frame">

  <!-- NEW CENTERED HEADER -->
  <div class="app-header">ThirrTaxi</div>

  <div class="card">
    <h1>Thirr taksinÃ«</h1>
    <div class="card-subtitle">
      Shkruaj emrin dhe numrin. Ne gjejmÃ« shoferin mÃ« tÃ« afÃ«rt pÃ«r ty.
    </div>

    <label>Emri</label>
    <input id="name" type="text" placeholder="Shkruaj emrin tÃ«nd">

    <label>Numri i telefonit</label>
    <input id="phone" type="tel" placeholder="044 000 000">

    <button id="orderBtn">
      <span>ðŸš•</span> Thirr taksinÃ«
    </button>

    <div id="msg" class="status"></div>

    <div id="pendingWrapper" class="pending-card">
      <div class="pending-inner">
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="statusLabel">Jemi duke kÃ«rkuar shoferinâ€¦</span>
        </div>

        <div id="statusTimer" class="timer"></div>

        <div id="statusText" class="pending-text">
          KÃ«rkesa Ã«shtÃ« aktive. Po kÃ«rkojmÃ« shoferin mÃ« tÃ« afÃ«rt.
        </div>

        <div id="clientMap" class="mini-map"></div>
      </div>
    </div>

  </div>
</div>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- FIREBASE LOGIC (unchanged) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const app = initializeApp({
    apiKey:"AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain:"kosovataxi-f6ca3.firebaseapp.com",
    projectId:"kosovataxi-f6ca3",
    storageBucket:"kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId:"1075646412122",
    appId:"1:1075646412122:web:7aab19b92f51844fe32f63",
    databaseURL:"https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  });

  const db = getDatabase(app);

  const btn = document.getElementById("orderBtn");
  const msg = document.getElementById("msg");
  const pendingWrapper = document.getElementById("pendingWrapper");
  const statusLabel = document.getElementById("statusLabel");
  const statusText = document.getElementById("statusText");
  const statusTimer = document.getElementById("statusTimer");

  let clientMap = null;
  let currentOrderKey = null;

  function initClientMap(lat, lng) {
    pendingWrapper.classList.add("visible");
    setTimeout(() => {
      if (clientMap) clientMap.remove();
      clientMap = L.map("clientMap", { zoomControl:false, attributionControl:false })
        .setView([lat,lng], 16);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
        .addTo(clientMap);

      L.marker([lat,lng]).addTo(clientMap);
    }, 200);
  }

  function listenToOrderStatus(orderKey) {
    onValue(ref(db,"orders/"+orderKey), snap => {
      const d = snap.val();
      if (!d) return;
      if (d.status==="open") {
        statusLabel.textContent = "Jemi duke kÃ«rkuar shoferinâ€¦";
        statusText.textContent = "Sapo njÃ« shofer ta pranojÃ«, do niset drejt jush.";
      }
      else if (d.status==="taken") {
        statusLabel.textContent = "Shoferi Ã«shtÃ« nisur";
        statusText.textContent = "Shoferi Ã«shtÃ« nisur pÃ«r tâ€™ju marrÃ«.";
      }
      else if (d.status==="done") {
        statusLabel.textContent = "Vozitja u pÃ«rfundua";
        statusText.textContent = "Faleminderit qÃ« pÃ«rdorÃ«t ThirrTaxi.";
      }
      else if (d.status==="canceled") {
        statusLabel.textContent = "Anuluar";
        statusText.textContent = "Vozitja u anulua.";
      }
    });
  }

  btn.onclick = () => {
    msg.textContent = "";
    msg.className = "status";

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!name || !phone) {
      msg.textContent = "Ju lutem shkruani emrin dhe numrin.";
      msg.classList.add("error");
      return;
    }

    if (!navigator.geolocation) {
      msg.textContent = "Lokacioni nuk pÃ«rkrahet.";
      msg.classList.add("error");
      return;
    }

    btn.disabled = true;
    msg.textContent = "Duke marrÃ« lokacioninâ€¦";

    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const newRef = push(ref(db,"orders"));
        currentOrderKey = newRef.key;

        set(newRef, {
          name, phone, lat, lng,
          status:"open",
          createdAt:Date.now()
        }).then(()=>{
          msg.textContent = "KÃ«rkesa u dÃ«rgua.";
          msg.classList.add("ok");
          btn.disabled = false;

          initClientMap(lat,lng);
          listenToOrderStatus(currentOrderKey);
        });
      },
      ()=>{
        msg.textContent="Lokacioni nuk u mor.";
        msg.classList.add("error");
        btn.disabled=false;
      }
    );
  };
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw-kunde.js");
}
</script>

</body>
</html>
