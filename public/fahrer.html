<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - KosovaTaxi</title>

  <!-- iOS FULLSCREEN FIX -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js")
        .catch(console.error);
    }
  </script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    /* iOS FIX – kein Weiß, kein Balken oben */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      background-color: #020617 !important;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
    }

    :root {
      --bg: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      --card-bg: rgba(15, 23, 42, 0.9);
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.25);
      --border-radius-xl: 24px;
      --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.65);
      --danger: #ef4444;
      --success: #22c55e;
      --text-subtle: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, -apple-system-font, "SF Pro Text", sans-serif;
      margin: 0;
      padding: 18px 12px 90px; /* unten extra Platz zum Scrollen */
      background: var(--bg);
      color: #e5e7eb;
    }

    .frame {
      max-width: 460px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 4px 14px;
      font-size: 13px;
      color: var(--text-subtle);
    }

    .header-left {
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }

    .header-center {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      color:#e5e7eb;
    }

    .dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 5px rgba(34,197,94,0.25);
    }

    .header-status {
      font-size: 12px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-subtle);
    }

    /* TABS */
    .tab-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      padding: 2px 2px 4px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab-btn {
      flex: 1;
      min-width: 90px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(15,23,42,0.96);
      color: #9ca3af;
      font-size: 13px;
      padding: 7px 10px;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(34,197,94,0.4);
      border-color: rgba(34,197,94,0.7);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* CARD */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.22);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-subtle);
      margin-bottom: 10px;
    }

    label {
      display:block;
      margin-top:8px;
      font-size:13px;
      color:#e5e7eb;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.94);
      color: #e5e7eb;
      font-size: 15px;
      outline: none;
      margin-top: 4px;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }

    button {
      border-radius:999px;
      border:none;
      font-size:15px;
      font-weight:600;
      padding:11px 12px;
      cursor:pointer;
    }

    .btn-primary {
      width:100%;
      margin-top:12px;
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
      box-shadow:0 14px 38px rgba(34,197,94,0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg,#facc15,#f97316);
      color:#111827;
      box-shadow:0 10px 28px rgba(250,204,21,0.4);
      font-size:14px;
      padding:9px 11px;
      width:100%;
      margin-top:10px;
    }

    .btn-danger {
      background:var(--danger);
      color:white;
      font-size:13px;
      padding:8px 11px;
      width:100%;
      margin-top:8px;
      box-shadow:0 6px 22px rgba(239,68,68,0.55);
    }

    .login-error {
      margin-top:8px;
      font-size:12px;
      color:#f97373;
    }

    .section-title {
      font-size:15px;
      font-weight:600;
      margin-top:4px;
      margin-bottom:4px;
    }

    .section-sub {
      font-size:12px;
      color:var(--text-subtle);
      margin-bottom:6px;
    }

    /* ORDER CARD */
    .order-card {
      background: radial-gradient(circle at top left, rgba(59,130,246,.22), rgba(15,23,42,.96));
      border-radius: 22px;
      padding: 12px 12px 14px;
      margin-top: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 18px 48px rgba(15, 23, 42, 0.95);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .order-name { font-size: 15px; font-weight: 600; }
    .order-phone { font-size: 13px; opacity: .9; }
    .order-address { font-size: 12px; color: #cbd5f5; margin-top: 2px; }

    .badge {
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      white-space: nowrap;
    }

    .badge-active { background:rgba(34,197,94,0.18); color:#bbf7d0; }
    .badge-open { background:rgba(251,191,36,0.18); color:#facc15; }

    .mini-map {
      width: 100%;
      height: 140px;
      border-radius: 16px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid rgba(15, 23, 42, .9);
    }
    .mini-map.leaflet-container {
      background:#020617;
    }

    .order-footer {
      margin-top: 8px;
      font-size: 11.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #9ca3af;
      gap:8px;
      flex-wrap: wrap;
    }

    .order-footer a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 12px;
    }

    .timer {
      font-size:11px;
      color:#e5e7eb;
    }

    .empty-text {
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
    }

    /* STATS / BALANCE */
    .stats-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      margin: 6px 0 10px;
    }

    .stats-chip {
      border-radius: 999px;
      border: none;
      font-size: 12px;
      padding: 5px 10px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
    }

    .stats-chip.active {
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
    }

    .stats-box {
      border-radius: 18px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      padding: 10px 12px;
      font-size: 13px;
    }

    .stat-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 3px 0;
      color:#e5e7eb;
    }

    .stat-row span:last-child {
      font-weight:600;
    }

    .balance-box {
      border-radius: 16px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      padding: 10px 12px;
      font-size: 13px;
      margin-top: 8px;
      line-height: 1.4;
    }

    .balance-status {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* HISTORY */
    .history-item {
      border-radius: 18px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      padding: 8px 10px;
      margin-top: 8px;
      font-size: 12px;
    }

    .history-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 2px;
    }

    .history-title {
      font-weight:500;
      font-size:13px;
    }

    .history-type-done {
      color:#bbf7d0;
    }

    .history-type-canceled {
      color:#fecaca;
    }

    /* LOGOUT SLIDER */
    .logout-wrap {
      margin-top: 18px;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }

    .logout-label {
      margin-bottom: 6px;
    }

    .logout-slider {
      position: relative;
      width: 100%;
      max-width: 360px;
      height: 44px;
      margin: 0 auto;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logout-slider-text {
      font-size: 13px;
      color: #9ca3af;
      pointer-events: none;
    }

    .logout-thumb {
      position: absolute;
      left: 4px;
      top: 3px;
      bottom: 3px;
      width: 74px;
      border-radius: 999px;
      background: linear-gradient(135deg,#ef4444,#f97316);
      box-shadow: 0 10px 30px rgba(239,68,68,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      color:#fef2f2;
      touch-action: none;
      cursor: pointer;
    }

    .logout-slider.done {
      opacity: 0.85;
    }

    @media (max-width: 380px) {
      .card {
        padding: 14px 12px 16px;
      }
      .order-card {
        padding: 10px 10px 12px;
      }
      .mini-map {
        height: 130px;
      }
    }
  </style>
</head>

<body>
<div class="frame">
  <!-- HEADER -->
  <div class="header">
    <div class="header-left">KosovaTaxi • Shofer</div>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <div id="headerStatus" class="header-status">Offline</div>
  </div>

  <!-- LOGIN CARD -->
  <div id="loginCard" class="card">
    <div class="card-title">Hyr si shofer</div>
    <div class="card-subtitle">
      Shkruaj vetëm PIN-in që të ka dhënë admini. Emri dhe kompania merren automatikisht.
    </div>

    <label>PIN</label>
    <input id="loginPin" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" class="login-error"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="content" style="display:none;">
    <!-- TABS -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="tab-active">Aktive</button>
      <button class="tab-btn" data-tab="tab-open">Kërkesa</button>
      <button class="tab-btn" data-tab="tab-balance">Bilanci</button>
      <button class="tab-btn" data-tab="tab-history">Lëvizjet</button>
    </div>

    <!-- TAB: AKTIVE -->
    <div id="tab-active" class="tab-panel active">
      <div class="card">
        <div class="section-title">Udhëtimet e mia aktive</div>
        <div class="section-sub">Mund të kesh vetëm një udhëtim aktiv në të njëjtën kohë.</div>

        <div id="myOrders"></div>
        <div id="noMine" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: KËRKESA (OPEN) -->
    <div id="tab-open" class="tab-panel">
      <div class="card">
        <div class="section-title">Kërkesa në pritje</div>
        <div class="section-sub">Këto janë udhëtime që mund t’i pranosh.</div>

        <div id="orders"></div>
        <div id="noOpen" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: BILANCI / PERFORMANCA -->
    <div id="tab-balance" class="tab-panel">
      <div class="card">
        <div class="section-title">Performanca ime</div>
        <div class="section-sub">Shiko udhëtimet e përfunduara dhe anulimet për sot, javën dhe muajin.</div>

        <div class="stats-toggle">
          <button class="stats-chip active" data-range="day">Sot</button>
          <button class="stats-chip" data-range="week">Java</button>
          <button class="stats-chip" data-range="month">Muaji</button>
        </div>

        <div class="stats-box">
          <div class="stat-row">
            <span>Udhëtime të përfunduara</span>
            <span id="statDone">0</span>
          </div>
          <div class="stat-row">
            <span>Anulime</span>
            <span id="statCanceled">0</span>
          </div>
        </div>

        <div class="section-title" style="margin-top:14px;">Barazimi im</div>
        <div id="balanceBox" class="balance-box"></div>
      </div>
    </div>

    <!-- TAB: LËVIZJET -->
    <div id="tab-history" class="tab-panel">
      <div class="card">
        <div class="section-title">Lëvizjet e fundit</div>
        <div class="section-sub">Lista e udhëtimeve të fundit të përfunduara dhe anulimeve.</div>

        <div id="historyList"></div>
        <div id="noHistory" class="empty-text"></div>
      </div>
    </div>

    <!-- LOGOUT SLIDER -->
    <div class="logout-wrap">
      <div class="logout-label">Për t'u çkyçur nga llogaria:</div>
      <div class="logout-slider" id="logoutSlider">
        <div class="logout-slider-text">Slide për t'u çkyçur</div>
        <div class="logout-thumb" id="logoutThumb">⇢</div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentDriver = null;
  let hasActiveRide = false;
  let locWatchId = null;

  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");
  const balanceBox = document.getElementById("balanceBox");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  const statDoneEl = document.getElementById("statDone");
  const statCanceledEl = document.getElementById("statCanceled");
  const statsChips = document.querySelectorAll(".stats-chip");
  let currentStatsRange = "day";

  // Stats cache
  const driverStats = {
    day: { done: 0, canceled: 0 },
    week: { done: 0, canceled: 0 },
    month: { done: 0, canceled: 0 }
  };

  // Helpers for dates
  function startOfDay(d) {
    const n = new Date(d); n.setHours(0,0,0,0); return n.getTime();
  }
  function endOfDay(d) {
    return startOfDay(d) + 24*60*60*1000;
  }
  function startOfWeek(d) {
    const n = new Date(d);
    n.setHours(0,0,0,0);
    const day = n.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    n.setDate(n.getDate() + diff);
    return n.getTime();
  }
  function endOfWeek(d) {
    return startOfWeek(d) + 7*24*60*60*1000;
  }
  function startOfMonth(d) {
    const n = new Date(d);
    return new Date(n.getFullYear(), n.getMonth(), 1).getTime();
  }
  function endOfMonth(d) {
    const n = new Date(d);
    return new Date(n.getFullYear(), n.getMonth()+1, 1).getTime();
  }

  /* ---------- SESSION / LOGIN ---------- */

  function applyLoggedInUI(driver) {
    currentDriver = driver;
    headerDriverName.textContent = driver.name || "Shoferi";
    headerStatus.textContent = "Online";
    loginCard.style.display = "none";
    content.style.display = "block";
    startLocationTracking();
    subscribeOrders();
    subscribeBalance();
  }

  function saveSession(driverId) {
    try {
      localStorage.setItem("shoferSession", JSON.stringify({ id: driverId }));
    } catch (e) {
      console.warn("Nuk u ruajt sesioni", e);
    }
  }

  function clearSession() {
    try {
      localStorage.removeItem("shoferSession");
    } catch (e) {}
  }

  function bootstrapSession() {
    let raw = null;
    try {
      raw = localStorage.getItem("shoferSession");
    } catch (e) {}
    if (!raw) return;

    let parsed = null;
    try {
      parsed = JSON.parse(raw);
    } catch (e) { return; }

    if (!parsed || !parsed.id) return;

    const drvRef = ref(db, "drivers/" + parsed.id);
    onValue(drvRef, (snap) => {
      const d = snap.val();
      if (!d || d.approved !== true || d.active === false) {
        clearSession();
        return;
      }
      if (!currentDriver) {
        applyLoggedInUI({ id: parsed.id, ...d });
      }
    }, { onlyOnce: true });
  }

  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Ju lutem shkruani PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");
    onValue(
      driversRef,
      (snap) => {
        const data = snap.val() || {};
        let found = null;
        Object.entries(data).forEach(([id, d]) => {
          if (
            String(d.pin) === String(pin) &&
            d.approved === true &&
            (d.active !== false)
          ) {
            found = { id, ...d };
          }
        });

        if (!found) {
          loginMsg.textContent = "PIN i pavlefshëm ose shoferi nuk është aktiv.";
          return;
        }

        if (!currentDriver) {
          saveSession(found.id);
          applyLoggedInUI(found);
        }
      },
      { onlyOnce: true }
    );
  };

  /* ---------- GEO TRACKING ---------- */

  function startLocationTracking() {
    if (!navigator.geolocation || !currentDriver) return;
    if (locWatchId !== null) return;

    locWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        const speed = pos.coords.speed;
        const heading = pos.coords.heading;

        const locRef = ref(db, "driverLocations/" + currentDriver.id);
        set(locRef, {
          lat,
          lng,
          accuracy: acc,
          speed: speed || null,
          heading: heading || null,
          updatedAt: Date.now(),
          name: currentDriver.name || null,
          company: currentDriver.company || null,
          online: true
        });
      },
      (err) => {
        console.warn("Geo error", err);
      },
      {
        enableHighAccuracy: true,
        timeout: 20000,
        maximumAge: 10000
      }
    );
  }

  function stopLocationTracking() {
    if (locWatchId !== null && navigator.geolocation) {
      navigator.geolocation.clearWatch(locWatchId);
      locWatchId = null;
    }
    if (currentDriver) {
      const locRef = ref(db, "driverLocations/" + currentDriver.id);
      set(locRef, {
        online: false,
        updatedAt: Date.now()
      }).catch(() => {});
    }
  }

  /* ---------- MAP & HELPERS ---------- */

  function createMiniMap(containerId, lat, lng) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = "";
    const map = L.map(containerId, {
      zoomControl: false,
      attributionControl: false,
    }).setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);
  }

  function formatMinutesSince(timestamp) {
    if (!timestamp) return "-";
    const diffMs = Date.now() - timestamp;
    const mins = Math.floor(diffMs / 60000);
    if (mins <= 0) return "më pak se 1 min";
    if (mins === 1) return "1 minutë";
    return mins + " minuta";
  }

  function extractStreet(address) {
    if (!address) return "Adresa nuk është e përcaktuar";
    const parts = String(address).split(",");
    return parts[0].trim() || "Adresa nuk është e përcaktuar";
  }

  /* ---------- ORDERS / UI ---------- */

  function subscribeOrders() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, (snap) => {
      const data = snap.val() || {};
      const openBox = document.getElementById("orders");
      const mineBox = document.getElementById("myOrders");
      const noOpen = document.getElementById("noOpen");
      const noMine = document.getElementById("noMine");
      const historyList = document.getElementById("historyList");
      const noHistory = document.getElementById("noHistory");

      openBox.innerHTML = "";
      mineBox.innerHTML = "";
      historyList.innerHTML = "";

      let openCount = 0;
      let mineCount = 0;
      hasActiveRide = false;

      // Reset stats
      driverStats.day.done = 0;
      driverStats.day.canceled = 0;
      driverStats.week.done = 0;
      driverStats.week.canceled = 0;
      driverStats.month.done = 0;
      driverStats.month.canceled = 0;

      const now = Date.now();
      const dayStart = startOfDay(now);
      const dayEnd = endOfDay(now);
      const weekStart = startOfWeek(now);
      const weekEnd = endOfWeek(now);
      const monthStart = startOfMonth(now);
      const monthEnd = endOfMonth(now);

      const historyArr = [];

      Object.entries(data).forEach(([id, o]) => {
        const safeIdOpen = "map_open_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
        const safeIdMine = "map_mine_" + id.replace(/[^a-zA-Z0-9_-]/g, "");

        const isMine = (o.takenByDriverId === currentDriver?.id);

        const completedTime = o.completedAt || o.createdAt || null;
        const canceledTime = o.canceledAt || null;

        // Stats for THIS driver
        if (isMine) {
          if (o.status === "done" && completedTime) {
            const t = completedTime;
            if (t >= dayStart && t < dayEnd) driverStats.day.done++;
            if (t >= weekStart && t < weekEnd) driverStats.week.done++;
            if (t >= monthStart && t < monthEnd) driverStats.month.done++;

            historyArr.push({
              type: "done",
              name: o.name,
              phone: o.phone,
              address: extractStreet(o.address),
              time: t
            });
          }

          if (o.status === "canceled" && canceledTime) {
            const t = canceledTime;
            if (t >= dayStart && t < dayEnd) driverStats.day.canceled++;
            if (t >= weekStart && t < weekEnd) driverStats.week.canceled++;
            if (t >= monthStart && t < monthEnd) driverStats.month.canceled++;

            historyArr.push({
              type: "canceled",
              name: o.name,
              phone: o.phone,
              address: extractStreet(o.address),
              time: t
            });
          }
        }

        /* --------------------
         * KËRKESA NË PRITJE
         * -------------------- */
        if (o.status === "open") {
          openCount++;
          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          const street = extractStreet(o.address);

          wrapper.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-name">${o.name}</div>
                <div class="order-phone">${o.phone}</div>
                <div class="order-address">${street}</div>
              </div>
              <span class="badge badge-open">Në pritje</span>
            </div>
            <div id="${safeIdOpen}" class="mini-map"></div>
            <div class="order-footer">
              <span>Kliko “Prano udhëtimin” për ta marrë këtë klient.</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
            </div>
          `;

          const acceptBtn = document.createElement("button");
          acceptBtn.className = "btn-secondary";
          acceptBtn.textContent = "✅ Prano udhëtimin";
          acceptBtn.onclick = () => {
            if (hasActiveRide) {
              alert("Nuk mund të pranoni më shumë se një udhëtim.");
              return;
            }
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "open") return current;
              current.status = "taken";
              current.takenByName = currentDriver.name;
              current.takenByCompany = currentDriver.company || "KosovaTaxi";
              current.takenByDriverId = currentDriver.id;
              current.takenAt = Date.now();
              return current;
            });
          };

          wrapper.appendChild(acceptBtn);
          openBox.appendChild(wrapper);
          setTimeout(() => createMiniMap(safeIdOpen, o.lat, o.lng), 80);
        }

        /* --------------------
         * UDHËTIMET E MIA AKTIVE
         * -------------------- */
        if (
          o.status === "taken" &&
          isMine
        ) {
          mineCount++;
          hasActiveRide = true;

          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          const timeText = formatMinutesSince(o.takenAt);
          const street = extractStreet(o.address);

          wrapper.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-name">${o.name}</div>
                <div class="order-phone">${o.phone}</div>
                <div class="order-address">${street}</div>
              </div>
              <span class="badge badge-active">Aktive</span>
            </div>
            <div id="${safeIdMine}" class="mini-map"></div>
            <div class="order-footer">
              <span class="timer">Udhëtimi është pranuar: ${timeText} më parë</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
            </div>
          `;

          /* Perfundo */
          const finishBtn = document.createElement("button");
          finishBtn.className = "btn-secondary";
          finishBtn.textContent = "✅ Përfundo udhëtimin";
          finishBtn.onclick = () => {
            const thisOrder = ref(db, "orders/" + id);

            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "done";
              current.completedAt = Date.now();
              return current;
            }).then(() => {
              // Update balance (0.25 € për kompaninë)
              const balRef = ref(db, "balances/" + currentDriver.id);
              runTransaction(balRef, (cur) => {
                if (!cur) {
                  return {
                    total: 0.25,
                    status: "open",
                    lastUpdate: Date.now()
                  };
                }
                cur.total = (cur.total || 0) + 0.25;
                cur.status = "open";
                cur.lastUpdate = Date.now();
                return cur;
              });
            });
          };

          /* Anulo */
          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn-danger";
          cancelBtn.textContent = "✖ Anulo udhëtimin";
          cancelBtn.onclick = () => {
            const reason = prompt("Shkruaj arsyen e anulimit:");
            if (!reason) return;
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "canceled";
              current.canceledAt = Date.now();
              current.canceledReason = reason;
              return current;
            });
          };

          wrapper.appendChild(finishBtn);
          wrapper.appendChild(cancelBtn);
          mineBox.appendChild(wrapper);

          setTimeout(() => createMiniMap(safeIdMine, o.lat, o.lng), 80);
        }
      });

      noOpen.textContent =
        openCount === 0 ? "Për momentin nuk ka kërkesa në pritje." : "";
      noMine.textContent =
        mineCount === 0 ? "Për momentin nuk ke udhëtim aktiv." : "";

      // History (done + canceled, recent)
      if (historyArr.length === 0) {
        noHistory.textContent = "Ende nuk ka lëvizje të regjistruara.";
      } else {
        noHistory.textContent = "";
        historyArr
          .sort((a, b) => b.time - a.time)
          .slice(0, 15)
          .forEach((h) => {
            const div = document.createElement("div");
            div.className = "history-item";
            const dt = new Date(h.time);
            const timeStr = dt.toLocaleString();
            const typeClass = h.type === "done" ? "history-type-done" : "history-type-canceled";
            const label = h.type === "done" ? "Udhëtim i përfunduar" : "Udhëtim i anuluar";

            div.innerHTML = `
              <div class="history-top">
                <span class="history-title ${typeClass}">${label}</span>
                <span>${timeStr}</span>
              </div>
              <div>${h.name} • ${h.phone}</div>
              <div style="color:#9ca3af;font-size:11px;margin-top:2px;">${h.address}</div>
            `;
            historyList.appendChild(div);
          });
      }

      updateStatsUI();
    });
  }

  function updateStatsUI() {
    const st = driverStats[currentStatsRange];
    if (!st) return;
    statDoneEl.textContent = st.done;
    statCanceledEl.textContent = st.canceled;
  }

  /* ---------- BALANCE ---------- */

  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);
    onValue(balRef, (snap) => {
      const data = snap.val();
      if (!data) {
        balanceBox.innerHTML = "Nuk ka barazim aktual.";
        return;
      }

      const total = (data.total || 0).toFixed(2);
      const dateStr = data.lastUpdate ? new Date(data.lastUpdate).toLocaleString() : "-";

      if (data.status === "open") {
        balanceBox.innerHTML = `
          <strong>Detyrim aktual:</strong> ${total} €<br>
          <div class="balance-status">
            Ky është borxhi aktual ndaj kompanisë. Herën e fundit u përditësua: ${dateStr}.
          </div>
        `;
      } else {
        balanceBox.innerHTML = `
          <strong>Barazim i përfunduar ✔</strong><br>
          <div class="balance-status">
            Aktualisht nuk ke borxh aktiv. Përditësimi i fundit: ${dateStr}.
          </div>
        `;
      }
    });
  }

  /* ---------- TABS ---------- */

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.tab;
      tabPanels.forEach(p => {
        p.classList.toggle("active", p.id === target);
      });
    });
  });

  /* ---------- STATS RANGE TOGGLE ---------- */

  statsChips.forEach(chip => {
    chip.addEventListener("click", () => {
      statsChips.forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      currentStatsRange = chip.dataset.range || "day";
      updateStatsUI();
    });
  });

  /* ---------- LOGOUT SLIDER ---------- */

  const logoutSlider = document.getElementById("logoutSlider");
  const logoutThumb = document.getElementById("logoutThumb");

  let sliding = false;
  let startX = 0;
  let thumbStart = 0;

  function logout() {
    stopLocationTracking();
    clearSession();
    currentDriver = null;
    headerDriverName.textContent = "Shoferi";
    headerStatus.textContent = "Offline";
    content.style.display = "none";
    loginCard.style.display = "block";
    logoutThumb.style.left = "4px";
    logoutSlider.classList.remove("done");
  }

  function onSlideStart(e) {
    e.preventDefault();
    sliding = true;
    startX = e.touches ? e.touches[0].clientX : e.clientX;
    thumbStart = logoutThumb.offsetLeft;

    document.addEventListener("touchmove", onSlideMove);
    document.addEventListener("touchend", onSlideEnd);
    document.addEventListener("mousemove", onSlideMove);
    document.addEventListener("mouseup", onSlideEnd);
  }

  function onSlideMove(e) {
    if (!sliding) return;
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const delta = x - startX;

    const sliderRect = logoutSlider.getBoundingClientRect();
    const maxLeft = sliderRect.width - logoutThumb.offsetWidth - 4;
    let newLeft = thumbStart + delta;
    if (newLeft < 4) newLeft = 4;
    if (newLeft > maxLeft) newLeft = maxLeft;

    logoutThumb.style.left = newLeft + "px";

    if (newLeft > sliderRect.width * 0.6) {
      sliding = false;
      logoutSlider.classList.add("done");
      document.removeEventListener("touchmove", onSlideMove);
      document.removeEventListener("touchend", onSlideEnd);
      document.removeEventListener("mousemove", onSlideMove);
      document.removeEventListener("mouseup", onSlideEnd);
      setTimeout(logout, 160);
    }
  }

  function onSlideEnd() {
    if (!sliding) return;
    sliding = false;
    logoutThumb.style.left = "4px";
    document.removeEventListener("touchmove", onSlideMove);
    document.removeEventListener("touchend", onSlideEnd);
    document.removeEventListener("mousemove", onSlideMove);
    document.removeEventListener("mouseup", onSlideEnd);
  }

  logoutThumb.addEventListener("touchstart", onSlideStart);
  logoutThumb.addEventListener("mousedown", onSlideStart);

  /* ---------- AUTO-SESSION ---------- */
  bootstrapSession();
</script>

</body>
</html>
