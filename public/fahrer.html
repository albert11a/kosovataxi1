<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - KosovaTaxi</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js").catch(console.error);
    }
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    /* BASE LAYOUT */
    html, body { margin:0; padding:0; height:100%; background:#020617; overscroll-behavior:none; }
    body::before { content:""; position:fixed; inset:0; z-index:-1;
      background: radial-gradient(circle at top,#020617,#020617 60%,#020617); }
    body { font-family:system-ui; padding:calc(14px + env(safe-area-inset-top)) 10px calc(22px + env(safe-area-inset-bottom));
      overflow-y:auto; color:#e5e7eb; }
    .frame { max-width:440px; margin:auto; display:flex; flex-direction:column; gap:12px; }

    .header { display:flex; justify-content:space-between; padding:2px 4px 10px; font-size:13px; color:#9ca3af; }
    .header-center { display:flex; gap:6px; align-items:center; font-weight:500; color:#e5e7eb; }
    .dot { width:6px; height:6px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 5px rgba(34,197,94,0.25); }

    .card { background:rgba(15,23,42,0.9); border-radius:24px; padding:16px 18px;
      border:1px solid rgba(148,163,184,0.22); backdrop-filter:blur(22px); margin-bottom:8px; }

    /* FLAT TABS */
    .tabs { display:flex; gap:8px; width:100%; margin-bottom:12px; }
    .tab { flex:1; background:rgba(255,255,255,0.05); border-radius:14px; padding:10px 0;
      display:flex; flex-direction:column; gap:6px; align-items:center; cursor:pointer;
      color:#9ca3af; transition:.2s; }
    .tab.active { background:rgba(56,189,248,0.25); color:#e5e7eb; transform:translateY(-1px); }
    .tab-icon { width:22px; opacity:.7; }
    .tab.active .tab-icon { opacity:1; transform:scale(1.05); }
    .tab-label { font-size:13px; opacity:.75; }
    .tab.active .tab-label { opacity:1; font-weight:600; }

    /* ⭐ NEUE INFO-CARD */
    .info-card {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
      margin-top: -4px;
    }
    .info-header { display:flex; justify-content:space-between; align-items:center; }
    .info-title { font-size:12.5px; font-weight:600; opacity:.85; }
    .notif {
      background:#ef4444; color:white;
      font-size:12px; font-weight:700;
      padding:3px 9px; border-radius:999px;
      line-height:1; }
    .info-desc { margin-top:5px; font-size:11px; color:#9ca3af; opacity:.8; }

    .section-title { font-size:14px; font-weight:500; margin-top:4px; margin-bottom:6px; }
    .section-sub { font-size:11px; color:#9ca3af; }

  </style>
</head>

<body>
<div class="frame">

  <!-- HEADER -->
  <div class="header">
    <span>KosovaTaxi</span>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <span id="headerStatus">Offline</span>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-target="tab-new">
      <svg class="tab-icon" viewBox="0 0 24 24"><path fill="white" d="M12 2a6 6 0 0 0-6 6v3.586l-.707.707A1 1 0 0 0 6 14h12a1 1 0 0 0 .707-1.707L18 11.586V8a6 6 0 0 0-6-6zm0 20a3 3 0 0 0 3-3H9a3 3 0 0 0 3 3z"/></svg>
      <span class="tab-label">Te reja</span>
    </div>

    <div class="tab" data-target="tab-active">
      <svg class="tab-icon" viewBox="0 0 24 24"><path fill="white" d="M13 2L3 14h7v8l10-12h-7z"/></svg>
      <span class="tab-label">Aktiv</span>
    </div>

    <div class="tab" data-target="tab-balance">
      <svg class="tab-icon" viewBox="0 0 24 24"><path fill="white" d="M15 4H9a7 7 0 0 0 0 14h6a1 1 0 1 0 0-2H9a5 5 0 0 1-4.9-4h3.02a1 1 0 0 0 0-2H4.1A5 5 0 0 1 9 6h6a1 1 0 1 0 0-2z"/></svg>
      <span class="tab-label">Bilanci</span>
    </div>
  </div>

  <!-- ⭐ NEUE INFO-CARD (NUR TE REJA) -->
  <div id="infoCard" class="info-card" style="display:block;">
    <div class="info-header">
      <div class="info-title">Klientët që presin taksi</div>
      <div class="notif" id="notifCount">0</div>
    </div>
    <div class="info-desc">Kliko "Prano" për ta marrë klientin.</div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="card-title">Hyr si shofer</div>
    <div class="card-subtitle">Shkruaj vetëm PIN-in që të ka dhënë admini.</div>

    <label>PIN</label>
    <input id="loginPin" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" class="login-error"></div>
  </div>
</div> <!-- END FRAME -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentDriver = null;
  let hasActiveRide = false;

  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");
  const balanceBox = document.getElementById("balanceBox");

  const infoCard = document.getElementById("infoCard");
  const notifCount = document.getElementById("notifCount");

  /* ---------------- TABS ---------------- */
  const tabs = document.querySelectorAll(".tab");

  tabs.forEach(t => {
    t.addEventListener("click", () => {
      document.querySelector(".tab.active")?.classList.remove("active");
      t.classList.add("active");

      const target = t.dataset.target;

      document.getElementById("tab-new-content").style.display =
        target === "tab-new" ? "block" : "none";

      document.getElementById("tab-active-content").style.display =
        target === "tab-active" ? "block" : "none";

      document.getElementById("tab-balance-content").style.display =
        target === "tab-balance" ? "block" : "none";

      /* ⭐ Info-Card nur bei TE REJA anzeigen */
      infoCard.style.display = target === "tab-new" ? "block" : "none";
    });
  });

  /* ---------------- LOGIN ---------------- */
  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Ju lutem shkruani PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");

    onValue(driversRef, snap => {
      const data = snap.val() || {};
      let found = null;

      Object.entries(data).forEach(([id, d]) => {
        if (String(d.pin) === pin && d.approved && d.active !== false) {
          found = { id, ...d };
        }
      });

      if (!found) {
        loginMsg.textContent = "PIN i pavlefshëm ose shoferi nuk është aktiv.";
        return;
      }

      currentDriver = found;
      headerDriverName.textContent = found.name;
      headerStatus.textContent = "Online";

      loginCard.style.display = "none";
      content.style.display = "block";

      subscribeOrders();
      subscribeBalance();
    }, { onlyOnce: true });
  };

  /* ---------------- MINI-MAP ---------------- */
  function createMiniMap(containerId, lat, lng) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = "";
    const map = L.map(containerId, {
      zoomControl: false,
      attributionControl: false,
    }).setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);
  }

  /* ---------------- ORDERS ---------------- */
  function subscribeOrders() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, snap => {
      const data = snap.val() || {};
      const openBox = document.getElementById("orders");
      const mineBox = document.getElementById("myOrders");
      const noOpen = document.getElementById("noOpen");
      const noMine = document.getElementById("noMine");

      openBox.innerHTML = "";
      mineBox.innerHTML = "";

      let openCountValue = 0;
      let mineCount = 0;
      hasActiveRide = false;

      Object.entries(data).forEach(([id, o]) => {
        const safeOpenId = "map_open_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
        const safeMineId = "map_mine_" + id.replace(/[^a-zA-Z0-9_-]/g, "");

        /* ⭐ OPEN ORDERS */
        if (o.status === "open") {
          openCountValue++;

          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          wrapper.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-name">${o.name}</div>
                <div class="order-phone">${o.phone}</div>
              </div>
              <span class="badge badge-open">Vozitje në pritje</span>
            </div>

            <div id="${safeOpenId}" class="mini-map"></div>

            <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:12px;">
              <span>Kliko për ta pranuar.</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank"
                style="color:#38bdf8;">Google Maps</a>
            </div>
          `;

          wrapper.onclick = () => {
            if (hasActiveRide) {
              alert("Nuk mund të pranoni më shumë se një vozitje.");
              return;
            }

            const orderRef = ref(db, "orders/" + id);
            runTransaction(orderRef, current => {
              if (!current || current.status !== "open") return current;
              current.status = "taken";
              current.takenByDriverId = currentDriver.id;
              current.takenByName = currentDriver.name;
              current.takenAt = Date.now();
              return current;
            });
          };

          openBox.appendChild(wrapper);
          setTimeout(() => createMiniMap(safeOpenId, o.lat, o.lng), 50);
        }

        /* ⭐ ACTIVE RIDES */
        if (o.status === "taken" && o.takenByDriverId === currentDriver?.id) {
          mineCount++;
          hasActiveRide = true;

          const t = Math.floor((Date.now() - o.takenAt) / 60000);
          const timeText = t <= 0 ? "më pak se 1 min" : `${t} minuta`;

          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          wrapper.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-name">${o.name}</div>
                <div class="order-phone">${o.phone}</div>
              </div>
              <span class="badge badge-active">Aktive</span>
            </div>

            <div id="${safeMineId}" class="mini-map"></div>

            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:12px;">
              <span>Vozitja: ${timeText}</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank"
                style="color:#38bdf8;">Google Maps</a>
            </div>
          `;

          /* Finish */
          const finishBtn = document.createElement("button");
          finishBtn.className = "btn-secondary";
          finishBtn.textContent = "✅ Perfundo vozitjen";
          finishBtn.onclick = () => {
            const orderRef = ref(db, "orders/" + id);

            runTransaction(orderRef, current => {
              if (!current || current.status !== "taken") return current;
              current.status = "done";
              current.completedAt = Date.now();
              return current;
            }).then(() => {
              /* Update balance */
              const balRef = ref(db, "balances/" + currentDriver.id);

              runTransaction(balRef, cur => {
                if (!cur) {
                  return { total: 0.25, status: "open", lastUpdate: Date.now() };
                }
                cur.total = (cur.total || 0) + 0.25;
                cur.status = "open";
                cur.lastUpdate = Date.now();
                return cur;
              });
            });
          };

          /* Cancel */
          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn-danger";
          cancelBtn.textContent = "✖ Anulo";
          cancelBtn.onclick = () => {
            const reason = prompt("Shkruaj arsyen:");
            if (!reason) return;

            const orderRef = ref(db, "orders/" + id);
            runTransaction(orderRef, current => {
              if (!current || current.status !== "taken") return current;
              current.status = "canceled";
              current.canceledReason = reason;
              current.canceledAt = Date.now();
              return current;
            });
          };

          wrapper.appendChild(finishBtn);
          wrapper.appendChild(cancelBtn);

          mineBox.appendChild(wrapper);
          setTimeout(() => createMiniMap(safeMineId, o.lat, o.lng), 50);
        }
      });

      /* ---------------- DYNAMIC INFO-CARD UPDATE ---------------- */
      notifCount.textContent = openCountValue;

      noOpen.textContent =
        openCountValue === 0 ? "Për momentin nuk ka vozitje." : "";
      noMine.textContent =
        mineCount === 0 ? "Nuk keni vozitje aktive." : "";
    });
  }

  /* ---------------- BALANCE ---------------- */
  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);

    onValue(balRef, snap => {
      const data = snap.val();

      if (!data) {
        balanceBox.innerHTML = "Nuk ka barazim.";
        return;
      }

      if (data.status === "open") {
        balanceBox.innerHTML = `
          <strong>Barazim i hapur:</strong> ${data.total.toFixed(2)} €<br>
          <small>Ju lutem barazohuni.</small>
        `;
      } else {
        balanceBox.innerHTML = `
          <strong>Barazim i përfunduar ✔</strong><br>
          <small>Nuk keni borxh.</small>
        `;
      }
    });
  }
</script>

</body>
</html>
