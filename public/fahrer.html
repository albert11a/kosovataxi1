<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - Thirr Taxi</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js")
        .catch(console.error);
    }
  </script>

  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>

/* GLOBAL */
html, body {
  margin: 0; padding: 0; height: 100%;
  background:#020617 !important;
  overscroll-behavior:none;
}

body {
  font-family: system-ui, -apple-system, "SF Pro Text", sans-serif;
  padding: 18px 12px 60px;
  color: #e5e7eb;
}

/* iOS Smooth */
* { transition: 0.15s ease; }

/* CARDS */
.card {
  background: rgba(15,23,42,0.80);
  border-radius: 20px;
  padding: 18px 16px 20px;
  margin-bottom: 18px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.07);
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
  animation: fadeIn 0.35s ease;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}

/* HEADER */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}

.header-left {
  font-size:18px;
  font-weight:600;
}

.dot {
  width:7px;
  height:7px;
  border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 3px rgba(34,197,94,0.25);
}

.header-center { display:flex; gap:6px; align-items:center; }

/* BUTTONS */
button {
  width:100%; border:none; border-radius:999px;
  padding:11px 14px;
  font-size:15px; font-weight:600;
  cursor:pointer;
  box-shadow:0 2px 5px rgba(0,0,0,0.25);
}

button:hover {
  transform:translateY(-1px);
  box-shadow:0 4px 12px rgba(0,0,0,0.35);
}

.btn-primary { background:#22c55e; color:#022c22; }
.btn-secondary { background:#0ea5e9; color:#022c22; }
.btn-danger { background:#ef4444; color:white; }

/* INPUT */
input {
  width:100%; padding:10px 12px; margin-top:4px;
  background:rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:14px;
  color:white;
  font-size:15px;
}

/* ----------------------------------------------- */
/*                PERFORMANCA IME                  */
/* ----------------------------------------------- */

.stats-card {
  background:rgba(15,23,42,0.85);
  border-radius:22px;
  padding:22px 18px 26px;
  text-align:center;
  border:1px solid rgba(255,255,255,0.08);
  box-shadow:0 6px 14px rgba(0,0,0,0.28);
}

.stats-title {
  font-size:16px;
  font-weight:600;
  margin-bottom:6px;
}

.stats-sub {
  font-size:12px;
  color:#9ca3af;
  margin-bottom:18px;
}

.stats-big {
  font-size:48px;
  font-weight:700;
  margin-bottom:6px;
  color:white;
}

.stats-label {
  font-size:14px;
  color:#cbd5e1;
}

/* ----------------------------------------------- */
/*                   BILANCI                       */
/* ----------------------------------------------- */

.balance-summary-box {
  background:rgba(56,189,248,0.15);
  padding:16px;
  border-radius:16px;
  margin-bottom:12px;
  border:1px solid rgba(56,189,248,0.25);
  text-align:center;
}

.balance-summary-box strong {
  font-size:20px;
}

.balance-history-card {
  padding:14px 16px;
  background:rgba(255,255,255,0.06);
  border-radius:16px;
  margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.10);
  box-shadow:0 2px 6px rgba(0,0,0,0.25);
}

.balance-entry-title {
  font-size:15px;
  font-weight:600;
}

.balance-entry-time {
  font-size:12px;
  color:#9ca3af;
  margin:4px 0 8px;
}

.balance-entry-amount {
  font-size:16px;
  font-weight:700;
  color:#22c55e;
  text-align:right;
}

  </style>
</head>

<body>

<div class="frame">

  <div class="header">
    <div class="header-left">Thirr Taxi</div>

    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>

    <span id="headerStatus" class="header-status">Offline</span>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="card-title">Hyr si shofer</div>
    <div class="card-subtitle">Shkruaj vet√´m PIN-in.</div>

    <label>PIN</label>
    <input id="loginPin" inputmode="numeric" placeholder="4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>

    <div id="loginMsg" class="login-error"></div>
  </div>

  <!-- CONTENT -->
  <div id="content" style="display:none;">


    <!-- PERFORMANCA IME (NUR HEUTE) -->
    <div class="stats-card">
      <div class="stats-title">Performanca ime</div>
      <div class="stats-sub">Udh√´time t√´ p√´rfunduara sot</div>

      <div id="statToday" class="stats-big">0</div>
      <div class="stats-label">Sot</div>
    </div>


    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-requests"><span>K√´rkesa</span></button>
      <button class="tab-btn" data-tab="tab-active"><span>Aktive</span></button>
      <button class="tab-btn" data-tab="tab-balance"><span>Bilanci</span></button>
    </div>
    <!-- TAB: K√ãRKESA -->
    <div id="tab-requests" class="tab-panel" style="display:block;">
      <div class="card">
        <div class="section-title">K√´rkesa t√´ reja</div>
        <div class="section-sub">Udh√´timet q√´ mund t‚Äôi pranosh.</div>

        <div id="orders"></div>
        <div id="noOpen" class="empty-text"></div>
      </div>
    </div>


    <!-- TAB: AKTIVE -->
    <div id="tab-active" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Udh√´timet e mia aktive</div>
        <div class="section-sub">Vet√´m nj√´ udh√´tim aktiv n√´ t√´ nj√´jt√´n koh√´.</div>

        <div id="myOrders"></div>
        <div id="noMine" class="empty-text"></div>
      </div>
    </div>



    <!-- TAB: BILANCI -->
    <div id="tab-balance" class="tab-panel" style="display:none;">
      <div class="card">

        <div class="section-title">Bilanci im</div>
        <div class="section-sub">Gjendja aktuale dhe levizjet.</div>

        <div id="balanceSummaryBox" class="balance-summary-box"></div>

        <div id="balanceHistoryList"></div>
      </div>
    </div>


  </div><!-- /content -->


</div><!-- /frame -->


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">

/* ---------------------------------------------- */
/*  FIREBASE INIT */
/* ---------------------------------------------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
  authDomain: "kosovataxi-f6ca3.firebaseapp.com",
  projectId: "kosovataxi-f6ca3",
  storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
  messagingSenderId: "1075646412122",
  appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
  databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------------------------------------- */

let currentDriver = null;
const LS_KEY = "thirrTaxiDriverId";

const loginCard = document.getElementById("loginCard");
const content = document.getElementById("content");
const loginBtn = document.getElementById("loginBtn");
const loginMsg = document.getElementById("loginMsg");

const ordersBox = document.getElementById("orders");
const myOrdersBox = document.getElementById("myOrders");
const noOpen = document.getElementById("noOpen");
const noMine = document.getElementById("noMine");

const statToday = document.getElementById("statToday");
const balanceSummaryBox = document.getElementById("balanceSummaryBox");
const balanceHistoryList = document.getElementById("balanceHistoryList");

/* ---------------------------------------------- */
/* LOGIN */
/* ---------------------------------------------- */

function afterLoginSetup() {
  loginCard.style.display = "none";
  content.style.display = "block";
  subscribeOrders();
  subscribeBalance();
}

loginBtn.onclick = () => {
  const pin = document.getElementById("loginPin").value.trim();
  if (!pin) return loginMsg.textContent = "Shkruaj PIN.";

  const driversRef = ref(db, "drivers");
  onValue(driversRef, snap => {
    const data = snap.val() || {};
    let found = null;

    Object.entries(data).forEach(([id, d]) => {
      if (String(d.pin) === pin && d.approved === true) {
        found = { id, ...d };
      }
    });

    if (!found) {
      loginMsg.textContent = "PIN i pavlefsh√´m.";
      return;
    }

    currentDriver = found;
    localStorage.setItem(LS_KEY, currentDriver.id);
    afterLoginSetup();

  }, { onlyOnce:true });
};


/* ---------------------------------------------- */
/* AUTO LOGIN */
/* ---------------------------------------------- */

const saved = localStorage.getItem(LS_KEY);
if (saved) {
  const refDrv = ref(db, "drivers/" + saved);
  onValue(refDrv, snap => {
    const d = snap.val();
    if (d && d.approved) {
      currentDriver = { id:saved, ...d };
      afterLoginSetup();
    } else {
      localStorage.removeItem(LS_KEY);
    }
  }, {onlyOnce:true});
}


/* ---------------------------------------------- */
/* ORDERS */
/* ---------------------------------------------- */

function subscribeOrders() {
  const ordersRef = ref(db, "orders");

  onValue(ordersRef, snap => {
    const data = snap.val() || {};
    ordersBox.innerHTML = "";
    myOrdersBox.innerHTML = "";

    let todayCount = 0;

    Object.entries(data).forEach(([id, o]) => {

      /* COUNT TODAY */
      if (o.takenByDriverId === currentDriver?.id && o.status === "done") {
        const d = new Date(o.completedAt || o.takenAt || 0);
        const now = new Date();
        if (d.toDateString() === now.toDateString()) {
          todayCount++;
        }
      }

      /* OPEN ORDERS */
      if (o.status === "open") {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div style="font-size:16px;font-weight:600">${o.name || "Klienti"}</div>
          <div style="font-size:13px;color:#9ca3af">${o.phone || ""}</div>
          <div style="margin-top:8px;font-size:12px">Adresa: ${o.addressStreet || o.address || "-"}</div>

          <button class="btn-secondary" style="margin-top:14px">Prano</button>
        `;

        el.querySelector("button").onclick = () => {
          const orderRef = ref(db, "orders/" + id);
          runTransaction(orderRef, cur => {
            if (cur && cur.status === "open") {
              cur.status = "taken";
              cur.takenByDriverId = currentDriver.id;
              cur.takenAt = Date.now();
            }
            return cur;
          });
        };

        ordersBox.appendChild(el);
      }

      /* ACTIVE MY ORDER */
      if (o.takenByDriverId === currentDriver?.id && o.status === "taken") {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div style="font-size:16px;font-weight:600">${o.name}</div>
          <div style="font-size:13px;color:#9ca3af">${o.phone}</div>
          <div style="margin-top:8px;font-size:12px">Adresa: ${o.addressStreet || o.address || "-"}</div>

          <button class="btn-secondary" style="margin-top:14px">P√´rfundo</button>
        `;

        el.querySelector("button").onclick = () => {
          const orderRef = ref(db, "orders/" + id);
          runTransaction(orderRef, cur => {
            if (cur && cur.status === "taken") {
              cur.status = "done";
              cur.completedAt = Date.now();
            }
            return cur;
          });
        };

        myOrdersBox.appendChild(el);
      }

    });

    statToday.textContent = todayCount;
  });
}


/* ---------------------------------------------- */
/* BALANCE */
/* ---------------------------------------------- */

function subscribeBalance() {
  const balRef = ref(db, "balances/" + currentDriver.id);

  onValue(balRef, snap => {
    const data = snap.val();

    if (!data) {
      balanceSummaryBox.innerHTML = "<strong>0.00 ‚Ç¨</strong><br>Asnj√´ bilanc";
      balanceHistoryList.innerHTML = "";
      return;
    }

    /* SUMMARY */
    balanceSummaryBox.innerHTML = `
      <strong>${(data.total || 0).toFixed(2)} ‚Ç¨</strong>
      <div style="font-size:12px;color:#cbd5e1;margin-top:6px;">Bilanci aktual</div>
    `;

    /* HISTORY */
    balanceHistoryList.innerHTML = "";

    const history = data.history || {};

    Object.entries(history)
      .sort((a,b) => b[1].timestamp - a[1].timestamp)
      .forEach(([id, h]) => {

        const dt = new Date(h.timestamp).toLocaleTimeString("de-DE", {
          hour:"2-digit",
          minute:"2-digit"
        });

        const address = h.address || "Adres√´ pa em√´r";

        const el = document.createElement("div");
        el.className = "balance-history-card";

        el.innerHTML = `
          <div class="balance-entry-title">üìç ${address}</div>
          <div class="balance-entry-time">‚è± ${dt}</div>
          <div class="balance-entry-amount">+0.25 ‚Ç¨</div>
        `;

        balanceHistoryList.appendChild(el);
      });
  });
}

/* ---------------------------------------------- */

</script>

</body>
</html>

