<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - Thirr Taxi</title>

  <!-- iOS / Mobile Vollbild & Zoom-Fix -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js").catch(console.error);
    }
  </script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    /* iOS Fix – keine weißen / schwarzen Balken */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      background-color: #020617 !important;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
    }

    :root {
      --bg: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      --card-bg: rgba(15, 23, 42, 0.94);
      --accent: #38bdf8;
      --tab-active: linear-gradient(135deg,#22c55e,#4ade80);
      --border-radius-xl: 22px;
      --shadow-soft: 0 16px 50px rgba(0, 0, 0, 0.55);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: system-ui, -apple-system, "SF Pro Text", sans-serif;
      margin: 0;
      padding: 18px 12px 32px;
      background: var(--bg);
      color: #e5e7eb;
    }

    .frame {
      max-width: 460px;
      margin: 0 auto;
      min-height: calc(100vh - 40px);
      padding-bottom: 24px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 4px 16px;
      font-size: 13px;
      color: #9ca3af;
    }

    .header-left {
      font-weight: 600;
      letter-spacing: 0.02em;
      color: #e5e7eb;
      font-size: 15px;
    }

    .header-center {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      color:#e5e7eb;
    }

    .dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 5px rgba(34,197,94,0.25);
    }

    .header-right {
      font-size: 12px;
      color: #9ca3af;
    }

    /* Performance Card */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.24);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #f9fafb;
    }

    .section-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    /* Tabs */
    .tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }

    .tab-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.96);
      color: #9ca3af;
      font-size: 12px;
      padding: 8px 4px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: none;
      transition: background 0.18s ease, color 0.18s ease, border 0.18s ease;
    }

    .tab-btn.active {
      background: var(--tab-active);
      color: #052e16;
      border-color: transparent;
      box-shadow: 0 10px 26px rgba(34,197,94,0.35);
    }

    label {
      display:block;
      margin-top:8px;
      font-size:13px;
      color:#cbd5f5;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      font-size: 15px;
      outline: none;
      margin-top: 4px;
      transition: border 0.18s, box-shadow 0.18s, background 0.18s;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
      background: rgba(15,23,42,1);
    }

    button {
      border-radius:999px;
      border:none;
      font-size:15px;
      font-weight:600;
      padding:11px 14px;
      cursor:pointer;
    }

    .btn-primary {
      width:100%;
      margin-top:12px;
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
      box-shadow:0 12px 32px rgba(34,197,94,0.36);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow:0 6px 18px rgba(34,197,94,0.25);
    }

    .btn-secondary {
      background: linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:#022c22;
      box-shadow:0 10px 26px rgba(56,189,248,0.32);
      font-size:14px;
      padding:9px 12px;
      width:100%;
      margin-top:8px;
    }

    .btn-danger {
      background:#ef4444;
      color:white;
      font-size:13px;
      padding:8px 12px;
      width:100%;
      margin-top:6px;
      box-shadow:0 8px 22px rgba(239,68,68,0.45);
    }

    .info {
      font-size:12px;
      color:#f97373;
      margin-top:8px;
    }

    .empty {
      font-size:12px;
      color:#6b7280;
      margin-top:6px;
    }

    /* Order Cards */
    .order-card {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.2), rgba(15,23,42,0.98));
      border-radius: 20px;
      padding: 12px 12px 14px;
      margin-top: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 16px 42px rgba(15, 23, 42, 0.9);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
      gap: 10px;
    }

    .order-main {
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .order-name {
      font-size: 15px;
      font-weight: 600;
      color:#e5e7eb;
    }

    .order-phone {
      font-size: 13px;
      color:#cbd5f5;
    }

    .order-address {
      font-size: 12px;
      color:#9ca3af;
    }

    .badge {
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      white-space:nowrap;
    }

    .badge-open { background:rgba(251,191,36,0.16); color:#facc15; }
    .badge-active { background:rgba(34,197,94,0.18); color:#bbf7d0; }

    .mini-map {
      width: 100%;
      height: 150px;
      border-radius: 16px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid rgba(15, 23, 42, .9);
    }

    .mini-map.leaflet-container {
      background:#020617;
    }

    .order-footer {
      margin-top: 8px;
      font-size: 11.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #9ca3af;
      gap:8px;
    }

    .order-footer a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 12px;
    }

    .timer {
      font-size:11px;
      color:#e5e7eb;
    }

    .tab-section {
      display:none;
    }

    .tab-section.active {
      display:block;
    }

    /* Balance History */
    .balance-box-main {
      font-size:14px;
      margin-bottom:10px;
    }

    .balance-row {
      display:flex;
      justify-content:space-between;
      font-size:12px;
      padding:4px 0;
      border-bottom:1px dashed rgba(55,65,81,0.7);
    }

    .balance-row:last-child {
      border-bottom:none;
    }
  </style>
</head>
<body>

<div class="frame">
  <div class="header">
    <div class="header-left">Thirr Taxi</div>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <div class="header-right" id="headerStatus">Offline</div>
  </div>

  <!-- PERFORMANCA IME (erst nach Login sichtbar) -->
  <div id="perfCard" class="card" style="display:none;">
    <div class="section-title">Performanca ime</div>
    <div class="section-sub">Përmbledhje e shpejtë e udhëtimeve të mia.</div>
    <div id="perfToday" style="font-size:13px; margin-bottom:4px;"></div>
    <div id="perfWeek" style="font-size:13px; margin-bottom:4px;"></div>
    <div id="perfMonth" style="font-size:13px; margin-bottom:4px;"></div>
    <div id="perfLast" style="font-size:12px; color:#9ca3af; margin-top:4px;"></div>
  </div>

  <!-- TABS (erst nach Login sichtbar) -->
  <div id="tabsBar" class="tabs" style="display:none;">
    <button class="tab-btn active" data-tab="tabKerkesat">
      <span>Kërkesat</span>
    </button>
    <button class="tab-btn" data-tab="tabAktive">
      <span>Udhëtimi aktual</span>
    </button>
    <button class="tab-btn" data-tab="tabBarazimi">
      <span>Barazimi</span>
    </button>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="section-title">Hyr si shofer</div>
    <div class="section-sub">
      Shkruaj vetëm PIN-in që të ka dhënë administratori. Emri dhe kompania merren automatikisht.
    </div>

    <label>PIN</label>
    <input id="loginPin" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">
      <span>Hyr online</span>
    </button>
    <div id="loginMsg" class="info"></div>
  </div>

  <!-- APP CONTENT -->
  <div id="appContent" style="display:none;">

    <!-- TAB 1: KËRKESAT -->
    <div id="tabKerkesat" class="tab-section active">
      <div class="card">
        <div class="section-title">Kërkesat e hapura</div>
        <div class="section-sub">Kliko për ta pranuar udhëtimin.</div>

        <div id="orders"></div>
        <div id="noOpen" class="empty"></div>
      </div>
    </div>

    <!-- TAB 2: UDHËTIMI AKTUAL -->
    <div id="tabAktive" class="tab-section">
      <div class="card">
        <div class="section-title">Udhëtimi aktual</div>
        <div class="section-sub">Vetëm një udhëtim mund të jetë aktiv në të njëjtën kohë.</div>

        <div id="myOrders"></div>
        <div id="noMine" class="empty"></div>
      </div>
    </div>

    <!-- TAB 3: BARAZIMI -->
    <div id="tabBarazimi" class="tab-section">
      <div class="card">
        <div class="section-title">Barazimi im</div>
        <div class="section-sub">Gjendja aktuale dhe lëvizjet e fundit.</div>

        <div id="balanceBox" class="balance-box-main"></div>

        <hr style="border-color: rgba(148,163,184,0.18); margin:12px 0;">

        <div class="section-title" style="margin-top:0;">Lëvizjet e fundit</div>
        <div id="balanceHistory"></div>
      </div>
    </div>

  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<!-- Firebase / Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentDriver = null;
  let hasActiveRide = false;
  let lastOrdersData = {};
  let positionWatchId = null;

  const loginCard = document.getElementById("loginCard");
  const appContent = document.getElementById("appContent");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");

  const tabsBar = document.getElementById("tabsBar");
  const perfCard = document.getElementById("perfCard");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabSections = document.querySelectorAll(".tab-section");

  const perfTodayEl = document.getElementById("perfToday");
  const perfWeekEl = document.getElementById("perfWeek");
  const perfMonthEl = document.getElementById("perfMonth");
  const perfLastEl = document.getElementById("perfLast");

  function activateTab(tabId) {
    tabButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tabId);
    });
    tabSections.forEach(sec => {
      sec.classList.toggle("active", sec.id === tabId);
    });
    if ((tabId === "tabAktive" || tabId === "tabKerkesat") && lastOrdersData) {
      renderOrders(lastOrdersData);
    }
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;
      activateTab(target);
    });
  });

  function formatMinutesSince(timestamp) {
    if (!timestamp) return "-";
    const diffMs = Date.now() - timestamp;
    const mins = Math.floor(diffMs / 60000);
    if (mins <= 0) return "më pak se 1 min";
    if (mins === 1) return "1 minutë";
    return mins + " minuta";
  }

  function formatAddress(order) {
    const raw = order.addressStreet || order.address || "";
    if (!raw) return "";
    const street = raw.split(",")[0].trim();
    return street;
  }

  function createMiniMap(containerId, lat, lng) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = "";

    const map = L.map(containerId, {
      zoomControl: false,
      attributionControl: false
    }).setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);
  }

  function startLocationTracking() {
    if (!navigator.geolocation || !currentDriver) return;
    if (positionWatchId !== null) return;

    const options = {
      enableHighAccuracy: true,
      maximumAge: 5000,
      timeout: 15000
    };

    positionWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        const locRef = ref(db, "driverLocations/" + currentDriver.id);
        set(locRef, {
          lat: latitude,
          lng: longitude,
          updatedAt: Date.now(),
          name: currentDriver.name || null,
          company: currentDriver.company || null
        }).catch(console.error);
      },
      (err) => {
        console.error("watchPosition error", err);
      },
      options
    );
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      startLocationTracking();
    }
  });

  function updatePerformance(data) {
    if (!currentDriver) return;

    const now = new Date();
    const dayStart = new Date(now); dayStart.setHours(0,0,0,0);
    const dayEnd = new Date(dayStart); dayEnd.setDate(dayEnd.getDate() + 1);

    // Woche: Montag–Sonntag
    const weekStart = new Date(now);
    weekStart.setHours(0,0,0,0);
    const day = weekStart.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    weekStart.setDate(weekStart.getDate() + diff);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 7);

    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1);

    let todayDone = 0;
    let weekDone = 0;
    let monthDone = 0;
    let lastCompletedTs = 0;

    Object.values(data).forEach(o => {
      if (o.status !== "done" || o.takenByDriverId !== currentDriver.id) return;
      const t = o.completedAt || o.createdAt || 0;
      if (!t) return;
      const d = new Date(t);

      if (t >= +dayStart && t < +dayEnd) todayDone++;
      if (t >= +weekStart && t < +weekEnd) weekDone++;
      if (t >= +monthStart && t < +monthEnd) monthDone++;
      if (t > lastCompletedTs) lastCompletedTs = t;
    });

    perfTodayEl.textContent = `Sot: ${todayDone} udhëtime të përfunduara`;
    perfWeekEl.textContent = `Java: ${weekDone} udhëtime të përfunduara`;
    perfMonthEl.textContent = `Muaji: ${monthDone} udhëtime të përfunduara`;

    if (lastCompletedTs) {
      perfLastEl.textContent = `Udhëtimi i fundit i përfunduar: ${formatMinutesSince(lastCompletedTs)} më parë`;
    } else {
      perfLastEl.textContent = `Ende nuk ke udhëtime të përfunduara.`;
    }
  }

  function renderOrders(data) {
    const openBox = document.getElementById("orders");
    const mineBox = document.getElementById("myOrders");
    const noOpen = document.getElementById("noOpen");
    const noMine = document.getElementById("noMine");

    openBox.innerHTML = "";
    mineBox.innerHTML = "";
    let openCount = 0;
    let mineCount = 0;
    hasActiveRide = false;

    Object.entries(data).forEach(([id, o]) => {
      const safeIdOpen = "map_open_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
      const safeIdMine = "map_active_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
      const addr = formatAddress(o);
      const addrHtml = addr ? `<div class="order-address">${addr}</div>` : "";

      // KËRKESAT E HAPURA
      if (o.status === "open") {
        openCount++;
        const wrapper = document.createElement("div");
        wrapper.className = "order-card";

        wrapper.innerHTML = `
          <div class="order-header">
            <div class="order-main">
              <div class="order-name">${o.name}</div>
              <div class="order-phone">${o.phone}</div>
              ${addrHtml}
            </div>
            <span class="badge badge-open">Kërkesë e hapur</span>
          </div>
          <div id="${safeIdOpen}" class="mini-map"></div>
          <div class="order-footer">
            <span>Prano dhe nisju drejt klientit.</span>
            <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
          </div>
        `;

        const acceptBtn = document.createElement("button");
        acceptBtn.className = "btn-secondary";
        acceptBtn.textContent = "✅ Prano udhëtimin";
        acceptBtn.onclick = () => {
          if (hasActiveRide) {
            alert("Nuk mund të pranoni më shumë se një udhëtim.");
            return;
          }
          const thisOrder = ref(db, "orders/" + id);
          runTransaction(thisOrder, (current) => {
            if (!current || current.status !== "open") return current;
            current.status = "taken";
            current.takenByName = currentDriver.name;
            current.takenByCompany = currentDriver.company || "Thirr Taxi";
            current.takenByDriverId = currentDriver.id;
            current.takenAt = Date.now();
            return current;
          }).then(() => {
            activateTab("tabAktive");
          }).catch(console.error);
        };

        wrapper.appendChild(acceptBtn);
        openBox.appendChild(wrapper);
        setTimeout(() => createMiniMap(safeIdOpen, o.lat, o.lng), 60);
      }

      // UDHËTIMI AKTUAL
      if (o.status === "taken" && o.takenByDriverId === currentDriver?.id) {
        mineCount++;
        hasActiveRide = true;

        const wrapper = document.createElement("div");
        wrapper.className = "order-card";
        const timeText = formatMinutesSince(o.takenAt);

        wrapper.innerHTML = `
          <div class="order-header">
            <div class="order-main">
              <div class="order-name">${o.name}</div>
              <div class="order-phone">${o.phone}</div>
              ${addrHtml}
            </div>
            <span class="badge badge-active">Aktive</span>
          </div>
          <div id="${safeIdMine}" class="mini-map"></div>
          <div class="order-footer">
            <span class="timer">Udhëtimi pranuar: ${timeText} më parë</span>
            <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
          </div>
        `;

        const finishBtn = document.createElement("button");
        finishBtn.className = "btn-secondary";
        finishBtn.textContent = "✅ Përfundo udhëtimin";
        finishBtn.onclick = () => {
          const thisOrder = ref(db, "orders/" + id);
          runTransaction(thisOrder, (current) => {
            if (!current || current.status !== "taken") return current;
            current.status = "done";
            current.completedAt = Date.now();
            return current;
          }).then(() => {
            const balRef = ref(db, "balances/" + currentDriver.id);
            runTransaction(balRef, (cur) => {
              const now = Date.now();
              if (!cur) {
                return {
                  total: 0.25,
                  status: "open",
                  lastUpdate: now,
                  history: {
                    [id]: {
                      amount: 0.25,
                      orderId: id,
                      timestamp: now
                    }
                  }
                };
              }
              const newTotal = (cur.total || 0) + 0.25;
              cur.total = newTotal;
              cur.status = "open";
              cur.lastUpdate = now;
              if (!cur.history) cur.history = {};
              cur.history[id] = {
                amount: 0.25,
                orderId: id,
                timestamp: now
              };
              return cur;
            });
          }).catch(console.error);
        };

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "btn-danger";
        cancelBtn.textContent = "✖ Anulo udhëtimin";
        cancelBtn.onclick = () => {
          const reason = prompt("Shkruaj arsyen e anulimit:");
          if (!reason) return;
          const thisOrder = ref(db, "orders/" + id);
          runTransaction(thisOrder, (current) => {
            if (!current || current.status !== "taken") return current;
            current.status = "canceled";
            current.canceledAt = Date.now();
            current.canceledReason = reason;
            return current;
          }).catch(console.error);
        };

        wrapper.appendChild(finishBtn);
        wrapper.appendChild(cancelBtn);
        mineBox.appendChild(wrapper);
        setTimeout(() => createMiniMap(safeIdMine, o.lat, o.lng), 60);
      }
    });

    noOpen.textContent =
      openCount === 0 ? "Për momentin nuk ka kërkesa të hapura." : "";
    noMine.textContent =
      mineCount === 0 ? "Aktualisht nuk ke udhëtim aktiv." : "";

    updatePerformance(data);
  }

  function subscribeOrders() {
    const ordersRef = ref(db, "orders");
    onValue(ordersRef, (snap) => {
      lastOrdersData = snap.val() || {};
      renderOrders(lastOrdersData);
    });
  }

  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);
    const box = document.getElementById("balanceBox");
    const histBox = document.getElementById("balanceHistory");

    onValue(balRef, (snap) => {
      const data = snap.val();
      if (!data) {
        box.innerHTML = "Nuk ka barazim aktual.";
        histBox.innerHTML = "<div class='empty'>Ende nuk ka lëvizje.</div>";
        return;
      }

      const total = (data.total || 0).toFixed(2);
      const lastUpdate = data.lastUpdate
        ? new Date(data.lastUpdate).toLocaleString()
        : "-";

      if (data.status === "open") {
        box.innerHTML = `
          <strong>Barazim i hapur:</strong> ${total} €<br>
          <small>Përditësuar: ${lastUpdate}</small>
        `;
      } else {
        box.innerHTML = `
          <strong>Barazim i përfunduar ✔</strong><br>
          <small>Përditësuar: ${lastUpdate}</small>
        `;
      }

      histBox.innerHTML = "";
      const history = data.history || {};
      const entries = Object.values(history).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
      if (entries.length === 0) {
        histBox.innerHTML = "<div class='empty'>Ende nuk ka lëvizje.</div>";
        return;
      }

      entries.slice(0, 10).forEach(item => {
        const row = document.createElement("div");
        row.className = "balance-row";
        const tsText = item.timestamp
          ? new Date(item.timestamp).toLocaleString()
          : "-";
        row.innerHTML = `
          <span>${tsText}</span>
          <span>+${(item.amount || 0).toFixed(2)} €</span>
        `;
        histBox.appendChild(row);
      });
    });
  }

  function finishLogin(found) {
    currentDriver = found;
    headerDriverName.textContent = found.name || "Shoferi";
    headerStatus.textContent = "Online";
    loginCard.style.display = "none";
    appContent.style.display = "block";
    tabsBar.style.display = "grid";
    perfCard.style.display = "block";

    localStorage.setItem("thirr_driver", JSON.stringify({
      id: found.id,
      name: found.name || "",
      company: found.company || ""
    }));

    subscribeOrders();
    subscribeBalance();
    startLocationTracking();
  }

  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Ju lutem shkruani PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");
    onValue(
      driversRef,
      (snap) => {
        const data = snap.val() || {};
        let found = null;
        Object.entries(data).forEach(([id, d]) => {
          if (
            String(d.pin) === String(pin) &&
            d.approved === true &&
            (d.active !== false)
          ) {
            found = { id, ...d };
          }
        });

        if (!found) {
          loginMsg.textContent = "PIN i pavlefshëm ose shoferi nuk është aktiv.";
          return;
        }

        if (!currentDriver) {
          finishLogin(found);
        }
      },
      { onlyOnce: true }
    );
  };

  document.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("thirr_driver");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (parsed && parsed.id) {
          finishLogin(parsed);
        }
      } catch (e) {
        console.error("Saved driver parse error", e);
      }
    }
  });
</script>

</body>
</html>
