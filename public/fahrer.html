<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - Thirr Taxi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#020617">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin:0; padding:0; height:100%;
      background:#020617; color:#e5e7eb;
      font-family:-apple-system,system-ui,sans-serif;
    }
    body { padding:12px 12px 80px; }
    body::before{
      content:""; position:fixed; inset:0;
      background:radial-gradient(circle at top,#0b1120,#020617 70%);
      z-index:-1;
    }
    .frame{ max-width:500px; margin:0 auto; }

    /* HEADER */
    .header{ display:flex; justify-content:space-between; align-items:center; padding:4px 0 12px; }
    .header-left{ font-size:17px; font-weight:600; }
    .header-center{ display:flex; align-items:center; gap:6px; }
    .dot{ width:7px; height:7px; border-radius:999px; background:#22c55e; }
    .header-status{ font-size:12px; opacity:.7; }

    /* STICKY TABS */
    .tabs{
      position:sticky; top:0; z-index:50;
      display:flex; gap:6px; padding:6px;
      background:rgba(2,6,23,0.92);
      backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .tab-btn{
      flex:1; padding:10px 0;
      border:none; border-radius:999px;
      background:transparent;
      color:#94a3b8; font-size:14px;
    }
    .tab-btn.active{
      background:rgba(255,255,255,0.12);
      color:white; font-weight:600;
    }

    /* STICKY PERFORMANCE */
    .performance-card{
      position:sticky; top:60px; z-index:40;
      background:rgba(15,23,42,0.88);
      backdrop-filter:blur(20px);
      border-radius:18px; padding:12px 16px;
      margin-bottom:14px;
    }
    .stat-main{ text-align:center; padding:4px 0; }
    .stat-number{ font-size:26px; font-weight:700; }
    .stat-label{ font-size:12px; opacity:.6; }

    /* GENERAL CARD */
    .card{
      background:rgba(15,23,42,0.70);
      border-radius:20px; padding:16px;
      margin-bottom:16px;
      border:1px solid rgba(148,163,184,0.22);
      backdrop-filter:blur(14px);
    }
    .section-title{ font-size:15px; font-weight:600; }
    .section-sub{ font-size:12px; opacity:.7; margin-bottom:8px; }

    /* ORDER CARDS */
    .order-card{
      background:rgba(30,41,59,0.75);
      border-radius:18px;
      padding:14px;
      margin-bottom:12px;
      border:1px solid rgba(148,163,184,0.18);
    }
    .order-header{ display:flex; justify-content:space-between; }
    .order-name{ font-size:15px; font-weight:600; }
    .order-phone{ font-size:13px; opacity:.9; }
    .order-address{ font-size:12px; color:#cbd5f5; margin-top:3px; line-height:1.3; }
    .badge{ padding:4px 8px; border-radius:8px; font-size:11px; }
    .badge-open{ background:rgba(251,191,36,0.15); color:#facc15; }
    .badge-active{ background:rgba(34,197,94,0.18); color:#4ade80; }
    .mini-map{
      width:100%; height:130px;
      border-radius:14px; margin:10px 0;
      background:#020617;
      border:1px solid rgba(15,23,42,0.9);
      overflow:hidden;
    }

    button{
      padding:10px; width:100%;
      border:none; border-radius:12px;
      font-size:15px; font-weight:600;
      margin-top:10px;
    }
    .btn-secondary{ background:linear-gradient(135deg,#0ea5e9,#22c55e); color:#022c22; }
    .btn-danger{ background:#ef4444; color:white; }

    .empty-text{ text-align:center; font-size:12px; opacity:.7; }
  </style>
</head>

<body>
<div class="frame">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">Thirr Taxi</div>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <span id="headerStatus" class="header-status">Offline</span>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="section-title">Hyr si shofer</div>
    <div class="section-sub">Shkruaj vetëm PIN-in.</div>
    <input id="loginPin" placeholder="PIN" inputmode="numeric">
    <button id="loginBtn" class="btn-secondary">Hyr</button>
    <div id="loginMsg" class="empty-text" style="color:#f87171;"></div>
  </div>

  <!-- CONTENT -->
  <div id="content" style="display:none;">

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="req">Kërkesa</button>
      <button class="tab-btn" data-tab="act">Udhëtimet</button>
      <button class="tab-btn" data-tab="bal">Bilanci</button>
    </div>

    <!-- PERFORMANCE -->
    <div class="card performance-card">
      <div class="section-title">Performanca ime</div>
      <div class="section-sub">Udhëtimet e sotme</div>
      <div class="stat-main">
        <div id="statRidesCount" class="stat-number">0</div>
        <div class="stat-label">Sot</div>
      </div>
    </div>

    <!-- TAB: KËRKESA -->
    <div id="tab-req">
      <div class="card">
        <div class="section-title">Kërkesa të reja</div>
        <div id="orders"></div>
        <div id="noOpen" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: AKTIVE -->
    <div id="tab-act" style="display:none;">
      <div class="card">
        <div class="section-title">Udhëtimet e mia</div>
        <div id="myOrders"></div>
        <div id="noMine" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: BILANCI -->
    <div id="tab-bal" style="display:none;">
      <div class="card">
        <div class="section-title">Bilanci im</div>
        <div id="balanceSummary"></div>
        <div id="balanceHistoryList"></div>
        <div id="balanceHistoryEmpty" class="empty-text"></div>
      </div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
/* --- FIREBASE IMPORTS --- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* --- FIREBASE CONFIG --- */
const firebaseConfig = {
  apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
  authDomain: "kosovataxi-f6ca3.firebaseapp.com",
  projectId: "kosovataxi-f6ca3",
  storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
  databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* --- GLOBAL --- */
let currentDriver = null;
let maps = {};

/* --- HELPERS --- */
function resetMaps(){
  Object.keys(maps).forEach(id=>{
    try { maps[id].remove(); } catch(e){}
    delete maps[id];
  });
}

function createMap(id, lat, lng){
  const c = document.getElementById(id);
  if(!c) return;

  const m = L.map(id,{zoomControl:false,attributionControl:false}).setView([lat,lng],16);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(m);
  L.marker([lat,lng]).addTo(m);
  maps[id]=m;

  setTimeout(()=>{m.invalidateSize();},240);
}

/* --- LOGIN --- */
loginBtn.onclick = ()=> {
  const pin = loginPin.value.trim();
  if(!pin){ loginMsg.textContent="Shkruaj PIN-in."; return; }

  const r = ref(db,"drivers");
  onValue(r, snap=>{
    const data = snap.val() || {};
    let found=null;
    Object.entries(data).forEach(([id,d])=>{
      if(String(d.pin)==pin && d.approved && d.active!==false){
        found={id,...d};
      }
    });
    if(!found){ loginMsg.textContent="PIN i gabuar."; return; }

    currentDriver=found;
    loginCard.style.display="none";
    content.style.display="block";
    loadOrders();
    loadBalance();
  }, {onlyOnce:true});
};

/* --- TABS --- */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const t = btn.dataset.tab;
    document.getElementById("tab-req").style.display = (t==="req"?"block":"none");
    document.getElementById("tab-act").style.display = (t==="act"?"block":"none");
    document.getElementById("tab-bal").style.display = (t==="bal"?"block":"none");

    setTimeout(()=>{
      Object.values(maps).forEach(m=>m.invalidateSize());
    },200);
  };
});

/* --- ORDERS --- */
function loadOrders(){
  const r=ref(db,"orders");
  onValue(r,snap=>{
    const orders=snap.val()||{};
    resetMaps();

    ordersDiv=orders;
    ordersBox.innerHTML="";
    myOrders.innerHTML="";

    let open=0, mine=0;

    Object.entries(orders).forEach(([id,o])=>{
      const adr=o.addressFull || o.address || "";
      const lat=o.lat, lng=o.lng;

      const mapIdOpen="m_o_"+id;
      const mapIdMine="m_m_"+id;

      /* OPEN */
      if(o.status==="open"){
        open++;
        ordersBox.innerHTML+=`
          <div class="order-card">
            <div class="order-header">
              <div>
                <div class="order-name">${o.name||"Klienti"}</div>
                <div class="order-phone">${o.phone||""}</div>
                <div class="order-address">${adr}</div>
              </div>
              <span class="badge badge-open">Kërkesë</span>
            </div>
            <div id="${mapIdOpen}" class="mini-map"></div>
            <button class="btn-secondary" onclick="takeOrder('${id}')">Prano</button>
          </div>
        `;
        setTimeout(()=>{ createMap(mapIdOpen,lat,lng); },100);
      }

      /* MINE */
      if(o.status==="taken" && o.takenByDriverId===currentDriver.id){
        mine++;
        myOrders.innerHTML+=`
          <div class="order-card">
            <div class="order-header">
              <div>
                <div class="order-name">${o.name||"Klienti"}</div>
                <div class="order-phone">${o.phone||""}</div>
                <div class="order-address">${adr}</div>
              </div>
              <span class="badge badge-active">Aktive</span>
            </div>
            <div id="${mapIdMine}" class="mini-map"></div>
            <button class="btn-secondary" onclick="finishOrder('${id}')">Përfundo</button>
            <button class="btn-danger" onclick="cancelOrder('${id}')">Anulo</button>
          </div>
        `;
        setTimeout(()=>{ createMap(mapIdMine,lat,lng); },100);
      }
    });

    noOpen.textContent = open===0?"Nuk ka kërkesa.":"";
    noMine.textContent = mine===0?"Nuk ke udhëtime aktive.":"";
  });
}

/* --- ORDER ACTIONS --- */
window.takeOrder=id=>{
  const r=ref(db,"orders/"+id);
  runTransaction(r,c=>{
    if(!c || c.status!=="open") return c;
    c.status="taken";
    c.takenByDriverId=currentDriver.id;
    c.takenAt=Date.now();
    return c;
  });
};
window.finishOrder=id=>{
  const r=ref(db,"orders/"+id);
  runTransaction(r,c=>{
    if(!c || c.status!=="taken") return c;
    c.status="done";
    c.completedAt=Date.now();
    return c;
  });
};
window.cancelOrder=id=>{
  const reason=prompt("Arsyeja:");
  const r=ref(db,"orders/"+id);
  runTransaction(r,c=>{
    if(!c || c.status!=="taken") return c;
    c.status="canceled";
    c.canceledReason=reason||"";
    c.canceledAt=Date.now();
    return c;
  });
};

/* --- BALANCE --- */
function loadBalance(){
  const r=ref(db,"balances/"+currentDriver.id);
  onValue(r,snap=>{
    const b=snap.val();
    if(!b){
      balanceSummary.textContent="Nuk ka bilanc.";
      return;
    }
    balanceSummary.textContent="Bilanci: "+(b.total||0).toFixed(2)+" €";

    balanceHistoryList.innerHTML="";
    if(!b.history){
      balanceHistoryEmpty.textContent="Nuk ka histori.";
      return;
    }
    Object.values(b.history).slice(-20).reverse().forEach(h=>{
      balanceHistoryList.innerHTML+=`
        <div>${h.address||""} — +${h.amount.toFixed(2)} €</div>
      `;
    });
  });
}
</script>
</body>
</html>
