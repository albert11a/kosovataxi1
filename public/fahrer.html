<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - KosovaTaxi</title>

  <!-- iOS / Mobile Viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js")
        .catch(console.error);
    }
  </script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      background-color: #020617 !important;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
    }

    :root {
      --bg: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      --card-bg: rgba(15, 23, 42, 0.9);
      --accent: #38bdf8;
      --border-radius-xl: 24px;
      --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.65);
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: calc(14px + env(safe-area-inset-top, 0px)) 10px calc(22px + env(safe-area-inset-bottom, 0px));
      background: var(--bg);
      color: #e5e7eb;
      overflow-y: auto;
    }

    .frame {
      max-width: 440px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: calc(100vh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 36px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 4px 10px;
      font-size: 13px;
      color: #9ca3af;
    }

    .header-center {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      color:#e5e7eb;
    }

    .dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 5px rgba(34,197,94,0.25);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.22);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 19px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    label {
      display:block;
      margin-top:8px;
      font-size:13px;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.94);
      color: #e5e7eb;
      font-size: 16px;
      outline: none;
      margin-top: 4px;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
      background: rgba(15,23,42,0.98);
    }

    button {
      border-radius:999px;
      border:none;
      font-size:15px;
      font-weight:600;
      padding:11px 12px;
      cursor:pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      filter: brightness(0.97);
    }

    .btn-primary {
      width:100%;
      margin-top:12px;
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
      box-shadow:0 14px 38px rgba(34,197,94,0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg,#facc15,#f97316);
      color:#111827;
      box-shadow:0 10px 28px rgba(250,204,21,0.4);
      font-size:14px;
      padding:8px 10px;
      width:100%;
      margin-top:6px;
    }

    .btn-danger {
      background:#ef4444;
      color:white;
      font-size:13px;
      padding:7px 10px;
      width:100%;
      margin-top:6px;
      box-shadow:0 6px 22px rgba(239,68,68,0.55);
    }

    .btn-ghost {
      background:rgba(15,23,42,0.95);
      border-radius:14px;
      padding:6px 12px;
      font-size:12px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:none;
      width:auto;
    }

    .login-error {
      margin-top:8px;
      font-size:12px;
      color:#f97373;
    }

    .section-title {
      font-size:14px;
      font-weight:500;
      margin-top:4px;
      margin-bottom:6px;
    }

    .section-sub {
      font-size:11px;
      color:#9ca3af;
      margin-bottom:4px;
    }

    .empty-text {
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
    }

    /* Tabs oben */
    .tabs {
      display: flex;
      gap: 8px;
      width: 100%;
      margin-bottom: 12px;
    }

    .tab {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background .25s ease, transform .20s ease;
      user-select: none;
      color: #9ca3af;
    }

    .tab-icon {
      width: 22px;
      height: 22px;
      opacity: .7;
      transition: opacity .20s ease, transform .20s ease;
    }

    .tab-label {
      font-size: 13px;
      opacity: .75;
      transition: opacity .20s ease;
    }

    .tab.active {
      background: rgba(56,189,248,0.25);
      transform: translateY(-1px);
      color: #e5e7eb;
    }

    .tab.active .tab-icon {
      opacity: 1;
      transform: scale(1.05);
    }

    .tab.active .tab-label {
      opacity: 1;
      font-weight: 600;
    }

    /* Premium Order Cards */
    .order-card {
      background: rgba(15,23,42,0.92);
      border-radius: 24px;
      padding: 22px 22px 26px;
      border: 1px solid rgba(148,163,184,0.20);
      box-shadow: 0 22px 52px rgba(0,0,0,0.55);
      margin-bottom: 18px;
      min-height: 310px;
    }

    .order-top {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }

    .order-name {
      font-size: 18.5px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .order-phone {
      font-size: 14px;
      opacity:0.9;
      margin-bottom: 6px;
    }

    .order-address {
      font-size: 13px;
      opacity:0.85;
      line-height: 1.45;
      margin-bottom: 4px;
    }

    .badge {
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      white-space: nowrap;
    }

    .badge-open {
      background:rgba(250,204,21,0.18);
      color:#facc15;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      margin-left:12px;
      white-space:nowrap;
    }

    .badge-active {
      background:rgba(34,197,94,0.18);
      color:#bbf7d0;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      margin-left:12px;
      white-space:nowrap;
    }

    .divider {
      width:100%;
      height:1px;
      background:rgba(148,163,184,0.18);
      margin:18px 0 16px;
    }

    .mini-map {
      width: 100%;
      height: 170px;
      border-radius:18px;
      margin-bottom: 20px;
      border:1px solid rgba(15,23,42,0.9);
      overflow:hidden;
    }

    .timer {
      font-size:12px;
      opacity:0.9;
      margin-bottom: 4px;
    }

    .btn-accept {
      width:100%;
      background:linear-gradient(135deg,#22c55e,#4ade80);
      border:none;
      border-radius:18px;
      padding:15px;
      font-size:16px;
      font-weight:700;
      color:#062e1e;
      letter-spacing:0.2px;
      box-shadow:none;
    }

    /* Info-Card oben bei Te reja */
    .info-card {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 20px;
      padding: 16px 18px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
      margin-bottom: 8px;
    }

    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-title {
      font-size: 12.5px;
      font-weight: 600;
      opacity: 0.85;
    }

    .notif {
      background: #ef4444;
      color: white;
      font-size: 12px;
      font-weight: 700;
      padding: 3px 9px;
      border-radius: 999px;
      line-height: 1;
    }

    .info-desc {
      margin-top: 5px;
      font-size: 11px;
      color: #9ca3af;
      opacity: 0.8;
    }

    /* Segmented Controls */
    .segmented {
      display:flex;
      background:rgba(255,255,255,0.06);
      padding:6px;
      border-radius:16px;
      gap:6px;
      margin:10px 0 14px;
    }

    .seg {
      flex:1;
      padding:8px 0;
      text-align:center;
      border-radius:14px;
      font-size:13px;
      cursor:pointer;
      opacity:0.75;
      background:rgba(255,255,255,0.04);
      user-select:none;
      transition:0.2s;
    }

    .seg.active {
      background:rgba(34,197,94,0.25);
      opacity:1;
      font-weight:600;
    }

    .barazim-card,
    .stat-card-driver {
      background:rgba(15,23,42,0.92);
      padding:16px 16px 14px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.22);
      margin-bottom:14px;
    }

    .row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      margin-bottom:6px;
      gap:12px;
    }

    .row span {
      color:#9ca3af;
    }

    .row strong {
      font-size:14px;
      font-weight:600;
      color:#e5e7eb;
    }

    .stat-big {
      font-size:20px;
      font-weight:700;
      color:#e5e7eb;
    }

    .stat-sub {
      font-size:11px;
      color:#6b7280;
      margin-top:2px;
    }

    .stat-list-7 {
      margin-top:10px;
      font-size:11px;
    }

    .stat-list-7-row {
      display:flex;
      justify-content:space-between;
      padding:3px 0;
      border-bottom:1px dashed rgba(55,65,81,0.7);
    }

    .stat-list-7-row:last-child {
      border-bottom:none;
    }

    .settle-details {
      margin-top:8px;
      font-size:11px;
      color:#9ca3af;
      border-top:1px dashed rgba(55,65,81,0.7);
      padding-top:6px;
    }

    @media (max-width: 400px) {
      body {
        padding: calc(10px + env(safe-area-inset-top, 0px)) 8px calc(18px + env(safe-area-inset-bottom, 0px));
      }
      .card {
        padding: 14px 12px 16px;
        border-radius: 20px;
      }
      .card-title {
        font-size: 18px;
      }
      .order-name {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>

<div class="frame">

  <div class="header">
    <span>KosovaTaxi</span>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <span id="headerStatus">Offline</span>
  </div>

  <!-- Tabs oben – erst nach Login sichtbar -->
  <div id="tabsBox" class="tabs" style="display:none;">
    <div class="tab active" data-target="tab-new">
      <svg class="tab-icon" viewBox="0 0 24 24">
        <path fill="white" d="M12 2a6 6 0 0 0-6 6v3.586l-.707.707A1 1 0 0 0 6 14h12a1 1 0 0 0 .707-1.707L18 11.586V8a6 6 0 0 0-6-6zm0 20a3 3 0 0 0 3-3H9a3 3 0 0 0 3 3z"/>
      </svg>
      <span class="tab-label">Te reja</span>
    </div>

    <div class="tab" data-target="tab-active">
      <svg class="tab-icon" viewBox="0 0 24 24">
        <path fill="white" d="M13 2L3 14h7v8l10-12h-7z"/>
      </svg>
      <span class="tab-label">Aktiv</span>
    </div>

    <div class="tab" data-target="tab-balance">
      <svg class="tab-icon" viewBox="0 0 24 24">
        <path fill="white" d="M15 4H9a7 7 0 0 0 0 14h6a1 1 0 1 0 0-2H9a5 5 0 0 1-4.9-4h3.02a1 1 0 0 0 0-2H4.1A5 5 0 0 1 9 6h6a1 1 0 1 0 0-2z"/>
      </svg>
      <span class="tab-label">Bilanci</span>
    </div>
  </div>

  <!-- Info-Card (nur bei Te reja + offenen Fahrten) -->
  <div id="infoCardOpen" class="info-card" style="display:none;">
    <div class="info-header">
      <div class="info-title">Klientët që presin taksi</div>
      <div class="notif" id="notifCount">0</div>
    </div>
    <div class="info-desc">
      Kliko “Prano” për ta marrë klientin.
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="card-title">Hyr si shofer</div>
    <div class="card-subtitle">
      Shkruaj vetëm PIN-in që të ka dhënë admini. Emri dhe kompania merren automatikisht.
    </div>

    <label>PIN</label>
    <input id="loginPin" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" class="login-error"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="content" style="display:none;">

    <!-- TAB 1: TE REJA -->
    <div id="tab-new-content">
      <div id="orders"></div>
      <div id="noOpen" class="empty-text"></div>
    </div>

    <!-- TAB 2: AKTIV -->
    <div id="tab-active-content" class="card" style="display:none;">
      <div class="section-title">Vozitjet e mia aktive</div>
      <div class="section-sub">Mund të kesh vetëm një vozitje aktive në të njëjtën kohë.</div>

      <div id="myOrders"></div>
      <div id="noMine" class="empty-text"></div>
    </div>

    <!-- TAB 3: BILANCI / STATISTIKAT & BARAZIMET -->
    <div id="tab-balance-content" class="card" style="display:none;">
      <div class="section-title">Bilanci, Statistikat &amp; Barazimet</div>

      <!-- Haupt-Segmente: Statistikat / Barazimet -->
      <div class="segmented">
        <div class="seg active" data-main="statsSection">Statistikat</div>
        <div class="seg" data-main="balancesSection">Barazimet</div>
      </div>

      <!-- STATISTIKAT -->
      <div id="statsSection">
        <div class="stat-card-driver">
          <div class="row">
            <span>Sot</span>
            <strong id="driverStatsTodayCount" class="stat-big">0 vozitje</strong>
          </div>
          <div class="row">
            <span>Të ardhurat sot</span>
            <strong id="driverStatsTodayRevenue">0.00 €</strong>
          </div>
          <div class="stat-sub" id="driverStatsTodayStatusSplit">
            E hapur: 0 • Në vozitje: 0 • Përfunduar: 0 • Anuluar: 0
          </div>
        </div>

        <div class="stat-card-driver">
          <div class="row">
            <span>7 ditët e fundit</span>
            <strong id="driverStats7DaysCount" class="stat-big">0 vozitje</strong>
          </div>
          <div class="row">
            <span>Të ardhurat 7-ditore</span>
            <strong id="driverStats7DaysRevenue">0.00 €</strong>
          </div>
          <div class="stat-sub" id="driverStats7DaysLabel"></div>
          <div class="stat-list-7" id="driverStatsLast7List"></div>
        </div>

        <div class="stat-card-driver">
          <div class="row">
            <span>Ky muaj</span>
            <strong id="driverStatsMonthCount" class="stat-big">0 vozitje</strong>
          </div>
          <div class="row">
            <span>Të ardhurat mujore</span>
            <strong id="driverStatsMonthRevenue">0.00 €</strong>
          </div>
          <div class="stat-sub" id="driverStatsMonthLabel"></div>
        </div>

        <div class="stat-card-driver">
          <div class="row">
            <span>Total deri tani</span>
            <strong id="driverStatsAllTimeRides" class="stat-big">0 vozitje</strong>
          </div>
          <div class="row">
            <span>Të ardhurat totale</span>
            <strong id="driverStatsAllTimeRevenue">0.00 €</strong>
          </div>
          <div class="row">
            <span>Norma e anulimit</span>
            <strong id="driverStatsCancelRate">0%</strong>
          </div>
        </div>
      </div>

      <!-- BARAZIMET -->
      <div id="balancesSection" style="display:none;">
        <div class="segmented">
          <div class="seg active" data-bal="current">Barazimet aktuale</div>
          <div class="seg" data-bal="history">Barazimet të përfunduara</div>
        </div>

        <!-- AKTUALE -->
        <div id="balCurrentSection">
          <div class="barazim-card">
            <div class="row">
              <span>Vozitje pa u barazuar</span>
              <strong id="balanceOpenRides">-</strong>
            </div>
            <div class="row">
              <span>Shuma aktuale</span>
              <strong id="balanceCurrentAmount">0.00 €</strong>
            </div>
            <div class="row">
              <span>Statusi</span>
              <strong id="balanceStatusText">-</strong>
            </div>
          </div>
          <div id="balanceBox" style="font-size:13px; color:#9ca3af; margin-top:4px;"></div>
        </div>

        <!-- HISTORIKU -->
        <div id="balHistorySection" style="display:none;">
          <div id="balanceHistoryEmpty" class="empty-text">
            Nuk ka ende barazime të përfunduara në këtë pajisje. Barazimet menaxhohen nga admini.
          </div>
          <div id="balanceHistoryList"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let currentDriver = null;
  let hasActiveRide = false;
  let currentTab = "tab-new";
  let lastOpenCount = 0;
  let ordersCache = {};
  let balanceHistory = [];
  let historyLoadedForDriver = false;
  let lastBalanceSnapshot = null;

  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");

  const tabsBox = document.getElementById("tabsBox");
  const infoCardOpen = document.getElementById("infoCardOpen");
  const notifCount = document.getElementById("notifCount");

  const tabs = document.querySelectorAll(".tab");

  const balanceBox = document.getElementById("balanceBox");
  const balanceOpenRidesEl = document.getElementById("balanceOpenRides");
  const balanceCurrentAmountEl = document.getElementById("balanceCurrentAmount");
  const balanceStatusTextEl = document.getElementById("balanceStatusText");
  const balanceHistoryEmptyEl = document.getElementById("balanceHistoryEmpty");
  const balanceHistoryListEl = document.getElementById("balanceHistoryList");

  const statsSection = document.getElementById("statsSection");
  const balancesSection = document.getElementById("balancesSection");
  const mainSegButtons = document.querySelectorAll("[data-main]");

  const balCurrentSection = document.getElementById("balCurrentSection");
  const balHistorySection = document.getElementById("balHistorySection");
  const balSegButtons = document.querySelectorAll("[data-bal]");

  // Stats elements
  const sTodayCount = document.getElementById("driverStatsTodayCount");
  const sTodayRevenue = document.getElementById("driverStatsTodayRevenue");
  const sTodaySplit = document.getElementById("driverStatsTodayStatusSplit");
  const s7DaysCount = document.getElementById("driverStats7DaysCount");
  const s7DaysRevenue = document.getElementById("driverStats7DaysRevenue");
  const s7DaysLabel = document.getElementById("driverStats7DaysLabel");
  const sLast7List = document.getElementById("driverStatsLast7List");
  const sMonthCount = document.getElementById("driverStatsMonthCount");
  const sMonthRevenue = document.getElementById("driverStatsMonthRevenue");
  const sMonthLabel = document.getElementById("driverStatsMonthLabel");
  const sAllTimeRides = document.getElementById("driverStatsAllTimeRides");
  const sAllTimeRevenue = document.getElementById("driverStatsAllTimeRevenue");
  const sCancelRate = document.getElementById("driverStatsCancelRate");

  /* ---------- Helper Zeitfunktionen ---------- */
  function startOfDay(d) {
    const n = new Date(d); n.setHours(0,0,0,0); return n;
  }
  function endOfDay(d) {
    const n = startOfDay(d); n.setDate(n.getDate() + 1); return n;
  }
  function daysAgo(num) {
    const d = new Date();
    d.setDate(d.getDate() - num);
    return d;
  }
  function startOfMonth(d) {
    const n = startOfDay(d);
    return new Date(n.getFullYear(), n.getMonth(), 1);
  }
  const monthNamesSq = [
    "Janar","Shkurt","Mars","Prill","Maj","Qershor",
    "Korrik","Gusht","Shtator","Tetor","Nëntor","Dhjetor"
  ];

  /* ---------- Tabs oben ---------- */
  tabs.forEach(t => {
    t.addEventListener("click", () => {
      const currentActive = document.querySelector(".tab.active");
      if (currentActive) currentActive.classList.remove("active");
      t.classList.add("active");

      const target = t.dataset.target;
      currentTab = target;

      document.getElementById("tab-new-content").style.display =
        target === "tab-new" ? "block" : "none";

      document.getElementById("tab-active-content").style.display =
        target === "tab-active" ? "block" : "none";

      document.getElementById("tab-balance-content").style.display =
        target === "tab-balance" ? "block" : "none";

      if (target === "tab-new" && currentDriver && lastOpenCount > 0) {
        infoCardOpen.style.display = "block";
      } else {
        infoCardOpen.style.display = "none";
      }
    });
  });

  /* ---------- Haupt-Segmente (Statistikat / Barazimet) ---------- */
  mainSegButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      mainSegButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.main;
      statsSection.style.display = target === "statsSection" ? "block" : "none";
      balancesSection.style.display = target === "balancesSection" ? "block" : "none";
    });
  });

  /* ---------- Unter-Segmente (Barazime aktuale / historik) ---------- */
  balSegButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      balSegButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.dataset.bal;
      balCurrentSection.style.display = target === "current" ? "block" : "none";
      balHistorySection.style.display = target === "history" ? "block" : "none";
    });
  });

  /* ---------- Login ---------- */
  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Ju lutem shkruani PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");
    onValue(
      driversRef,
      (snap) => {
        const data = snap.val() || {};
        let found = null;
        Object.entries(data).forEach(([id, d]) => {
          if (
            String(d.pin) === String(pin) &&
            d.approved === true &&
            (d.active !== false)
          ) {
            found = { id, ...d };
          }
        });

        if (!found) {
          loginMsg.textContent = "PIN i pavlefshëm ose shoferi nuk është aktiv.";
          return;
        }

        if (!currentDriver) {
          currentDriver = found;
          headerDriverName.textContent = found.name || "Shoferi";
          headerStatus.textContent = "Online";

          loginCard.style.display = "none";
          tabsBox.style.display = "flex";
          content.style.display = "block";

          loadBalanceHistoryForCurrentDriver();
          subscribeOrders();
          subscribeBalance();
        }
      },
      { onlyOnce: true }
    );
  };

  /* ---------- Map ---------- */
  function createMiniMap(containerId, lat, lng) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = "";
    const map = L.map(containerId, {
      zoomControl: false,
      attributionControl: false,
    }).setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);
  }

  function formatMinutesSince(timestamp) {
    if (!timestamp) return "-";
    const diffMs = Date.now() - timestamp;
    const mins = Math.floor(diffMs / 60000);
    if (mins <= 0) return "më pak se 1 min";
    if (mins === 1) return "1 minutë";
    return mins + " minuta";
  }

  /* ---------- Orders + Stats ---------- */
  function subscribeOrders() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, (snap) => {
      ordersCache = snap.val() || {};
      const data = ordersCache;

      const openBox = document.getElementById("orders");
      const mineBox = document.getElementById("myOrders");
      const noOpen = document.getElementById("noOpen");
      const noMine = document.getElementById("noMine");

      openBox.innerHTML = "";
      mineBox.innerHTML = "";
      let openCount = 0;
      let mineCount = 0;
      hasActiveRide = false;

      Object.entries(data).forEach(([id, o]) => {
        const safeIdOpen = "map_open_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
        const safeIdMine = "map_mine_" + id.replace(/[^a-zA-Z0-9_-]/g, "");

        if (o.status === "open") {
          openCount++;

          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          const addr = o.adresa || "";

          wrapper.innerHTML = `
            <div class="order-top">
              <div>
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                ${addr ? `<div class="order-address">${addr}</div>` : ""}
              </div>
              <div class="badge-open">Në pritje</div>
            </div>
            <div class="divider"></div>
            <div id="${safeIdOpen}" class="mini-map"></div>
            <button class="btn-accept">Prano vozitjen</button>
          `;

          openBox.appendChild(wrapper);
          setTimeout(() => createMiniMap(safeIdOpen, o.lat, o.lng), 50);

          const acceptBtn = wrapper.querySelector(".btn-accept");
          acceptBtn.onclick = (e) => {
            e.stopPropagation();
            if (hasActiveRide) {
              alert("Nuk mund të pranoni më shumë se një vozitje.");
              return;
            }
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "open") return current;
              current.status = "taken";
              current.takenByName = currentDriver.name;
              current.takenByCompany = currentDriver.company || "KosovaTaxi";
              current.takenByDriverId = currentDriver.id;
              current.takenAt = Date.now();
              return current;
            });
          };
        }

        if (
          o.status === "taken" &&
          o.takenByDriverId === currentDriver?.id
        ) {
          mineCount++;
          hasActiveRide = true;

          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          const timeText = formatMinutesSince(o.takenAt);
          const addr = o.adresa || "";

          wrapper.innerHTML = `
            <div class="order-top">
              <div>
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                ${addr ? `<div class="order-address">${addr}</div>` : ""}
              </div>
              <span class="badge-active">Aktive</span>
            </div>
            <div class="divider"></div>
            <div id="${safeIdMine}" class="mini-map"></div>
            <div class="timer">
              Vozitja ka filluar: ${timeText} më parë
            </div>
          `;

          const finishBtn = document.createElement("button");
          finishBtn.className = "btn-secondary";
          finishBtn.textContent = "✅ Perfundo vozitjen";
          finishBtn.onclick = () => {
            const thisOrder = ref(db, "orders/" + id);

            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "done";
              current.completedAt = Date.now();
              return current;
            }).then(() => {
              const balRef = ref(db, "balances/" + currentDriver.id);
              runTransaction(balRef, (cur) => {
                if (!cur) {
                  return {
                    total: 0.25,
                    status: "open",
                    lastUpdate: Date.now()
                  };
                }
                cur.total = (cur.total || 0) + 0.25;
                cur.status = "open";
                cur.lastUpdate = Date.now();
                return cur;
              });
            });
          };

          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn-danger";
          cancelBtn.textContent = "✖ Anulo vozitjen";
          cancelBtn.onclick = () => {
            const reason = prompt("Shkruaj arsyen:");
            if (!reason) return;
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "canceled";
              current.canceledAt = Date.now();
              current.canceledReason = reason;
              return current;
            });
          };

          wrapper.appendChild(finishBtn);
          wrapper.appendChild(cancelBtn);
          mineBox.appendChild(wrapper);

          setTimeout(() => createMiniMap(safeIdMine, o.lat, o.lng), 50);
        }
      });

      lastOpenCount = openCount;
      notifCount.textContent = openCount;

      if (currentDriver && currentTab === "tab-new" && openCount > 0) {
        infoCardOpen.style.display = "block";
      } else {
        infoCardOpen.style.display = "none";
      }

      document.getElementById("noOpen").textContent =
        openCount === 0 ? "Për momentin nuk ka vozitje në pritje." : "";
      document.getElementById("noMine").textContent =
        mineCount === 0 ? "Për momentin nuk keni vozitje aktive." : "";

      updateDriverStats();
    });
  }

  /* ---------- Driver-Statistikat ---------- */
  function updateDriverStats() {
    if (!currentDriver) return;

    const now = new Date();
    const todayStart = startOfDay(now).getTime();
    const todayEnd = endOfDay(now).getTime();
    const sevenStart = startOfDay(daysAgo(6)).getTime(); // 0..6
    const monthStart = startOfMonth(now).getTime();
    const monthEnd = startOfMonth(new Date(now.getFullYear(), now.getMonth() + 1, 1)).getTime();

    let todayTotal = 0, todayDone = 0, todayOpen = 0, todayTaken = 0, todayCanceled = 0;
    let sevenDone = 0;
    let monthDone = 0;
    let allDone = 0;
    let allCanceled = 0;

    const sevenMap = {};
    for (let i = 6; i >= 0; i--) {
      const d = startOfDay(daysAgo(i));
      const key = d.toISOString().slice(0,10);
      sevenMap[key] = 0;
    }

    Object.values(ordersCache).forEach(o => {
      if (o.takenByDriverId !== currentDriver.id) return;

      const created = o.createdAt || null;
      const completed = o.completedAt || null;

      if (created && created >= todayStart && created < todayEnd) {
        todayTotal++;
        if (o.status === "open") todayOpen++;
        else if (o.status === "taken") todayTaken++;
        else if (o.status === "done") todayDone++;
        else if (o.status === "canceled") todayCanceled++;
      }

      if (o.status === "done" && completed) {
        allDone++;
        if (completed >= sevenStart && completed < todayEnd) sevenDone++;
        if (completed >= monthStart && completed < monthEnd) monthDone++;

        const k = startOfDay(new Date(completed)).toISOString().slice(0,10);
        if (sevenMap[k] !== undefined) sevenMap[k] += 1;
      }

      if (o.status === "canceled") {
        allCanceled++;
      }
    });

    sTodayCount.textContent = `${todayTotal} vozitje`;
    sTodayRevenue.textContent = (todayDone * 0.25).toFixed(2) + " €";
    sTodaySplit.textContent =
      `E hapur: ${todayOpen} • Në vozitje: ${todayTaken} • Përfunduar: ${todayDone} • Anuluar: ${todayCanceled}`;

    s7DaysCount.textContent = `${sevenDone} vozitje`;
    s7DaysRevenue.textContent = (sevenDone * 0.25).toFixed(2) + " €";
    const sevenStartDate = new Date(sevenStart);
    s7DaysLabel.textContent =
      `Periudha: ${sevenStartDate.toLocaleDateString()} - ${now.toLocaleDateString()}`;

    sLast7List.innerHTML = "";
    Object.keys(sevenMap).sort().forEach(key => {
      const d = new Date(key + "T00:00:00");
      const row = document.createElement("div");
      row.className = "stat-list-7-row";
      row.innerHTML = `
        <span>${d.getDate()}. ${monthNamesSq[d.getMonth()]}</span>
        <span>${sevenMap[key]} vozitje</span>
      `;
      sLast7List.appendChild(row);
    });

    sMonthCount.textContent = `${monthDone} vozitje`;
    sMonthRevenue.textContent = (monthDone * 0.25).toFixed(2) + " €";
    sMonthLabel.textContent =
      `Muaji: ${monthNamesSq[new Date(monthStart).getMonth()]} ${new Date(monthStart).getFullYear()}`;

    sAllTimeRides.textContent = `${allDone} vozitje`;
    sAllTimeRevenue.textContent = (allDone * 0.25).toFixed(2) + " €";
    const totalRelevant = allDone + allCanceled;
    const cancelRate = totalRelevant === 0 ? 0 : Math.round((allCanceled / totalRelevant) * 100);
    sCancelRate.textContent = cancelRate + " %";
  }

  /* ---------- Balance History (lokal pro Gerät) ---------- */
  function historyKeyForCurrentDriver() {
    if (!currentDriver) return null;
    return "balanceHistory_driver_" + currentDriver.id;
  }

  function loadBalanceHistoryForCurrentDriver() {
    if (!currentDriver) return;
    const key = historyKeyForCurrentDriver();
    try {
      const raw = localStorage.getItem(key);
      balanceHistory = raw ? JSON.parse(raw) : [];
    } catch {
      balanceHistory = [];
    }
    historyLoadedForDriver = true;
    renderBalanceHistory();
  }

  function saveBalanceHistoryForCurrentDriver() {
    const key = historyKeyForCurrentDriver();
    if (!key) return;
    try {
      localStorage.setItem(key, JSON.stringify(balanceHistory));
    } catch {}
  }

  function renderBalanceHistory() {
    if (!balanceHistoryListEl) return;

    if (!balanceHistory || balanceHistory.length === 0) {
      balanceHistoryEmptyEl.style.display = "block";
      balanceHistoryListEl.innerHTML = "";
      return;
    }

    balanceHistoryEmptyEl.style.display = "none";
    balanceHistoryListEl.innerHTML = "";

    const copy = [...balanceHistory].sort((a,b) => b.to - a.to);

    copy.forEach((entry, index) => {
      const card = document.createElement("div");
      card.className = "barazim-card";

      const dateText = new Date(entry.to).toLocaleString();
      const rides = entry.rides || Math.round((entry.total || 0) / 0.25);

      card.innerHTML = `
        <div class="row">
          <span>Barazimi #${copy.length - index}</span>
          <strong>${dateText}</strong>
        </div>
        <div class="row">
          <span>Vozitje në këtë barazim</span>
          <strong>${rides}</strong>
        </div>
        <div class="row">
          <span>Shuma e barazimit</span>
          <strong>${(entry.total || 0).toFixed(2)} €</strong>
        </div>
        <div class="row" style="margin-top:8px;">
          <span>Detajet e klientëve</span>
          <button class="btn-ghost">Shiko detajet</button>
        </div>
        <div class="settle-details" style="display:none;"></div>
      `;

      const btn = card.querySelector(".btn-ghost");
      const details = card.querySelector(".settle-details");

      btn.addEventListener("click", () => {
        if (details.style.display === "none" || details.style.display === "") {
          details.style.display = "block";
          renderSettlementDetails(entry, details);
        } else {
          details.style.display = "none";
        }
      });

      balanceHistoryListEl.appendChild(card);
    });
  }

  function renderSettlementDetails(entry, container) {
    const from = entry.from || 0;
    const to = entry.to || 0;

    const rides = [];
    Object.entries(ordersCache).forEach(([id, o]) => {
      if (o.takenByDriverId !== currentDriver.id) return;
      if (o.status !== "done") return;
      if (!o.completedAt) return;
      if (o.completedAt <= from) return;
      if (o.completedAt > to) return;

      rides.push({
        id,
        name: o.name || "Klienti",
        phone: o.phone || "",
        adresa: o.adresa || "",
        completedAt: o.completedAt
      });
    });

    if (rides.length === 0) {
      container.innerHTML = "<div>Detajet nuk mund të llogariten nga kjo pajisje.</div>";
      return;
    }

    rides.sort((a,b) => a.completedAt - b.completedAt);

    let html = "";
    rides.forEach((r, idx) => {
      html += `
        <div style="margin-bottom:6px;">
          <strong>#${idx+1}</strong><br>
          ${r.name} • ${r.phone}<br>
          ${r.adresa ? `<span>${r.adresa}</span><br>` : ""}
          <small>${new Date(r.completedAt).toLocaleString()}</small>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  /* ---------- Balance subscribe ---------- */
  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);
    onValue(balRef, (snap) => {
      const data = snap.val();

      if (!historyLoadedForDriver) {
        loadBalanceHistoryForCurrentDriver();
      }

      // Übergang: open -> closed => neuen Barazim in History eintragen
      if (lastBalanceSnapshot &&
          lastBalanceSnapshot.status === "open" &&
          lastBalanceSnapshot.total > 0 &&
          data &&
          data.status === "closed") {

        const prevTo = balanceHistory.length
          ? balanceHistory[balanceHistory.length - 1].to
          : 0;

        const settleTo = data.lastUpdate || Date.now();
        const from = Math.max(prevTo, 0);
        const total = lastBalanceSnapshot.total || 0;
        const rides = Math.round(total / 0.25);

        balanceHistory.push({
          from,
          to: settleTo,
          total,
          rides,
          createdAt: Date.now()
        });
        saveBalanceHistoryForCurrentDriver();
        renderBalanceHistory();
      }

      lastBalanceSnapshot = data ? { ...data } : null;

      if (!data) {
        balanceOpenRidesEl.textContent = "-";
        balanceCurrentAmountEl.textContent = "0.00 €";
        balanceStatusTextEl.textContent = "Nuk ka barazim aktiv.";
        balanceBox.innerHTML = "Nuk ka barazim aktual.";
        return;
      }

      const total = data.total || 0;
      const rides = total > 0 ? Math.round(total / 0.25) : 0;

      balanceOpenRidesEl.textContent = rides > 0 ? String(rides) : "0";
      balanceCurrentAmountEl.textContent = total.toFixed(2) + " €";

      if (data.status === "open") {
        balanceStatusTextEl.textContent = "Në pritje të barazimit";
        balanceBox.innerHTML = `
          <strong>Barazim i hapur:</strong> ${total.toFixed(2)} €<br>
          <small>Barazimi bëhet vetëm nga administrata, jo nga shoferi.</small>
        `;
      } else {
        balanceStatusTextEl.textContent = "I barazuar";
        balanceBox.innerHTML = `
          <strong>Barazim i përfunduar ✔</strong><br>
          <small>Aktualisht nuk keni borxh aktiv.</small>
        `;
      }
    });
  }
</script>

</body>
</html>
