<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - Thirr Taxi</title>

  <!-- iOS FULLSCREEN / MOBILE -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js")
        .catch(console.error);
    }
  </script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    /* iOS / Safari: kein Weiß, kein komischer Balken */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overscroll-behavior: none;
      background-color: #020617 !important;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
    }

    :root {
      --bg: radial-gradient(circle at top, #020617, #020617 60%, #020617);
      --card-bg: rgba(15, 23, 42, 0.85);
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.25);
      --border-radius-xl: 20px;

      /* weichere, viel kleinere Schatten (iOS-Style) */
      --shadow-soft: 0 3px 10px rgba(0, 0, 0, 0.35);
      --shadow-softer: 0 2px 6px rgba(0, 0, 0, 0.28);

      --tab-bg: rgba(15,23,42,0.96);
      --tab-pill: rgba(15,23,42,1);
    }

    /* globale Transitions / iOS-Feeling */
    * {
      box-sizing: border-box;
      transition:
        background-color 0.18s ease,
        color 0.18s ease,
        border-color 0.18s ease,
        box-shadow 0.2s ease,
        transform 0.14s ease;
    }

    @keyframes fadeInSoft {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUpSoft {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    body {
      font-family: system-ui, -apple-system, "SF Pro Text", sans-serif;
      margin: 0;
      padding: 18px 12px 40px;
      background: var(--bg);
      color: #e5e7eb;
    }

    .frame {
      max-width: 480px;
      margin: 0 auto;
      padding-bottom: 40px; /* damit man immer ein bisschen scrollen kann */
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 4px 14px;
      font-size: 13px;
      color: #9ca3af;
    }

    .header-left {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 15px;
      color: #e5e7eb;
    }

    .header-center {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      color:#e5e7eb;
    }

    .dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,0.18);
    }

    .header-status {
      font-size:12px;
      color:#9ca3af;
    }

    /* TABS oben (Kërkesa / Aktive / Bilanci) – iOS Segmented */
    .tabs {
      background: rgba(15,23,42,0.92);
      border-radius: 999px;
      padding: 4px;
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 2px 8px rgba(15,23,42,0.55);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      animation: fadeInSoft 0.35s ease;
    }

    .tab-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 8px 4px;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      position: relative;
    }

    .tab-btn span {
      position: relative;
      z-index: 2;
    }

    .tab-btn.active {
      color: #e5e7eb;
      background: rgba(15,23,42,0.9);
      box-shadow: 0 1px 4px rgba(15,23,42,0.7);
      transform: translateY(-0.5px);
    }

    .tab-btn.active::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(34,197,94,0.16), rgba(37,99,235,0.25));
      z-index: 1;
    }

    /* Karten / Cards */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-xl);
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.22);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      margin-bottom: 18px;
      animation: fadeInSoft 0.35s ease;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    label {
      display:block;
      margin-top:8px;
      font-size:13px;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.94);
      color: #e5e7eb;
      font-size: 15px;
      outline: none;
      margin-top: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.35);
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }

    button {
      border-radius:999px;
      border:none;
      font-size:15px;
      font-weight:600;
      padding:11px 12px;
      cursor:pointer;
      width:100%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.32);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.45);
    }

    .btn-primary {
      margin-top:12px;
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
    }

    .btn-secondary {
      background: linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#022c22;
      font-size:14px;
      padding:9px 10px;
      margin-top:8px;
    }

    .btn-danger {
      background:#ef4444;
      color:white;
      font-size:13px;
      padding:8px 10px;
      margin-top:6px;
      box-shadow:0 1px 4px rgba(239,68,68,0.6);
    }

    .login-error {
      margin-top:8px;
      font-size:12px;
      color:#f97373;
    }

    .section-title {
      font-size:14px;
      font-weight:500;
      margin-bottom:4px;
    }

    .section-sub {
      font-size:11px;
      color:#9ca3af;
      margin-bottom:6px;
    }

    /* Order-Karte */
    .order-card {
      background: radial-gradient(circle at top left, rgba(59,130,246,.16), rgba(15,23,42,.96));
      border-radius: 18px;
      padding: 12px 12px 14px;
      margin-top: 10px;
      border: 1px solid rgba(55, 65, 81, 0.7);
      box-shadow: var(--shadow-softer);
      animation: slideUpSoft 0.35s ease;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .order-main {
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .order-name { font-size: 15px; font-weight: 600; }
    .order-phone { font-size: 13px; opacity: .9; }
    .order-address { font-size: 12px; color:#cbd5f5; }

    .badge {
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      white-space: nowrap;
    }

    .badge-active { background:rgba(34,197,94,0.18); color:#bbf7d0; }
    .badge-open { background:rgba(251,191,36,0.18); color:#facc15; }

    .mini-map {
      width: 100%;
      height: 140px;
      border-radius: 16px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid rgba(15, 23, 42, .9);
      background:#020617;
    }

    .order-footer {
      margin-top: 7px;
      font-size: 11.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #9ca3af;
      gap:8px;
    }

    .order-footer a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 12px;
    }

    .timer {
      font-size:11px;
      color:#e5e7eb;
    }

    .empty-text {
      font-size:12px;
      color:#6b7280;
      margin-top:4px;
    }

    /* STATS CARD */
    .stat-toggle {
      display:flex;
      gap:6px;
      margin-bottom:8px;
      margin-top:4px;
    }

    .stat-pill {
      flex:1;
      border-radius:999px;
      border:none;
      padding:5px 4px;
      background:rgba(15,23,42,0.95);
      color:#9ca3af;
      font-size:11px;
      cursor:pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.28);
    }

    .stat-pill.active {
      background:rgba(37,99,235,0.35);
      color:#e5e7eb;
      box-shadow:0 2px 6px rgba(37,99,235,0.55);
    }

    .stat-main {
      margin-top:4px;
    }

    .stat-number {
      font-size:24px;
      font-weight:600;
    }

    .stat-label {
      font-size:12px;
      color:#9ca3af;
      margin-top:2px;
    }

    /* Bilanci – brenda tab-it */
    .balance-summary {
      font-size:14px;
      margin-top:4px;
    }

    .balance-summary strong {
      font-weight:600;
    }

    .balance-meta {
      font-size:11px;
      color:#9ca3af;
      margin-top:4px;
    }

    .balance-toggle {
      margin-top:12px;
      display:flex;
      gap:6px;
    }

    .balance-tab-btn {
      flex:1;
      border-radius:12px;
      border:none;
      padding:6px 6px;
      background:rgba(15,23,42,0.95);
      color:#9ca3af;
      font-size:11px;
      cursor:pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.28);
    }

    .balance-tab-btn.active {
      background:rgba(56,189,248,0.28);
      color:#e5e7eb;
      box-shadow:0 2px 8px rgba(56,189,248,0.55);
    }

    .balance-panel { margin-top:10px; font-size:12px; }
    .balance-row {
      display:flex;
      justify-content:space-between;
      padding:4px 0;
      border-bottom:1px dashed rgba(55,65,81,0.8);
    }
    .balance-row:last-child { border-bottom:none; }

    .small-muted {
      font-size:11px;
      color:#6b7280;
    }
  </style>
</head>

<body>
<div class="frame">
  <!-- HEADER -->
  <div class="header">
    <div class="header-left">Thirr Taxi</div>
    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>
    <span id="headerStatus" class="header-status">Offline</span>
  </div>

  <!-- LOGIN CARD -->
  <div id="loginCard" class="card">
    <div class="card-title">Hyr si shofer</div>
    <div class="card-subtitle">
      Shkruaj vetëm PIN-in që ta ka dhënë administratori. Emri dhe kompania merren automatikisht.
    </div>

    <label>PIN</label>
    <input id="loginPin" inputmode="numeric" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" class="login-error"></div>
  </div>

  <!-- CONTENT NACH LOGIN -->
  <div id="content" style="display:none;">

    <!-- TOP TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-requests"><span>Kërkesa</span></button>
      <button class="tab-btn" data-tab="tab-active"><span>Udhëtimet e mia</span></button>
      <button class="tab-btn" data-tab="tab-balance"><span>Bilanci</span></button>
    </div>

    <!-- STATS CARD -->
    <div class="card">
      <div class="section-title">Performanca ime</div>
      <div class="section-sub">Sa udhëtime ke përfunduar si shofer.</div>
      <div class="stat-toggle">
        <button class="stat-pill active" data-range="day">Sot</button>
        <button class="stat-pill" data-range="week">Java</button>
        <button class="stat-pill" data-range="month">Muaji</button>
      </div>
      <div class="stat-main">
        <div id="statRidesCount" class="stat-number">0</div>
        <div id="statRidesLabel" class="stat-label">Udhëtime të përfunduara sot</div>
      </div>
    </div>

    <!-- TAB: KËRKESA -->
    <div id="tab-requests" class="tab-panel" style="display:block;">
      <div class="card">
        <div class="section-title">Kërkesa të reja</div>
        <div class="section-sub">Këto janë udhëtimet që mund t’i pranosh.</div>

        <div id="orders"></div>
        <div id="noOpen" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: AKTIVE -->
    <div id="tab-active" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Udhëtimet e mia aktive</div>
        <div class="section-sub">Mund të kesh vetëm një udhëtim aktiv në të njëjtën kohë.</div>

        <div id="myOrders"></div>
        <div id="noMine" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: BILANCI -->
    <div id="tab-balance" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Bilanci im</div>
        <div class="section-sub">Sa ke për t’u barazuar dhe levizjet e fundit.</div>

        <div id="balanceSummary" class="balance-summary"></div>
        <div id="balanceMeta" class="balance-meta"></div>

        <div class="balance-toggle">
          <button class="balance-tab-btn active" data-btab="b-summary">Përmbledhje</button>
          <button class="balance-tab-btn" data-btab="b-history">Levizjet e fundit</button>
        </div>

        <div id="b-summary" class="balance-panel">
          <!-- mbushet nga JS -->
        </div>
        <div id="b-history" class="balance-panel" style="display:none;">
          <div id="balanceHistoryList"></div>
          <div id="balanceHistoryEmpty" class="small-muted"></div>
        </div>
      </div>
    </div>

  </div> <!-- /content -->
</div> <!-- /frame -->

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const LS_KEY = "thirrTaxiDriverId";

  let currentDriver = null;
  let hasActiveRide = false;
  let activeStatRange = "day";
  const stats = { day: 0, week: 0, month: 0 };
  const maps = {};
  let geoWatchId = null;

  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  const statPills = document.querySelectorAll(".stat-pill");
  const statRidesCount = document.getElementById("statRidesCount");
  const statRidesLabel = document.getElementById("statRidesLabel");

  const balanceSummary = document.getElementById("balanceSummary");
  const balanceMeta = document.getElementById("balanceMeta");
  const balanceTabBtns = document.querySelectorAll(".balance-tab-btn");
  const balancePanels = {
    "b-summary": document.getElementById("b-summary"),
    "b-history": document.getElementById("b-history")
  };
  const balanceHistoryList = document.getElementById("balanceHistoryList");
  const balanceHistoryEmpty = document.getElementById("balanceHistoryEmpty");

  const ordersBox = document.getElementById("orders");
  const myOrdersBox = document.getElementById("myOrders");
  const noOpen = document.getElementById("noOpen");
  const noMine = document.getElementById("noMine");

  /* ---------- HELFER ---------- */

  function cleanAddress(a) {
    if (!a) return "";
    const lower = a.toLowerCase();
    if (lower.includes("nuk") && lower.includes("përcaktuar")) return "";
    return a;
  }

  function formatMinutesSince(timestamp) {
    if (!timestamp) return "-";
    const diffMs = Date.now() - timestamp;
    const mins = Math.floor(diffMs / 60000);
    if (mins <= 0) return "më pak se 1 min";
    if (mins === 1) return "1 minutë";
    return mins + " minuta";
  }

  function startOfDay(d) {
    const n = new Date(d); n.setHours(0,0,0,0); return n;
  }
  function startOfWeek(d) {
    const n = startOfDay(d);
    const day = n.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    n.setDate(n.getDate() + diff);
    return n;
  }
  function startOfMonth(d) {
    const n = startOfDay(d);
    return new Date(n.getFullYear(), n.getMonth(), 1);
  }

  function createOrUpdateMap(containerId, lat, lng) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (maps[containerId]) {
      maps[containerId].setView([lat, lng], 16);
      setTimeout(() => maps[containerId].invalidateSize(), 200);
      return;
    }

    const map = L.map(containerId, {
      zoomControl: false,
      attributionControl: false,
    }).setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    L.marker([lat, lng]).addTo(map);
    maps[containerId] = map;

    setTimeout(() => map.invalidateSize(), 200);
  }

  function invalidateAllMaps() {
    setTimeout(() => {
      Object.values(maps).forEach(m => {
        try { m.invalidateSize(); } catch(e) {}
      });
    }, 220);
  }

  function updateStatUI() {
    const value = stats[activeStatRange] || 0;
    statRidesCount.textContent = value;

    let label = "Udhëtime të përfunduara sot";
    if (activeStatRange === "week") label = "Udhëtime të përfunduara këtë javë";
    if (activeStatRange === "month") label = "Udhëtime të përfunduara këtë muaj";
    statRidesLabel.textContent = label;
  }

  function recalcStats(allOrders) {
    stats.day = 0;
    stats.week = 0;
    stats.month = 0;
    if (!currentDriver) return;

    const now = new Date();
    const dDay = startOfDay(now);
    const dWeek = startOfWeek(now);
    const dMonth = startOfMonth(now);

    Object.values(allOrders).forEach(o => {
      if (o.takenByDriverId !== currentDriver.id || o.status !== "done") return;
      const t = o.completedAt || o.takenAt || o.createdAt;
      if (!t) return;
      const dt = new Date(t);

      if (dt >= dDay) stats.day++;
      if (dt >= dWeek) stats.week++;
      if (dt >= dMonth) stats.month++;
    });

    updateStatUI();
  }

  function startLocationTracking() {
    if (!navigator.geolocation || !currentDriver) return;
    if (geoWatchId !== null) return;

    geoWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const locRef = ref(db, "driverLocations/" + currentDriver.id);
        // sehr kleines Payload – reicht
        runTransaction(locRef, () => ({
          lat,
          lng,
          updatedAt: Date.now()
        }));
      },
      (err) => {
        console.warn("Geolocation error:", err);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 15000
      }
    );
  }

  /* ---------- TAB LOGIK ---------- */

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;

      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      tabPanels.forEach(p => {
        p.style.display = (p.id === target) ? "block" : "none";
      });

      invalidateAllMaps();
    });
  });

  statPills.forEach(pill => {
    pill.addEventListener("click", () => {
      const r = pill.dataset.range;
      if (!r) return;
      activeStatRange = r;
      statPills.forEach(p => p.classList.remove("active"));
      pill.classList.add("active");
      updateStatUI();
    });
  });

  balanceTabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.btab;
      balanceTabBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      Object.entries(balancePanels).forEach(([id, el]) => {
        el.style.display = (id === target) ? "block" : "none";
      });
    });
  });

  /* ---------- LOGIN / AUTO-LOGIN ---------- */

  function afterLoginSetup() {
    if (!currentDriver) return;
    if (window.__driverInitialized) return;
    window.__driverInitialized = true;

    headerDriverName.textContent = currentDriver.name || "Shoferi";
    headerStatus.textContent = "Online";

    loginCard.style.display = "none";
    content.style.display = "block";

    subscribeOrders();
    subscribeBalance();
    startLocationTracking();
  }

  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Ju lutem shkruani PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");
    onValue(
      driversRef,
      (snap) => {
        const data = snap.val() || {};
        let found = null;
        Object.entries(data).forEach(([id, d]) => {
          if (
            String(d.pin) === String(pin) &&
            d.approved === true &&
            (d.active !== false)
          ) {
            found = { id, ...d };
          }
        });

        if (!found) {
          loginMsg.textContent = "PIN i pavlefshëm ose shoferi nuk është aktiv.";
          return;
        }

        currentDriver = found;
        localStorage.setItem(LS_KEY, currentDriver.id);
        afterLoginSetup();
      },
      { onlyOnce: true }
    );
  };

  // Auto-Login nach Reload
  const savedId = localStorage.getItem(LS_KEY);
  if (savedId) {
    const drvRef = ref(db, "drivers/" + savedId);
    onValue(
      drvRef,
      (snap) => {
        const d = snap.val();
        if (d && d.approved === true && (d.active !== false)) {
          currentDriver = { id: savedId, ...d };
          afterLoginSetup();
        } else {
          localStorage.removeItem(LS_KEY);
        }
      },
      { onlyOnce: true }
    );
  }

  /* ---------- ORDERS / REALTIME ---------- */

  function subscribeOrders() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, (snap) => {
      const data = snap.val() || {};

      ordersBox.innerHTML = "";
      myOrdersBox.innerHTML = "";
      let openCount = 0;
      let mineCount = 0;
      hasActiveRide = false;

      recalcStats(data);

      Object.entries(data).forEach(([id, o]) => {
        const safeIdOpen = "map_open_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
        const safeIdMine = "map_mine_" + id.replace(/[^a-zA-Z0-9_-]/g, "");

        const rawAdr = o.addressStreet || o.address;
        const addressText = cleanAddress(rawAdr);

        /* KËRKESA TË REJA */
        if (o.status === "open") {
          openCount++;
          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          wrapper.innerHTML = `
            <div class="order-header">
              <div class="order-main">
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                ${addressText ? `<div class="order-address">${addressText}</div>` : ""}
              </div>
              <span class="badge badge-open">Kërkesë e re</span>
            </div>
            <div id="${safeIdOpen}" class="mini-map"></div>
            <div class="order-footer">
              <span>Preke butonin për ta pranuar këtë udhëtim.</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
            </div>
          `;

          const acceptBtn = document.createElement("button");
          acceptBtn.className = "btn-secondary";
          acceptBtn.textContent = "✅ Prano udhëtimin";
          acceptBtn.onclick = () => {
            if (hasActiveRide) {
              alert("Nuk mund të pranosh më shumë se një udhëtim në të njëjtën kohë.");
              return;
            }
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "open") return current;
              current.status = "taken";
              current.takenByName = currentDriver.name;
              current.takenByCompany = currentDriver.company || "Thirr Taxi";
              current.takenByDriverId = currentDriver.id;
              current.takenAt = Date.now();
              return current;
            }).then(() => {
              // Direkt auf Tab "Aktive" wechseln
              const activeBtn = document.querySelector('.tab-btn[data-tab="tab-active"]');
              if (activeBtn) activeBtn.click();
            });
          };

          wrapper.appendChild(acceptBtn);
          ordersBox.appendChild(wrapper);

          if (typeof o.lat === "number" && typeof o.lng === "number") {
            setTimeout(() => createOrUpdateMap(safeIdOpen, o.lat, o.lng), 50);
          }
        }

        /* UDHËTIMET E MIJA AKTIVE */
        if (
          o.status === "taken" &&
          o.takenByDriverId === currentDriver?.id
        ) {
          mineCount++;
          hasActiveRide = true;

          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          const timeText = formatMinutesSince(o.takenAt);

          wrapper.innerHTML = `
            <div class="order-header">
              <div class="order-main">
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                ${addressText ? `<div class="order-address">${addressText}</div>` : ""}
              </div>
              <span class="badge badge-active">Aktive</span>
            </div>
            <div id="${safeIdMine}" class="mini-map"></div>
            <div class="order-footer">
              <span class="timer">Udhëtimi është pranuar: ${timeText} më parë</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
            </div>
          `;

          const finishBtn = document.createElement("button");
          finishBtn.className = "btn-secondary";
          finishBtn.textContent = "✅ Përfundo udhëtimin";
          finishBtn.onclick = () => {
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "done";
              current.completedAt = Date.now();
              return current;
            }).then(() => {
              const balRef = ref(db, "balances/" + currentDriver.id);
              runTransaction(balRef, (cur) => {
                const ts = Date.now();
                if (!cur) {
                  return {
                    total: 0.25,
                    status: "open",
                    lastUpdate: ts,
                    history: {
                      [id]: {
                        amount: 0.25,
                        orderId: id,
                        timestamp: ts,
                        type: "ride"
                      }
                    }
                  };
                }
                cur.total = (cur.total || 0) + 0.25;
                cur.status = "open";
                cur.lastUpdate = ts;
                if (!cur.history) cur.history = {};
                cur.history[id] = {
                  amount: 0.25,
                  orderId: id,
                  timestamp: ts,
                  type: "ride"
                };
                return cur;
              });
            });
          };

          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn-danger";
          cancelBtn.textContent = "✖ Anulo udhëtimin";
          cancelBtn.onclick = () => {
            const reason = prompt("Shkruaj arsyen e anulimit:");
            if (!reason) return;
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "canceled";
              current.canceledAt = Date.now();
              current.canceledReason = reason;
              return current;
            });
          };

          wrapper.appendChild(finishBtn);
          wrapper.appendChild(cancelBtn);
          myOrdersBox.appendChild(wrapper);

          if (typeof o.lat === "number" && typeof o.lng === "number") {
            setTimeout(() => createOrUpdateMap(safeIdMine, o.lat, o.lng), 50);
          }
        }
      });

      noOpen.textContent =
        openCount === 0 ? "Për momentin nuk ka kërkesa të reja." : "";
      noMine.textContent =
        mineCount === 0 ? "Për momentin nuk ke udhëtime aktive." : "";

      invalidateAllMaps();
    });
  }

  /* ---------- BILANCI / REALTIME ---------- */

  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);
    onValue(balRef, (snap) => {
      const data = snap.val();
      if (!data) {
        balanceSummary.innerHTML = "Nuk ka ende asnjë bilanc.";
        balanceMeta.textContent = "";
        balancePanels["b-summary"].innerHTML = "";
        balanceHistoryList.innerHTML = "";
        balanceHistoryEmpty.textContent = "Ende nuk ka levizje.";
        return;
      }

      const total = data.total || 0;
      const statusOpen = data.status !== "closed";

      if (statusOpen) {
        balanceSummary.innerHTML = `
          <strong>Bilanc i hapur:</strong> ${total.toFixed(2)} €
        `;
        balancePanels["b-summary"].innerHTML = `
          <p>Ky është bilanci yt aktual për t’u barazuar me kompaninë.</p>
        `;
      } else {
        balanceSummary.innerHTML = `
          <strong>Bilanc i përfunduar ✔</strong>
        `;
        balancePanels["b-summary"].innerHTML = `
          <p>Aktualisht nuk ke borxh të hapur ndaj kompanisë.</p>
        `;
      }

      if (data.lastUpdate) {
        const d = new Date(data.lastUpdate);
        balanceMeta.textContent = "Përditësimi i fundit: " + d.toLocaleString();
      } else {
        balanceMeta.textContent = "";
      }

      balanceHistoryList.innerHTML = "";
      balanceHistoryEmpty.textContent = "";

      const history = data.history || {};
      const entries = Object.entries(history)
        .map(([key, h]) => ({ key, ...h }))
        .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0))
        .slice(0, 15);

      if (entries.length === 0) {
        balanceHistoryEmpty.textContent = "Ende nuk ka levizje në histori.";
      } else {
        entries.forEach(h => {
          const row = document.createElement("div");
          row.className = "balance-row";
          const d = h.timestamp ? new Date(h.timestamp).toLocaleString() : "-";
          const typeText = h.type === "ride" ? "Udhëtim" : "Levizje";
          row.innerHTML = `
            <span>${typeText} (${h.orderId || ""})</span>
            <span>+${(h.amount || 0).toFixed(2)} € · ${d}</span>
          `;
          balanceHistoryList.appendChild(row);
        });
      }
    });
  }
</script>

</body>
</html>
