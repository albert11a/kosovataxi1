<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi · Thirr Taxi</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#020617">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root {
      --bg: #020617;
      --card-bg: #0f172a;
      --accent: #22c55e;
      --accent2: #38bdf8;
      --radius: 20px;
      --text: #e5e7eb;
      --sub: #94a3b8;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: -apple-system, system-ui, sans-serif;
      color: var(--text);
    }

    .app { padding: 14px; max-width: 800px; margin: auto; }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .header-title { font-size: 18px; font-weight: 600; }
    .header-sub { font-size: 12px; color: var(--sub); }

    /* SWITCH */
    .switch {
      width: 40px; height: 20px;
      background: #475569;
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      transition: 0.2s;
    }
    .switch.on { background: var(--accent); }
    .thumb {
      width: 16px; height: 16px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px; left: 2px;
      transition: 0.2s;
    }
    .switch.on .thumb { transform: translateX(20px); }

    /* TABS – bottom iOS style */
    .tabs {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #0f172a;
      display: flex;
      border-top: 1px solid #1e293b;
      padding: 6px 0;
      z-index: 99;
    }
    .tab {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: var(--sub);
      padding: 6px 0;
      cursor: pointer;
    }
    .tab.active { color: var(--accent2); font-weight: 600; }

    /* PANELS */
    .panel { display: none; padding-bottom: 90px; }
    .panel.active { display: block; }

    /* CARD */
    .card {
      background: var(--card-bg);
      padding: 14px;
      border-radius: var(--radius);
      margin-bottom: 10px;
      border: 1px solid #1e293b;
    }

    .title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .sub { color: var(--sub); font-size: 12px; }

    /* ORDER CARD */
    .order-name { font-size: 15px; font-weight: 600; }
    .order-meta { font-size: 12px; color: var(--sub); }

    .btn {
      width: 100%;
      border: none;
      border-radius: 12px;
      padding: 10px;
      font-size: 14px;
      margin-top: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-accept {
      background: var(--accent);
      color: #022c22;
    }

    .btn-secondary {
      background: var(--accent2);
      color: #082f49;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    /* MAP IMAGE */
    .map {
      width: 100%;
      height: 150px;
      border-radius: 12px;
      margin-top: 8px;
      background: #1e293b;
      object-fit: cover;
    }

  </style>
</head>

<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="header-title">Shoferi · Thirr Taxi</div>
      <div class="header-sub" id="driverNameLabel">I paidentifikuar</div>
    </div>

    <div style="text-align:right;">
      <div class="header-sub">Statusi</div>
      <div id="onlineSwitch" class="switch"><div class="thumb"></div></div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login" class="card">
    <div class="title">Hyr si shofer</div>
    <div class="sub">Shkruaj PIN-in që ta ka dhënë administratori.</div>
    <input id="pin" placeholder="PIN" style="width:100%;padding:10px;border-radius:12px;margin-top:10px;background:#1e293b;border:1px solid #334155;color:white;">
    <button id="btnLogin" class="btn btn-secondary">Hyr</button>
    <div id="loginMsg" class="sub" style="color:#f87171;margin-top:6px;"></div>
  </div>

  <!-- PANELS -->
  <div id="p-requests" class="panel active">
    <div class="title">Kërkesat e reja</div>
    <div id="orders"></div>
  </div>

  <div id="p-current" class="panel">
    <div class="title">Udhëtimi aktual</div>
    <div id="currentRide"></div>
  </div>

  <div id="p-balance" class="panel">
    <div class="title">Bilanci</div>
    <div id="balance"></div>
  </div>

</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" data-tab="p-requests">Kërkesat</div>
  <div class="tab" data-tab="p-current">Vozitja</div>
  <div class="tab" data-tab="p-balance">Bilanci</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, runTransaction } 
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* =============== STATE =================== */
  let driver = null;
  let online = false;
  let activeRide = null;

  /* =============== LOGIN =================== */
  document.getElementById("btnLogin").onclick = () => {
    const pin = document.getElementById("pin").value.trim();
    const msg = document.getElementById("loginMsg");
    msg.textContent = "";

    const rf = ref(db, "drivers");
    onValue(rf, snap => {
      const drivers = snap.val() || {};
      for (const [id,d] of Object.entries(drivers)) {
        if (String(d.pin) === pin && d.approved === true) {
          driver = { id, ...d };
          document.getElementById("driverNameLabel").textContent = d.name;
          document.getElementById("login").style.display = "none";
          subscribeOrders();
          subscribeBalance();
          return;
        }
      }
      msg.textContent = "PIN i pasaktë.";
    }, { onlyOnce:true });
  };

  /* =============== ONLINE SWITCH =================== */
  const sw = document.getElementById("onlineSwitch");
  sw.onclick = () => {
    if (!driver) return;
    online = !online;
    sw.classList.toggle("on", online);
    set(ref(db, "drivers/"+driver.id+"/online"), online);
  };

  /* =============== TABS =================== */
  document.querySelectorAll(".tab").forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      const id = tab.dataset.tab;
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };
  });

  /* =============== STATIC MAP GENERATOR =================== */
  function mapURL(lat,lng) {
    return `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=16&size=600x300&maptype=roadmap&markers=color:red|${lat},${lng}&key=YOUR_GOOGLE_MAPS_API_KEY`;
  }

  /* =============== ORDERS =================== */
  function subscribeOrders() {
    const orf = ref(db, "orders");
    onValue(orf, snap => {
      const data = snap.val() || {};
      const list = Object.entries(data)
        .filter(([id,o]) => o.status === "open")
        .sort((a,b) => (b[1].createdAt || 0) - (a[1].createdAt || 0))
        .slice(0, 100); // vetëm 100 më të fundit

      const box = document.getElementById("orders");
      box.innerHTML = "";

      list.forEach(([id,o]) => {
        const c = document.createElement("div");
        c.className = "card";

        c.innerHTML = `
          <div class="order-name">${o.name || "Klienti"} · ${o.phone || ""}</div>
          <div class="order-meta">${o.address || "Pa adresë"}</div>

          ${o.lat && o.lng ? `<img class="map" src="${mapURL(o.lat,o.lng)}">` : ""}

          <button class="btn-accept btn" data-id="${id}">Prano</button>
        `;

        c.querySelector(".btn-accept").onclick = () => {
          if (!online) return alert("Duhet të jeni ONLINE");

          runTransaction(ref(db, "orders/"+id), cur => {
            if (!cur || cur.status !== "open") return cur;
            cur.status = "taken";
            cur.takenByDriverId = driver.id;
            cur.takenByName = driver.name;
            cur.takenAt = Date.now();
            return cur;
          });
        };

        box.appendChild(c);
      });
    });
  }

  /* =============== CURRENT RIDE =================== */
  onValue(ref(db,"orders"), snap => {
    if (!driver) return;
    const data = snap.val() || {};
    activeRide = null;

    for (const [id,o] of Object.entries(data)) {
      if (o.status === "taken" && o.takenByDriverId === driver.id) {
        activeRide = { id, ...o };
      }
    }

    const box = document.getElementById("currentRide");
    box.innerHTML = "";

    if (!activeRide) {
      box.innerHTML = `<div class="sub">Nuk keni udhëtim aktiv.</div>`;
      return;
    }

    const a = activeRide;

    box.innerHTML = `
      <div class="card">
        <div class="order-name">${a.name}</div>
        <div class="order-meta">${a.address}</div>
        ${a.lat && a.lng ? `<img class="map" src="${mapURL(a.lat,a.lng)}">` : ""}
        
        <button id="finishRide" class="btn btn-secondary">Përfundo</button>
        <button id="cancelRide" class="btn btn-danger">Anulo</button>
      </div>
    `;

    document.getElementById("finishRide").onclick = () => {
      runTransaction(ref(db,"orders/"+a.id), cur => {
        if (!cur || cur.status!=="taken") return cur;
        cur.status = "done";
        cur.completedAt = Date.now();
        return cur;
      });
    };

    document.getElementById("cancelRide").onclick = () => {
      const reason = prompt("Arsyeja e anulimit:");
      if (!reason) return;

      runTransaction(ref(db,"orders/"+a.id), cur => {
        if (!cur || cur.status!=="taken") return cur;
        cur.status = "canceled";
        cur.canceledAt = Date.now();
        cur.canceledReason = reason;
        return cur;
      });
    };
  });

  /* =============== BALANCE =================== */
  function subscribeBalance() {
    const rf = ref(db, "balances/" + driver.id);
    onValue(rf, snap => {
      const b = snap.val();
      const box = document.getElementById("balance");

      if (!b) {
        box.innerHTML = `<div class="sub">Nuk ka të dhëna për bilancin.</div>`;
        return;
      }

      box.innerHTML = `
        <div class="card">
          <div class="order-name">Totali: ${Number(b.total||0).toFixed(2)} €</div>
        </div>
      `;
    });
  }

</script>

</body>
</html>
