<!DOCTYPE html>
<html lang="sq" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - Thirr Taxi</title>

  <!-- iOS / Mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js").catch(console.error);
    }
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="" />

  <style>
    /********************************************
     * THEME VARIABLES (Light / Dark)
     ********************************************/
    :root {
      --bg: #020617;
      --bg-elevated: rgba(15,23,42,0.90);
      --bg-soft: rgba(15,23,42,0.85);
      --border-subtle: rgba(148,163,184,0.28);
      --border-strong: rgba(51,65,85,0.9);
      --text-primary: #e5e7eb;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent: #0ea5e9;
      --accent-soft: rgba(56,189,248,0.14);
      --accent-green: #22c55e;
      --shadow-soft: 0 4px 14px rgba(0,0,0,0.35);
      --shadow-chip: 0 2px 6px rgba(15,23,42,0.5);
      --chip-bg: rgba(15,23,42,0.96);
      --tab-bg: rgba(15,23,42,0.98);
      --tab-pill-bg: rgba(15,23,42,1);
    }

    [data-theme="light"] {
      --bg: #f3f4f6;
      --bg-elevated: rgba(255,255,255,0.96);
      --bg-soft: rgba(255,255,255,0.94);
      --border-subtle: rgba(148,163,184,0.35);
      --border-strong: rgba(148,163,184,0.7);
      --text-primary: #020617;
      --text-secondary: #4b5563;
      --text-muted: #9ca3af;
      --accent: #0ea5e9;
      --accent-soft: rgba(14,165,233,0.08);
      --accent-green: #16a34a;
      --shadow-soft: 0 8px 22px rgba(15,23,42,0.20);
      --shadow-chip: 0 4px 10px rgba(148,163,184,0.35);
      --chip-bg: rgba(249,250,251,0.96);
      --tab-bg: rgba(229,231,235,0.98);
      --tab-pill-bg: rgba(255,255,255,1);
    }

    /********************************************
     * GLOBAL LAYOUT
     ********************************************/
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, system-ui, sans-serif;
      color: var(--text-primary);
      background: var(--bg);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 10% 0%, rgba(148,163,184,0.25) 0, transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(96,165,250,0.25) 0, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(15,23,42,0.9) 0, var(--bg) 55%);
      z-index: -1;
      pointer-events: none;
    }

    [data-theme="light"] body::before {
      background:
        radial-gradient(circle at 10% 0%, rgba(191,219,254,0.5) 0, transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(216,180,254,0.4) 0, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(209,213,219,0.9) 0, var(--bg) 55%);
    }

    body {
      padding-top: 12px;
      padding-bottom: 70px;
    }

    .frame {
      max-width: 520px;
      margin: 0 auto;
      padding: 0 15px 0 15px; /* 15px links/rechts */
    }

    /********************************************
     * HEADER
     ********************************************/
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0 14px;
    }

    .header-left {
      font-size: 17px;
      font-weight: 650;
      letter-spacing: 0.02em;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.25);
    }

    .header-status {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--tab-bg);
      border: 1px solid var(--border-subtle);
      cursor: pointer;
      font-size: 11px;
      box-shadow: var(--shadow-chip);
      min-width: 60px;
    }

    .theme-toggle span {
      opacity: .7;
    }

    .theme-toggle .thumb {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    /********************************************
     * TABS (Hauptnavigation)
     ********************************************/
    .tabs {
      display: flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: var(--tab-bg);
      border: 1px solid var(--border-subtle);
      backdrop-filter: blur(18px);
      margin-bottom: 14px;
    }

    .tab-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 8px 0;
      font-size: 13px;
      font-weight: 500;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all .18s ease;
    }

    .tab-btn.active {
      background: var(--tab-pill-bg);
      color: var(--text-primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.20);
    }

    /********************************************
     * CARD BASE
     ********************************************/
    .card {
      background: var(--bg-elevated);
      border-radius: 24px;
      padding: 16px 18px 18px;
      margin-bottom: 18px;
      border: 1px solid var(--border-subtle);
      backdrop-filter: blur(22px);
      box-shadow: var(--shadow-soft);
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .section-sub {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    /********************************************
     * LOGIN
     ********************************************/
    label {
      font-size: 13px;
      margin-top: 4px;
      display: block;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      margin-top: 4px;
      border-radius: 16px;
      background: var(--bg-soft);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      font-size: 15px;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }

    button {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 11px 12px;
      margin-top: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 7px rgba(0,0,0,0.25);
    }

    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color: #022c22;
    }

    .btn-secondary {
      background: linear-gradient(135deg,#0ea5e9,#22c55e);
      color: #022c22;
      font-size: 14px;
    }

    .btn-danger {
      background:#ef4444;
      color:white;
      font-size: 13px;
    }

    .login-error {
      font-size: 12px;
      color: #f97373;
      margin-top: 6px;
    }

    .empty-text {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 6px;
    }

    /********************************************
     * KËRKESAT CARDS
     ********************************************/
    .order-card {
      background: radial-gradient(circle at top left,
        rgba(56,189,248,0.18),
        rgba(15,23,42,0.96));
      border-radius: 20px;
      border: 1px solid var(--border-subtle);
      padding: 12px 12px 14px;
      margin-top: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
      backdrop-filter: blur(18px);
    }

    [data-theme="light"] .order-card {
      background: radial-gradient(circle at top left,
        rgba(56,189,248,0.12),
        rgba(255,255,255,0.98));
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .order-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .order-name {
      font-size: 15px;
      font-weight: 600;
    }

    .order-phone {
      font-size: 13px;
      color: var(--text-primary);
      opacity: .9;
    }

    .order-address {
      font-size: 12px;
      color: #cbd5f5;
    }

    [data-theme="light"] .order-address {
      color: #1f2937;
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .badge-open {
      background: rgba(251,191,36,0.16);
      color: #facc15;
    }

    .badge-active {
      background: rgba(34,197,94,0.16);
      color: #4ade80;
    }

    .mini-map {
      width: 100%;
      height: 140px;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid var(--border-strong);
      background: #020617;
    }

    .info-line {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    /********************************************
     * VOZITJET – INNERE TABS + GROSSE KARTE
     ********************************************/
    .subtabs {
      display: flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: var(--bg-soft);
      border: 1px solid var(--border-subtle);
      margin-bottom: 12px;
    }

    .subtab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 0;
      font-size: 12px;
      font-weight: 500;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .subtab-btn.active {
      background: var(--tab-pill-bg);
      color: var(--text-primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }

    .big-map-card {
      background: var(--bg-soft);
      border-radius: 22px;
      padding: 12px 12px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .big-map-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 10px;
    }

    .big-map-name {
      font-size: 15px;
      font-weight: 600;
    }

    .big-map-phone {
      font-size: 13px;
      color: var(--text-primary);
      opacity: .9;
    }

    .big-map-address {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .big-map-container {
      width: 100%;
      height: 42vh; /* passt sich an Bildschirm an */
      min-height: 220px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border-strong);
      background: #020617;
      margin-bottom: 10px;
    }

    .big-map-footer-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .big-map-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /********************************************
     * BILANCI – PERFORMANCA + HISTORY
     ********************************************/
    .perf-wrapper {
      margin-top: 4px;
      margin-bottom: 10px;
    }

    .perf-chips {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .perf-chip {
      flex: 1;
      padding: 8px 8px;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: var(--chip-bg);
      text-align: center;
      font-size: 11px;
      box-shadow: var(--shadow-chip);
    }

    .perf-chip .label {
      color: var(--text-secondary);
      margin-bottom: 2px;
    }

    .perf-chip .value {
      font-size: 16px;
      font-weight: 600;
    }

    .balance-summary {
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
    }

    .balance-summary strong {
      font-size: 18px;
      font-weight: 650;
    }

    .balance-meta {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 4px;
    }

    .balance-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      padding: 9px 10px;
      border-radius: 14px;
      margin-top: 8px;
      background: var(--bg-soft);
      border: 1px solid var(--border-strong);
    }

    .balance-entry-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .balance-entry-address {
      font-size: 13px;
      font-weight: 500;
    }

    .balance-entry-time {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .balance-entry-amount {
      font-size: 14px;
      font-weight: 600;
      color: #4ade80;
      white-space: nowrap;
      margin-top: 2px;
    }

    .balance-empty {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>

<body>
<div class="frame">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">Thirr Taxi</div>

    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>

    <div class="theme-toggle" id="themeToggle">
      <span>☀︎</span>
      <div class="thumb">◐</div>
      <span>☾</span>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="section-title">Hyr si shofer</div>
    <div class="section-sub">
      Shkruaj vetëm PIN-in që ta ka dhënë administratori. Emri dhe kompania merren automatikisht.
    </div>

    <label>PIN</label>
    <input id="loginPin" inputmode="numeric" placeholder="p.sh. 4829">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" class="login-error"></div>
  </div>

  <!-- CONTENT NACH LOGIN -->
  <div id="content" style="display:none;">

    <!-- STATUS -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div style="font-size:12px;color:var(--text-secondary);">
        Gjendja: <span id="headerStatus">Offline</span>
      </div>
      <div style="font-size:11px;color:var(--text-secondary);">
        Sistemi i shoferëve Thirr Taxi
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-requests">Kërkesat</button>
      <button class="tab-btn" data-tab="tab-active">Vozitjet</button>
      <button class="tab-btn" data-tab="tab-balance">Bilanci</button>
    </div>

    <!-- TAB: KËRKESAT -->
    <div id="tab-requests" class="tab-panel" style="display:block;">
      <div class="card">
        <div class="section-title">Kërkesa të reja</div>
        <div class="section-sub">Këto janë udhëtimet që mund t’i pranosh.</div>

        <div id="orders"></div>
        <div id="noOpen" class="empty-text"></div>
      </div>
    </div>

    <!-- TAB: VOZITJET -->
    <div id="tab-active" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Vozitjet e mia</div>
        <div class="section-sub">Udhëtimi aktual dhe historiku i fundit.</div>

        <!-- Subtabs -->
        <div class="subtabs">
          <button class="subtab-btn active" data-subtab="sub-active">Aktuale</button>
          <button class="subtab-btn" data-subtab="sub-history">Historiku</button>
        </div>

        <!-- Aktuale: 1 große Karte + Buttons -->
        <div id="sub-active" class="subtab-panel" style="display:block;">
          <div id="activeRideContainer" class="big-map-card" style="display:none;">
            <div class="big-map-header">
              <div class="big-map-name" id="activeName">Klienti</div>
              <div class="big-map-phone" id="activePhone"></div>
              <div class="big-map-address" id="activeAddress"></div>
            </div>

            <div id="activeMap" class="big-map-container"></div>

            <div class="big-map-footer-text" id="activeInfo"></div>

            <div class="big-map-actions">
              <button id="finishActiveBtn" class="btn-secondary">✅ Përfundo udhëtimin</button>
              <button id="cancelActiveBtn" class="btn-danger">✖ Anulo udhëtimin</button>
            </div>
          </div>

          <div id="noActiveRide" class="empty-text">Për momentin nuk ke vozitje aktive.</div>
        </div>

        <!-- Historiku: Liste der letzten eigenen Fahrten (fertige) -->
        <div id="sub-history" class="subtab-panel" style="display:none;">
          <div id="myOrdersHistory"></div>
          <div id="noHistory" class="empty-text"></div>
        </div>
      </div>
    </div>

    <!-- TAB: BILANCI + PERFORMANCA -->
    <div id="tab-balance" class="tab-panel" style="display:none;">
      <div class="card">
        <div class="section-title">Performanca ime & bilanci</div>
        <div class="section-sub">Statistikat e udhëtimeve dhe bilanci i kompanisë.</div>

        <!-- Performanca ime – nur hier -->
        <div class="perf-wrapper">
          <div class="perf-chips">
            <div class="perf-chip">
              <div class="label">Sot</div>
              <div class="value" id="perfToday">0</div>
            </div>
            <div class="perf-chip">
              <div class="label">Java</div>
              <div class="value" id="perfWeek">0</div>
            </div>
            <div class="perf-chip">
              <div class="label">Muaji</div>
              <div class="value" id="perfMonth">0</div>
            </div>
          </div>
        </div>

        <!-- Bilanci -->
        <div id="balanceSummary" class="balance-summary"></div>
        <div id="balanceMeta" class="balance-meta"></div>

        <!-- History -->
        <div id="balanceHistoryList"></div>
        <div id="balanceHistoryEmpty" class="balance-empty"></div>
      </div>
    </div>

  </div><!-- /content -->

</div><!-- /frame -->

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<!-- APP LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    measurementId: "G-QYQE2476PR",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const LS_KEY = "thirrTaxiDriverId";

  let currentDriver = null;
  let hasActiveRide = false;
  const stats = { day: 0, week: 0, month: 0 };
  const maps = {};
  let geoWatchId = null;

  // DOM
  const rootEl = document.documentElement;
  const themeToggle = document.getElementById("themeToggle");

  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");

  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  const ordersBox = document.getElementById("orders");
  const myOrdersHistoryBox = document.getElementById("myOrdersHistory");
  const noOpen = document.getElementById("noOpen");
  const noMine = document.getElementById("noActiveRide");
  const noHistory = document.getElementById("noHistory");

  const balanceSummary = document.getElementById("balanceSummary");
  const balanceMeta = document.getElementById("balanceMeta");
  const balanceHistoryList = document.getElementById("balanceHistoryList");
  const balanceHistoryEmpty = document.getElementById("balanceHistoryEmpty");

  const perfToday = document.getElementById("perfToday");
  const perfWeek = document.getElementById("perfWeek");
  const perfMonth = document.getElementById("perfMonth");

  const activeRideContainer = document.getElementById("activeRideContainer");
  const activeName = document.getElementById("activeName");
  const activePhone = document.getElementById("activePhone");
  const activeAddress = document.getElementById("activeAddress");
  const activeInfo = document.getElementById("activeInfo");
  const finishActiveBtn = document.getElementById("finishActiveBtn");
  const cancelActiveBtn = document.getElementById("cancelActiveBtn");

  let activeOrderId = null;

  /************ THEME: auto + toggle ************/
  function applyTheme(theme) {
    rootEl.setAttribute("data-theme", theme);
  }

  (function initTheme() {
    const stored = localStorage.getItem("tt_theme");
    if (stored === "light" || stored === "dark") {
      applyTheme(stored);
      return;
    }
    const hour = new Date().getHours();
    const autoTheme = (hour >= 7 && hour < 20) ? "light" : "dark";
    applyTheme(autoTheme);
  })();

  themeToggle.addEventListener("click", () => {
    const current = rootEl.getAttribute("data-theme") === "dark" ? "light" : "dark";
    applyTheme(current);
    localStorage.setItem("tt_theme", current);
  });

  /************ HELPERS ************/
  function cleanAddress(a) {
    if (!a) return "";
    const lower = a.toLowerCase();
    if (lower.includes("nuk") && lower.includes("përcaktuar")) return "";
    return a.trim();
  }

  // Holt Adresse aus typischen Feldern – wichtigste zuerst:
  function extractAddress(o) {
    const candidates = [
      o.addressStreet,    // DEIN ursprüngliches Feld
      o.address,          // oft genutzt
      o.addressFull,      // gespeicherte Volladresse
      o.locationAddress,
      o.street,
      o.streetName,
      o.road,
      o.route,
      o.formattedAddress,
      o.fullAddress
    ];
    for (const c of candidates) {
      if (typeof c === "string" && c.trim()) return c.trim();
    }
    return "";
  }

  function shortenAddress(address, maxLen = 32) {
    if (!address) return "";
    const t = address.trim();
    if (t.length <= maxLen) return t;
    return t.substring(0, maxLen) + "... +";
  }

  function formatMinutesSince(ts) {
    if (!ts) return "-";
    const diffMs = Date.now() - ts;
    const mins = Math.floor(diffMs / 60000);
    if (mins <= 0) return "më pak se 1 min";
    if (mins === 1) return "1 minutë";
    return mins + " minuta";
  }

  function startOfDay(d) {
    const n = new Date(d); n.setHours(0,0,0,0); return n;
  }
  function startOfWeek(d) {
    const n = startOfDay(d);
    const day = n.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    n.setDate(n.getDate() + diff);
    return n;
  }
  function startOfMonth(d) {
    const n = startOfDay(d);
    return new Date(n.getFullYear(), n.getMonth(), 1);
  }

  function createOrUpdateMap(id, lat, lng) {
    const el = document.getElementById(id);
    if (!el) return;

    if (!maps[id]) {
      const map = L.map(id, { zoomControl: false, attributionControl: false })
        .setView([lat, lng], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);
      L.marker([lat, lng]).addTo(map);
      maps[id] = map;
    } else {
      maps[id].setView([lat, lng], 16);
    }

    setTimeout(() => {
      try { maps[id].invalidateSize(); } catch(e) {}
    }, 240);
  }

  function invalidateAllMaps() {
    setTimeout(() => {
      Object.values(maps).forEach(m => {
        try { m.invalidateSize(); } catch(e) {}
      });
    }, 260);
  }

  function recalcStats(allOrders) {
    stats.day = 0;
    stats.week = 0;
    stats.month = 0;
    if (!currentDriver) return;

    const now = new Date();
    const dDay = startOfDay(now);
    const dWeek = startOfWeek(now);
    const dMonth = startOfMonth(now);

    Object.values(allOrders).forEach(o => {
      if (o.takenByDriverId !== currentDriver.id || o.status !== "done") return;
      const t = o.completedAt || o.takenAt || o.createdAt;
      if (!t) return;
      const dt = new Date(t);
      if (dt >= dDay) stats.day++;
      if (dt >= dWeek) stats.week++;
      if (dt >= dMonth) stats.month++;
    });

    perfToday.textContent = stats.day || 0;
    perfWeek.textContent = stats.week || 0;
    perfMonth.textContent = stats.month || 0;
  }

  function startLocationTracking() {
    if (!navigator.geolocation || !currentDriver) return;
    if (geoWatchId !== null) return;
    geoWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const locRef = ref(db, "driverLocations/" + currentDriver.id);
        runTransaction(locRef, () => ({
          lat,
          lng,
          updatedAt: Date.now()
        }));
      },
      (err) => {
        console.warn("Geolocation error:", err);
      },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
    );
  }

  /************ TABS ************/
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      tabPanels.forEach(p => p.style.display = (p.id === target ? "block" : "none"));
      invalidateAllMaps();
    });
  });

  // Subtabs in Vozitjet
  const subtabButtons = document.querySelectorAll(".subtab-btn");
  const subtabPanels = document.querySelectorAll(".subtab-panel");
  subtabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.subtab;
      subtabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      subtabPanels.forEach(p => p.style.display = (p.id === target ? "block" : "none"));
      invalidateAllMaps();
    });
  });

  /************ LOGIN / AUTO-LOGIN ************/
  function afterLoginSetup() {
    if (!currentDriver) return;
    if (window.__driverInitialized) return;
    window.__driverInitialized = true;

    headerDriverName.textContent = currentDriver.name || "Shoferi";
    headerStatus.textContent = "Online";

    loginCard.style.display = "none";
    content.style.display = "block";

    subscribeOrders();
    subscribeBalance();
    startLocationTracking();
  }

  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();
    if (!pin) {
      loginMsg.textContent = "Ju lutem shkruani PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");
    onValue(driversRef, (snap) => {
      const data = snap.val() || {};
      let found = null;
      Object.entries(data).forEach(([id, d]) => {
        if (String(d.pin) === String(pin) && d.approved === true && (d.active !== false)) {
          found = { id, ...d };
        }
      });

      if (!found) {
        loginMsg.textContent = "PIN i pavlefshëm ose shoferi nuk është aktiv.";
        return;
      }

      currentDriver = found;
      localStorage.setItem(LS_KEY, currentDriver.id);
      afterLoginSetup();
    }, { onlyOnce: true });
  };

  const savedId = localStorage.getItem(LS_KEY);
  if (savedId) {
    const drvRef = ref(db, "drivers/" + savedId);
    onValue(drvRef, (snap) => {
      const d = snap.val();
      if (d && d.approved === true && (d.active !== false)) {
        currentDriver = { id: savedId, ...d };
        afterLoginSetup();
      } else {
        localStorage.removeItem(LS_KEY);
      }
    }, { onlyOnce: true });
  }

  /************ ORDERS ************/
  function subscribeOrders() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, (snap) => {
      const data = snap.val() || {};

      ordersBox.innerHTML = "";
      myOrdersHistoryBox.innerHTML = "";
      let openCount = 0;
      let historyCount = 0;
      hasActiveRide = false;
      activeOrderId = null;

      recalcStats(data);

      // Reset Active UI
      activeRideContainer.style.display = "none";
      noMine.textContent = "Për momentin nuk ke vozitje aktive.";

      Object.entries(data).forEach(([id, o]) => {
        const safeIdOpen = "map_open_" + id.replace(/[^a-zA-Z0-9_-]/g, "");
        const safeIdActive = "map_active_" + id.replace(/[^a-zA-Z0-9_-]/g, "");

        const rawAdr = extractAddress(o);
        const addressFull = cleanAddress(rawAdr);
        const addressShort = shortenAddress(addressFull);

        /* KËRKESAT (OPEN) */
        if (o.status === "open") {
          openCount++;
          const wrapper = document.createElement("div");
          wrapper.className = "order-card";

          wrapper.innerHTML = `
            <div class="order-header">
              <div class="order-main">
                <div class="order-name">${o.name || "Klienti"}</div>
                <div class="order-phone">${o.phone || ""}</div>
                ${addressShort ? `<div class="order-address">${addressShort}</div>` : ""}
              </div>
              <span class="badge badge-open">Kërkesë</span>
            </div>
            <div id="${safeIdOpen}" class="mini-map"></div>
            <button class="btn-secondary">✅ Prano udhëtimin</button>
          `;

          const acceptBtn = wrapper.querySelector("button");
          acceptBtn.onclick = () => {
            if (hasActiveRide) {
              alert("Nuk mund të pranosh më shumë se një udhëtim në të njëjtën kohë.");
              return;
            }
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "open") return current;
              current.status = "taken";
              current.takenByName = currentDriver.name;
              current.takenByDriverId = currentDriver.id;
              current.takenByCompany = currentDriver.company || "Thirr Taxi";
              current.takenAt = Date.now();
              current.addressFull = addressFull || extractAddress(current);
              return current;
            }).then(() => {
              const activeBtn = document.querySelector('.tab-btn[data-tab="tab-active"]');
              if (activeBtn) activeBtn.click();
            });
          };

          ordersBox.appendChild(wrapper);

          if (typeof o.lat === "number" && typeof o.lng === "number") {
            setTimeout(() => createOrUpdateMap(safeIdOpen, o.lat, o.lng), 120);
          }
        }

        /* AKTIV (TAKEN BY ME) */
        if (o.status === "taken" && o.takenByDriverId === currentDriver?.id) {
          hasActiveRide = true;
          activeOrderId = id;

          activeRideContainer.style.display = "block";
          noMine.textContent = "";

          activeName.textContent = o.name || "Klienti";
          activePhone.textContent = o.phone || "";
          activeAddress.textContent = addressShort || "Pa adresë";

          const timeText = formatMinutesSince(o.takenAt);
          activeInfo.textContent = "Udhëtimi është pranuar: " + timeText + " më parë";

          if (typeof o.lat === "number" && typeof o.lng === "number") {
            setTimeout(() => createOrUpdateMap("activeMap", o.lat, o.lng), 120);
          }

          finishActiveBtn.onclick = () => {
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "done";
              current.completedAt = Date.now();
              current.addressFull = current.addressFull || addressFull || extractAddress(current);
              return current;
            }).then(() => {
              const balRef = ref(db, "balances/" + currentDriver.id);
              runTransaction(balRef, (cur) => {
                const ts = Date.now();
                const fullAdr = cleanAddress(extractAddress(o)) || addressFull;
                const entry = {
                  amount: 0.25,
                  orderId: id,
                  timestamp: ts,
                  type: "ride",
                  address: fullAdr
                };
                if (!cur) {
                  return {
                    total: 0.25,
                    status: "open",
                    lastUpdate: ts,
                    history: { [id]: entry }
                  };
                }
                cur.total = (cur.total || 0) + 0.25;
                cur.status = "open";
                cur.lastUpdate = ts;
                if (!cur.history) cur.history = {};
                cur.history[id] = entry;
                return cur;
              });
            });
          };

          cancelActiveBtn.onclick = () => {
            const reason = prompt("Shkruaj arsyen e anulimit:");
            if (!reason) return;
            const thisOrder = ref(db, "orders/" + id);
            runTransaction(thisOrder, (current) => {
              if (!current || current.status !== "taken") return current;
              current.status = "canceled";
              current.canceledAt = Date.now();
              current.canceledReason = reason;
              return current;
            });
          };
        }

        /* HISTORY (DONE BY ME) – für sub-history */
        if (o.status === "done" && o.takenByDriverId === currentDriver?.id) {
          historyCount++;
          const histAdr = shortenAddress(cleanAddress(extractAddress(o)) || o.addressFull || addressFull);
          const row = document.createElement("div");
          row.className = "balance-row"; // gleiche Optik

          const d = o.completedAt ? new Date(o.completedAt).toLocaleString() : "-";

          row.innerHTML = `
            <div class="balance-entry-main">
              <div class="balance-entry-address">${histAdr || "Pa adresë"}</div>
              <div class="balance-entry-time">${d}</div>
            </div>
            <div class="balance-entry-amount">+0.25 €</div>
          `;
          myOrdersHistoryBox.appendChild(row);
        }
      });

      noOpen.textContent =
        openCount === 0 ? "Për momentin nuk ka kërkesa të reja." : "";

      if (!hasActiveRide) {
        activeRideContainer.style.display = "none";
        noMine.textContent = "Për momentin nuk ke vozitje aktive.";
      }

      noHistory.textContent =
        historyCount === 0 ? "Ende nuk ka historik të përfunduar." : "";

      invalidateAllMaps();
    });
  }

  /************ BILANCI ************/
  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);
    onValue(balRef, (snap) => {
      const data = snap.val();
      if (!data) {
        balanceSummary.textContent = "Nuk ka ende asnjë bilanc.";
        balanceMeta.textContent = "";
        balanceHistoryList.innerHTML = "";
        balanceHistoryEmpty.textContent = "Ende nuk ka lëvizje në histori.";
        return;
      }

      const total = data.total || 0;
      const statusOpen = data.status !== "closed";

      balanceSummary.innerHTML = statusOpen
        ? `<strong>${total.toFixed(2)} €</strong> bilanc i hapur`
        : `<strong>${total.toFixed(2)} €</strong> bilanc i mbyllur ✔`;

      if (data.lastUpdate) {
        balanceMeta.textContent = "Përditësimi i fundit: " + new Date(data.lastUpdate).toLocaleString();
      } else {
        balanceMeta.textContent = "";
      }

      balanceHistoryList.innerHTML = "";
      balanceHistoryEmpty.textContent = "";

      const history = data.history || {};
      const entries = Object.entries(history)
        .map(([key, h]) => ({ key, ...h }))
        .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0))
        .slice(0, 25);

      if (entries.length === 0) {
        balanceHistoryEmpty.textContent = "Ende nuk ka lëvizje në histori.";
      } else {
        entries.forEach(h => {
          const row = document.createElement("div");
          row.className = "balance-row";
          const d = h.timestamp ? new Date(h.timestamp).toLocaleString() : "-";
          const addrShort = shortenAddress(h.address || "");

          row.innerHTML = `
            <div class="balance-entry-main">
              <div class="balance-entry-address">${addrShort || "Pa adresë"}</div>
              <div class="balance-entry-time">${d}</div>
            </div>
            <div class="balance-entry-amount">+${(h.amount || 0).toFixed(2)} €</div>
          `;
          balanceHistoryList.appendChild(row);
        });
      }
    });
  }
</script>

</body>
</html>
