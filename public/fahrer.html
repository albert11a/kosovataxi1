<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Shoferi - KosovaTaxi</title>

  <!-- iOS FULLSCREEN FIX -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#020617">

  <!-- PWA -->
  <link rel="manifest" href="/manifest-shofer.json">
  <link rel="apple-touch-icon" href="/icon-shofer-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw-shofer.js").catch(console.error);
    }
  </script>

  <style>
    /* -------------------------
       iOS + White scroll FIX
    ------------------------- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
      overscroll-behavior-y: none;
      background-color: #020617 !important;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617);
    }

    /* -------------------------
       GLOBAL STYLING 
    ------------------------- */
    :root {
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.9);
      --radius: 22px;
      --accent: #38bdf8;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 16px 14px 40px;
      color: #e5e7eb;
    }

    .frame {
      max-width: 480px;
      margin: 0 auto;
    }

    /* -------------------------
       HEADER
    ------------------------- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
    }
    .header .title {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }
    .header-center {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.25);
    }

    /* -------------------------
       CARDS
    ------------------------- */
    .card {
      background: var(--card-bg);
      padding: 18px;
      margin-bottom: 18px;
      border-radius: var(--radius);
      border: 1px solid rgba(148,163,184,0.22);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .section-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    /* -------------------------
       STATISTIC CARDS
    ------------------------- */
    .stats-container {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      flex: 1;
      background: rgba(20,30,55,0.85);
      padding: 12px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(148,163,184,0.18);
    }
    .stat-value {
      font-size: 20px;
      font-weight: 700;
    }
    .stat-label {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Statistics tabs */
    .tabs {
      display: flex;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,184,0.22);
    }
    .tab-btn {
      flex: 1;
      padding: 8px 0;
      text-align: center;
      font-size: 13px;
      background: rgba(20,30,55,0.7);
      cursor: pointer;
    }
    .tab-btn.active {
      background: rgba(56,189,248,0.22);
      color: #38bdf8;
      font-weight: 600;
    }

    /* -------------------------
       ORDER CARDS
    ------------------------- */
    .order-card {
      background: rgba(25,35,55,0.9);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid rgba(148,163,184,0.22);
      box-shadow: 0 14px 35px rgba(0,0,0,0.8);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-active { background: rgba(34,197,94,0.25); color: #bbf7d0; }
    .badge-open { background: rgba(250,204,21,0.25); color: #facc15; }

    .mini-map {
      height: 150px;
      border-radius: 14px;
      margin-top: 8px;
      overflow: hidden;
      border: 1px solid rgba(50,60,80,0.7);
    }

    .order-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #9ca3af;
    }

    button {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#4ade80);
      color: #022c22;
    }
    .btn-secondary {
      background: linear-gradient(135deg,#facc15,#f97316);
      color: #111827;
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    /* -------------------------
       MODAL
    ------------------------- */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      background: #0f172a;
      padding: 20px;
      width: 90%;
      max-width: 380px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.22);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }

    .modal textarea {
      width: 100%;
      height: 90px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(10,15,28,0.95);
      color: #e5e7eb;
      outline: none;
      resize: none;
      margin-top: 12px;
    }
  </style>
</head>

<body>

<div class="frame">

  <!-- HEADER -->
  <div class="header">
    <div class="title">KosovaTaxi</div>

    <div class="header-center">
      <div class="dot"></div>
      <span id="headerDriverName">Shoferi</span>
    </div>

    <span id="headerStatus">Offline</span>
  </div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="section-title">Hyr si shofer</div>
    <div class="section-sub">Shkruaj vetëm PIN-in e kompanisë.</div>

    <input id="loginPin" placeholder="PIN">

    <button id="loginBtn" class="btn-primary">Hyr online</button>
    <div id="loginMsg" style="color:#f97373;font-size:13px;margin-top:8px;"></div>
  </div>


  <!-- CONTENT -->
  <div id="content" style="display:none;">

    <!-- STATISTICS -->
    <div class="card">
      <div class="tabs">
        <div class="tab-btn active" data-tab="sot">Sot</div>
        <div class="tab-btn" data-tab="java">Java</div>
        <div class="tab-btn" data-tab="muaji">Muaji</div>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div id="statCount" class="stat-value">0</div>
          <div class="stat-label">Vozitje</div>
        </div>

        <div class="stat-card">
          <div id="statMoney" class="stat-value">0.00€</div>
          <div class="stat-label">Fitimi</div>
        </div>

        <div class="stat-card">
          <div id="statTime" class="stat-value">0</div>
          <div class="stat-label">Minuta</div>
        </div>
      </div>
    </div>


    <!-- ACTIVE RIDES -->
    <div class="card">
      <div class="section-title">Vozitjet e mia aktive</div>
      <div class="section-sub">Vetëm një vozitje mund të jetë aktive.</div>

      <div id="myOrders"></div>
      <div id="noMine" class="empty-text"></div>
    </div>

    <!-- OPEN RIDES -->
    <div class="card">
      <div class="section-title">Vozitje në pritje</div>
      <div class="section-sub">Kliko për ta pranuar një vozitje.</div>

      <div id="orders"></div>
      <div id="noOpen" class="empty-text"></div>
    </div>

    <!-- BALANCE -->
    <div class="card">
      <div class="section-title">Barazimi im</div>
      <div id="balanceBox" style="font-size:14px;"></div>
    </div>

  </div>
</div>


<!-- MODAL for Cancel -->
<div class="modal-bg" id="cancelModal">
  <div class="modal">
    <div style="font-size:16px;font-weight:600;">Arsyeja e anulimit</div>
    <textarea id="cancelReason" placeholder="Shkruaj arsye..."></textarea>

    <button id="confirmCancelBtn" class="btn-danger">Anulo vozitjen</button>
    <button id="closeModalBtn" class="btn-secondary" style="margin-top:8px;">Mbyll</button>
  </div>
</div>


<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<!-- FIREBASE + LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgCxp8M9XGOKFSIfaU9nM48rxtFQP-Kvs",
    authDomain: "kosovataxi-f6ca3.firebaseapp.com",
    projectId: "kosovataxi-f6ca3",
    storageBucket: "kosovataxi-f6ca3.firebasestorage.app",
    messagingSenderId: "1075646412122",
    appId: "1:1075646412122:web:7aab19b92f51844fe32f63",
    databaseURL: "https://kosovataxi-f6ca3-default-rtdb.europe-west1.firebasedatabase.app/"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getDatabase(appFB);

  /* ============================================================
     VARIABLES
  ============================================================ */
  let currentDriver = null;
  let currentCancelOrderId = null;
  let hasActiveRide = false;

  const loginCard = document.getElementById("loginCard");
  const content = document.getElementById("content");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const headerDriverName = document.getElementById("headerDriverName");
  const headerStatus = document.getElementById("headerStatus");
  const balanceBox = document.getElementById("balanceBox");

  /* ============================================================
     LOGIN
  ============================================================ */
  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    const pin = document.getElementById("loginPin").value.trim();

    if (!pin) {
      loginMsg.textContent = "Shkruaj PIN-in.";
      return;
    }

    const driversRef = ref(db, "drivers");

    onValue(driversRef, (snap) => {
      let found = null;
      const drivers = snap.val() || {};

      Object.entries(drivers).forEach(([id, d]) => {
        if (String(d.pin) === pin && d.approved === true) {
          found = { id, ...d };
        }
      });

      if (!found) {
        loginMsg.textContent = "PIN i gabuar.";
        return;
      }

      currentDriver = found;
      headerDriverName.textContent = found.name;
      headerStatus.textContent = "Online";

      loginCard.style.display = "none";
      content.style.display = "block";

      subscribeOrders();
      subscribeBalance();
      updateStatistics();
    }, { onlyOnce: true });
  };


  /* ============================================================
     MINI MAPS
  ============================================================ */
  function createMiniMap(id, lat, lng) {
    const container = document.getElementById(id);
    if (!container) return;
    container.innerHTML = "";

    const map = L.map(id, { zoomControl: false, attributionControl: false })
      .setView([lat, lng], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    L.marker([lat, lng]).addTo(map);
  }


  /* ============================================================
     STATISTICS
  ============================================================ */
  function updateStatistics() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, (snap) => {
      const data = snap.val() || [];

      let count = 0;
      let money = 0;
      let minutes = 0;

      Object.values(data).forEach(o => {
        if (o.takenByDriverId === currentDriver?.id && o.status === "done") {
          count++;
          money += 0.25;
          minutes += 6; // Example fixed time
        }
      });

      document.getElementById("statCount").textContent = count;
      document.getElementById("statMoney").textContent = money.toFixed(2) + "€";
      document.getElementById("statTime").textContent = minutes;
    });
  }


  /* ============================================================
     LOAD ORDERS
  ============================================================ */
  function subscribeOrders() {
    const ordersRef = ref(db, "orders");

    onValue(ordersRef, snap => {
      const data = snap.val() || {};

      const openBox = document.getElementById("orders");
      const mineBox = document.getElementById("myOrders");
      const noOpen = document.getElementById("noOpen");
      const noMine = document.getElementById("noMine");

      openBox.innerHTML = "";
      mineBox.innerHTML = "";

      let openCount = 0;
      let mineCount = 0;

      Object.entries(data).forEach(([id, o]) => {
        const mapIdOpen = "map_" + id + "_open";
        const mapIdMine = "map_" + id + "_mine";

        /* OPEN RIDES */
        if (o.status === "open") {
          openCount++;

          const card = document.createElement("div");
          card.className = "order-card";

          card.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-name">${o.name}</div>
                <div class="order-phone">${o.phone}</div>
              </div>
              <span class="badge badge-open">Në pritje</span>
            </div>

            <div id="${mapIdOpen}" class="mini-map"></div>

            <div class="order-footer">
              <span>Prano këtë vozitje</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
            </div>
          `;

          const btn = document.createElement("button");
          btn.className = "btn-secondary";
          btn.textContent = "Prano vozitjen";

          btn.onclick = () => {
            if (hasActiveRide) {
              alert("Ke një vozitje aktive!");
              return;
            }

            const refOrder = ref(db, "orders/" + id);
            runTransaction(refOrder, cur => {
              if (cur && cur.status === "open") {
                cur.status = "taken";
                cur.takenByDriverId = currentDriver.id;
                cur.takenByName = currentDriver.name;
                cur.takenByCompany = currentDriver.company;
                cur.takenAt = Date.now();
              }
              return cur;
            });
          };

          card.appendChild(btn);
          openBox.appendChild(card);

          setTimeout(() => createMiniMap(mapIdOpen, o.lat, o.lng), 40);
        }

        /* MY ACTIVE RIDES */
        if (o.status === "taken" && o.takenByDriverId === currentDriver?.id) {
          mineCount++;
          hasActiveRide = true;

          const card = document.createElement("div");
          card.className = "order-card";

          const minutes = Math.floor((Date.now() - o.takenAt) / 60000);

          card.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-name">${o.name}</div>
                <div class="order-phone">${o.phone}</div>
              </div>
              <span class="badge badge-active">Aktive</span>
            </div>

            <div id="${mapIdMine}" class="mini-map"></div>

            <div class="order-footer">
              <span>${minutes} min më parë</span>
              <a href="https://maps.google.com/?q=${o.lat},${o.lng}" target="_blank">Google Maps</a>
            </div>
          `;

          /* Finish */
          const finishBtn = document.createElement("button");
          finishBtn.className = "btn-primary";
          finishBtn.textContent = "Perfundo vozitjen";

          finishBtn.onclick = () => {
            const refOrder = ref(db, "orders/" + id);

            runTransaction(refOrder, cur => {
              if (cur && cur.status === "taken") {
                cur.status = "done";
                cur.completedAt = Date.now();
              }
              return cur;
            });

            /* Balance update */
            const bal = ref(db, "balances/" + currentDriver.id);
            runTransaction(bal, cur => {
              if (!cur) cur = { total: 0, status: "open" };
              cur.total += 0.25;
              cur.status = "open";
              return cur;
            });
          };

          /* Cancel */
          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn-danger";
          cancelBtn.textContent = "Anulo vozitjen";
          cancelBtn.onclick = () => {
            currentCancelOrderId = id;
            document.getElementById("cancelModal").style.display = "flex";
          };

          card.appendChild(finishBtn);
          card.appendChild(cancelBtn);
          mineBox.appendChild(card);

          setTimeout(() => createMiniMap(mapIdMine, o.lat, o.lng), 40);
        }
      });

      noOpen.textContent = openCount === 0 ? "Nuk ka vozitje në pritje." : "";
      noMine.textContent = mineCount === 0 ? "S'ke vozitje aktive." : "";
    });
  }


  /* ============================================================
     BALANCE
  ============================================================ */
  function subscribeBalance() {
    const balRef = ref(db, "balances/" + currentDriver.id);

    onValue(balRef, snap => {
      const d = snap.val();
      if (!d) {
        balanceBox.innerHTML = "Nuk ke barazim ende.";
        return;
      }

      balanceBox.innerHTML = `
        <div><strong>Borxhi aktual:</strong> ${d.total.toFixed(2)} €</div>
        <div><strong>Statusi:</strong> ${d.status === "open" ? "I hapur" : "I mbyllur"}</div>
        <div><strong>Ndryshimi i fundit:</strong> ${new Date(d.lastUpdate).toLocaleString()}</div>
      `;
    });
  }


  /* ============================================================
     MODAL BUTTONS
  ============================================================ */
  document.getElementById("closeModalBtn").onclick = () => {
    document.getElementById("cancelModal").style.display = "none";
  };

  document.getElementById("confirmCancelBtn").onclick = () => {
    const reason = document.getElementById("cancelReason").value.trim();
    if (!reason) {
      alert("Shkruaj arsyen!");
      return;
    }

    const refOrder = ref(db, "orders/" + currentCancelOrderId);
    runTransaction(refOrder, cur => {
      if (cur && cur.status === "taken") {
        cur.status = "canceled";
        cur.canceledAt = Date.now();
        cur.canceledReason = reason;
      }
      return cur;
    });

    document.getElementById("cancelModal").style.display = "none";
    document.getElementById("cancelReason").value = "";
  };

</script>

</body>
</html>
